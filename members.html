<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Členská sekce - Šachový oddíl TJ Bižuterie Jablonec</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Open+Sans:wght@400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/member.css">
    <link rel="icon" type="image/png" href="images/favicon.png">
</head>

<body>
    <header id="global-header"></header>

    <main class="page-content" style="padding: 90px 0 40px; min-height: 80vh;">
        <section class="member-section">
            <div class="container">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h1 class="gradient-text">Členská sekce</h1>
                </div>

                <!-- Login View -->
                <div id="loginView" class="auth-container">
                    <div class="lock-icon"><i class="fa-solid fa-lock"></i></div>
                    <h2>Vstup pro členy</h2>
                    <p class="subtitle">Přihlaste se svým účtem</p>
                    <button class="btn-primary" onclick="initGoogleLogin()"
                        style="width: 100%; margin-top: 1rem; background: #fff; color: #333; border: none; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                        <i class="fa-brands fa-google" style="color: #4285F4;"></i> Přihlásit se přes Google
                    </button>
                    <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 1.5rem;">Přístup pouze pro členy
                        klubu.</p>
                </div>

                <!-- Hub View -->
                <div id="hubView" class="member-hub hidden">
                    <div class="dashboard-layout" style="display: flex; flex-direction: column; gap: 2rem;">
                        <!-- Infobox / Welcome -->
                        <div class="dashboard-info-card"
                            style="background: rgba(255,255,255,0.03); padding: 1.5rem; border-radius: 1rem; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <h2 id="welcomeMsg" style="margin: 0; font-size: 1.8rem; color: var(--text-main);">
                                    Vítejte</h2>
                                <p id="roleInfo"
                                    style="color: var(--text-muted); margin: 0.5rem 0 0 0; font-size: 0.95rem;">
                                    <i class="fa-solid fa-user-tag"></i> Role: <span
                                        id="userRoleBadge">Načítám...</span>
                                </p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.9rem; color: var(--text-muted);">Dnes je</div>
                                <div id="currentDate" style="font-size: 1.2rem; font-weight: 600;"></div>
                            </div>
                        </div>

                        <!-- Quick Links Grid (moved above info box for above-fold visibility) -->
                        <div class="hub-grid">
                            <a href="member-bulletin.html" class="hub-tile tile-puzzle">
                                <i class="fa-solid fa-clipboard-list"></i>
                                <span>Nástěnka</span>
                            </a>
                            <a href="/partie" class="hub-tile tile-games">
                                <i class="fa-solid fa-chess"></i>
                                <span>Partie</span>
                            </a>
                            <a href="puzzle-racer.html" class="hub-tile tile-racer">
                                <i class="fa-solid fa-flag-checkered"></i>
                                <span>Puzzle Racer</span>
                            </a>
                            <a href="member-gallery.html" class="hub-tile tile-gallery">
                                <i class="fa-solid fa-images"></i>
                                <span>Galerie</span>
                            </a>
                            <a href="chess-database.html" class="hub-tile tile-database">
                                <i class="fa-solid fa-database"></i>
                                <span>Databáze</span>
                            </a>
                            <a href="member-wishlist.html" class="hub-tile tile-wishlist">
                                <i class="fa-solid fa-wand-magic-sparkles"></i>
                                <span>Kniha Přání</span>
                            </a>
                        </div>

                        <!-- January Access Info (moved below grid) -->
                        <div
                            style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); padding: 1rem; border-radius: 0.5rem; display: flex; align-items: start; gap: 1rem;">
                            <i class="fa-solid fa-info-circle"
                                style="color: #60a5fa; font-size: 1.2rem; margin-top: 0.2rem;"></i>
                            <div>
                                <strong style="color: #60a5fa; display: block; margin-bottom: 0.3rem;">Testovací
                                    provoz</strong>
                                <span style="color: #e5e7eb;">V průběhu ledna 2026 je členská sekce přístupná všem
                                    uživatelům pro účely testování.</span>
                            </div>
                        </div>

                        <!-- What's New (Announcements Preview) -->
                        <div class="dashboard-news-section">
                            <h3
                                style="color: var(--text-main); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 0.5rem; margin-bottom: 1rem;">
                                <i class="fa-solid fa-bullhorn" style="color: #fcd34d;"></i> Co je nového
                            </h3>
                            <div id="dashboardNewsList" style="display: grid; gap: 1rem;">
                                <p style="color: var(--text-muted);"><i class="fa-solid fa-spinner fa-spin"></i>
                                    Načítám novinky...</p>
                            </div>
                            <div style="text-align: center; margin-top: 1rem;">
                                <a href="member-bulletin.html" class="btn-secondary"
                                    style="text-decoration: none; font-size: 0.9rem;">Zobrazit všechna oznámení</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer id="global-footer"></footer>

    <script src="js/config.js"></script>
    <script src="js/layout-loader.js"></script>
    <script src="js/member-auth.js"></script>
    <script>
        function initGoogleLogin() {
            window.location.href = `${API_URL}/auth/google`;
        }

        function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            if (token) {
                localStorage.setItem('auth_token', token);
                window.history.replaceState({}, document.title, window.location.pathname);
                window.location.reload();
            }
        }

        async function loadDashboardNews() {
            const container = document.getElementById('dashboardNewsList');
            try {
                const token = localStorage.getItem('auth_token');
                // Use API_URL from config (or global if available)
                const res = await fetch(`${API_URL}/announcements`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    if (data.length === 0) {
                        container.innerHTML = '<p style="color: var(--text-muted);">Zatím žádné novinky.</p>';
                        return;
                    }
                    container.innerHTML = data.slice(0, 3).map(ann => `
                                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.5rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                                        <strong style="color: #fcd34d;">${ann.isPinned ? '<i class="fa-solid fa-thumbtack"></i> ' : ''}${escapeHtml(ann.title)}</strong>
                                        <span style="font-size: 0.8rem; color: var(--text-muted);">${new Date(ann.createdAt).toLocaleDateString('cs-CZ')}</span>
                                    </div>
                                    <div style="font-size: 0.9rem; color: #ddd; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                        ${ann.content.substring(0, 150)}${ann.content.length > 150 ? '...' : ''}
                                    </div>
                                </div>
                            `).join('');
                }
            } catch (e) {
                console.error(e);
                container.innerHTML = '<p style="color: #ef4444;">Nepodařilo se načíst novinky.</p>';
            }
        }

        // Simple escape helper if not available
        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        document.addEventListener('DOMContentLoaded', async () => {
            handleOAuthCallback();

            // Set Date
            const dateEl = document.getElementById('currentDate');
            if (dateEl) dateEl.textContent = new Date().toLocaleDateString('cs-CZ', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            const user = await checkAuth(false);

            if (user) {
                document.getElementById('loginView').classList.add('hidden');
                document.getElementById('hubView').classList.remove('hidden');

                // Populate Dashboard Info
                document.getElementById('welcomeMsg').textContent = `Vítejte, ${user.realName || user.username}`;
                document.getElementById('userRoleBadge').textContent = user.role;
                if (user.role === 'ADMIN' || user.role === 'SUPERADMIN') {
                    document.getElementById('userRoleBadge').style.color = '#fcd34d';
                }

                loadDashboardNews();
            } else {
                document.getElementById('loginView').classList.remove('hidden');
                document.getElementById('hubView').classList.add('hidden');
            }
        });
    </script>
</body>

</html>