// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Role hierarchy: USER < MEMBER < ADMIN < SUPERADMIN
enum Role {
  USER
  MEMBER
  ADMIN
  SUPERADMIN
}

model User {
  id               Int       @id @default(autoincrement())
  username         String    @unique
  email            String    @unique
  passwordHash     String?   @map("password_hash")  // Optional for OAuth users
  googleId         String?   @unique @map("google_id")  // Google OAuth ID
  realName         String?   @map("real_name")  // Actual name (editable)
  club             String?   // Club affiliation (editable)
  useRealName      Boolean   @default(false) @map("use_real_name") // Show real name in comments?
  role             Role      @default(USER)
  resetToken       String?   @map("reset_token")  // Password reset token
  resetTokenExpiry DateTime? @map("reset_token_expiry")  // Token expiration
  lastLogin        DateTime? @map("last_login")  // Last login timestamp
  createdAt        DateTime  @default(now()) @map("created_at")
  
  authoredNews    News[]   @relation("NewsAuthor")
  coAuthoredNews  News[]   @relation("NewsCoAuthor")
  puzzleResults   PuzzleRaceResult[]
  recordedGames   GameRecorded[]
  comments        Comment[]
  announcements   Announcement[]
  documents       Document[]
  travelReports   TravelReport[]
  forumTopics     ForumTopic[]
  forumPosts      ForumPost[]
  
  @@map("users")
}

model Comment {
  id        Int      @id @default(autoincrement())
  content   String
  newsId    Int      @map("news_id")
  authorId  Int      @map("author_id")
  parentId  Int?     @map("parent_id")
  isHidden  Boolean  @default(false) @map("is_hidden")
  isDeleted Boolean  @default(false) @map("is_deleted")
  deletedBy Int?     @map("deleted_by") // user ID who deleted it
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  news      News     @relation(fields: [newsId], references: [id], onDelete: Cascade)
  author    User     @relation(fields: [authorId], references: [id])
  parent    Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")
  
  @@map("comments")
}

model Message {
  id        Int      @id @default(autoincrement())
  author    String
  content   String
  type      String   @default("chat") // 'chat', 'wish'
  createdAt DateTime @default(now())
}

model News {
  id            Int       @id @default(autoincrement())
  title         String
  slug          String    @unique
  category      String
  excerpt       String
  content       String?
  thumbnailUrl  String?   @map("thumbnail_url")
  linkUrl       String?   @map("link_url")
  gamesJson     String?   @map("games_json")
  teamsJson     String?   @map("teams_json")
  galleryJson   String?   @map("gallery_json")
  introJson     String?   @map("intro_json")
  publishedDate DateTime  @map("published_date")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  isPublished   Boolean   @default(false) @map("is_published")
  
  // Author - defaults to creator, can be overridden
  authorId      Int?      @map("author_id")
  authorName    String?   @map("author_name")  // Custom name if not from user
  
  // Co-author (optional)
  coAuthorId    Int?      @map("co_author_id")
  coAuthorName  String?   @map("co_author_name")  // Custom name if not from user
  
  author        User?     @relation("NewsAuthor", fields: [authorId], references: [id])
  coAuthor      User?     @relation("NewsCoAuthor", fields: [coAuthorId], references: [id])
  matchReport   MatchReport?
  games         Game[]
  comments      Comment[]
  
  // Stats
  viewCount     Int       @default(0) @map("view_count")
  
  images        Image[]
  
  @@map("news")
}

model MatchReport {
  id          Int      @id @default(autoincrement())
  newsId      Int      @unique @map("news_id")
  matchDate   DateTime @map("match_date")
  teamAName   String   @map("team_a_name")
  teamBName   String   @map("team_b_name")
  scoreA      Int?     @map("score_a")
  scoreB      Int?     @map("score_b")
  reportText  String?  @map("report_text")
  createdAt   DateTime @default(now()) @map("created_at")
  
  news        News     @relation(fields: [newsId], references: [id], onDelete: Cascade)
  games       Game[]
  
  @@map("match_reports")
}

model Game {
  id            Int      @id @default(autoincrement())
  gameTitle     String   @map("game_title")
  chessComId    String   @map("chess_com_id")
  whitePlayer   String?  @map("white_player")
  blackPlayer   String?  @map("black_player")
  team          String?
  positionOrder Int?     @map("position_order")
  isCommented   Boolean  @default(false) @map("is_commented")
  
  // Flexible relations - game can belong to report OR news
  reportId      Int?     @map("report_id")
  newsId        Int?     @map("news_id")
  
  report        MatchReport? @relation(fields: [reportId], references: [id], onDelete: Cascade)
  news          News?        @relation(fields: [newsId], references: [id], onDelete: Cascade)
  
  pgn           String?  @map("pgn")
  
  @@map("games")
  @@index([chessComId])
}

model Image {
  id           Int      @id @default(autoincrement())
  filename     String
  originalName String?  @map("original_name")
  url          String
  altText      String?  @map("alt_text")
  category     String?  @map("category") // e.g. "blicak"
  newsId       Int?     @map("news_id")
  sortOrder    Int      @default(0) @map("sort_order")
  isPublic     Boolean  @default(false) @map("is_public")
  uploadedAt   DateTime @default(now()) @map("uploaded_at")
  
  news         News?    @relation(fields: [newsId], references: [id], onDelete: SetNull)

  @@map("images")
}

model Member {
  id        Int     @id @default(autoincrement())
  firstName String  @map("first_name")
  lastName  String  @map("last_name")
  elo       Int?
  title     String?
  birthYear Int?    @map("birth_year")
  role      String?
  
  @@map("members")
}

model Competition {
  id        String   @id @default(uuid())
  name      String
  type      String   @default("chess-results")
  url       String
  category  String
  chessczUrl String?  @map("chesscz_url")
  sortOrder  Int      @default(0) @map("sort_order")
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  
  standings Standing[]
  
  @@map("competitions")
}

model Standing {
  id            Int      @id @default(autoincrement())
  competitionId String   @map("competition_id")
  team          String
  rank          Int
  points        Float?
  wins          Int?
  draws         Int?
  losses        Int?
  games         Int?
  score         Float?
  scheduleJson  String?  @map("schedule_json") @db.Text
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  
  @@unique([competitionId, team])
  @@map("standings")
}

model BlicakRegistration {
  id        Int      @id @default(autoincrement())
  name      String
  club      String?
  lok       String?
  birthYear Int?     @map("birth_year")
  eventDate DateTime @default(now()) @map("event_date")
  createdAt DateTime @default(now()) @map("created_at")
  
  @@map("blicak_registrations")
}


model SystemSetting {
  key   String @id
  value String

  @@map("system_settings")
}

model PuzzleRaceResult {
  id        Int      @id @default(autoincrement())
  score     Int
  playerName String   @map("player_name")
  userId    Int?     @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  mode      String   @default("vanilla") // 'vanilla', 'thematic'

  user      User?    @relation(fields: [userId], references: [id])

  @@map("puzzle_race_results")
}

model GameRecorded {
  id          Int      @id @default(autoincrement())
  white       String
  black       String
  result      String   // "1-0", "0-1", "1/2-1/2", "*"
  date        DateTime @default(now())
  event       String?
  pgn         String   @map("pgn_text")
  uploadedBy  Int?     @map("uploaded_by")
  createdAt   DateTime @default(now()) @map("created_at")
  
  user        User?    @relation(fields: [uploadedBy], references: [id])

  @@map("games_recorded")
}

model PuzzleRacerSettings {
  id                    Int      @id @default(1)
  puzzleTheme           String   @default("mix") @map("puzzle_theme")
  timeLimitSeconds      Int      @default(180) @map("time_limit_seconds")
  livesEnabled          Boolean  @default(true) @map("lives_enabled")
  maxLives              Int      @default(3) @map("max_lives")
  puzzlesPerDifficulty  Int      @default(6) @map("puzzles_per_difficulty")
  penaltyEnabled        Boolean  @default(false) @map("penalty_enabled")
  penaltySeconds        Int      @default(5) @map("penalty_seconds")
  skipOnMistake         Boolean  @default(false) @map("skip_on_mistake")
  randomizePuzzles      Boolean  @default(true) @map("randomize_puzzles")
  fixedPuzzleSet        Json?    @map("fixed_puzzle_set")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("puzzle_racer_settings")
}

model Event {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  startDate   DateTime  @map("start_date")
  endDate     DateTime? @map("end_date")
  location    String?
  
  // Event categorization
  category    String    @default("tournament") // tournament, training, camp, meeting, other
  ageGroup    String?   @map("age_group")      // youth, adults, all
  eventType   String?   @map("event_type")     // individual, team
  timeControl String?   @map("time_control")   // blitz, rapid, classical
  
  // Tournament-specific fields
  registrationDeadline DateTime? @map("registration_deadline") // přihlášky do
  presentationEnd      DateTime? @map("presentation_end")      // konec prezentace
  entryFee             String?   @map("entry_fee")             // startovné
  organizerContact     String?   @map("organizer_contact")     // kontakt na pořadatele
  url                  String?                                  // odkaz na stránky akce
  
  // Visibility
  isInternal  Boolean   @default(false) @map("is_internal") // true = only MEMBER+
  isPublic    Boolean   @default(true) @map("is_public")
  
  createdBy   Int?      @map("created_by")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  @@map("events")
}

// ==========================================
// Chess Database (SSCR 2003-2025)
// ==========================================

model ChessGame {
  id          Int       @id @default(autoincrement())
  event       String?
  site        String?
  date        DateTime?
  round       String?
  whitePlayer String    @map("white_player")
  blackPlayer String    @map("black_player")
  result      String    // "1-0", "0-1", "1/2-1/2", "*"
  eco         String?
  whiteElo    Int?      @map("white_elo")
  blackElo    Int?      @map("black_elo")
  plyCount    Int?      @map("ply_count")
  moves       String    @db.Text // SAN moves as string
  
  @@index([whitePlayer])
  @@index([blackPlayer])
  @@index([eco])
  @@index([date])
  @@map("chess_games")
}

model ChessMove {
  id       Int    @id @default(autoincrement())
  gameId   Int    @map("game_id")
  plyNum   Int    @map("ply_num")  // 1 = first white move, 2 = first black, etc.
  san      String // "e4", "Nf3", etc.
  
  @@index([san, plyNum])
  @@index([gameId])
  @@map("chess_moves")
}

model Announcement {
  id        Int      @id @default(autoincrement())
  title     String
  content   String
  authorId  Int      @map("author_id")
  isPinned  Boolean  @default(false) @map("is_pinned")
  createdAt DateTime @default(now()) @map("created_at")
  
  author    User     @relation(fields: [authorId], references: [id])
  
  @@map("announcements")
}

model Document {
  id           Int      @id @default(autoincrement())
  title        String
  filename     String
  url          String
  category     String   @default("other") // stanovy, zapisy, formulare, other
  uploadedById Int      @map("uploaded_by_id")
  createdAt    DateTime @default(now()) @map("created_at")
  
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])
  
  @@map("documents")
}

model TravelReport {
  id           Int      @id @default(autoincrement())
  userId       Int      @map("user_id")
  date         DateTime
  from         String
  to           String
  purpose      String
  distance     Int
  vehicle      String   // car, bus, other
  licensePlate String?  @map("license_plate") // SPZ vozidla
  passengers   String?  // Spolucestující (čárkou oddělená jména)
  status       String   @default("pending") // pending, approved, rejected
  note         String?  // Admin note for approval/rejection
  createdAt    DateTime @default(now()) @map("created_at")
  
  user         User     @relation(fields: [userId], references: [id])
  
  @@map("travel_reports")
}

// Discussion Forum
model ForumTopic {
  id          Int      @id @default(autoincrement())
  title       String
  content     String
  authorId    Int      @map("author_id")
  isPinned    Boolean  @default(false) @map("is_pinned")
  isLocked    Boolean  @default(false) @map("is_locked")
  viewCount   Int      @default(0) @map("view_count")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  author      User        @relation(fields: [authorId], references: [id])
  posts       ForumPost[]
  
  @@map("forum_topics")
}

model ForumPost {
  id        Int      @id @default(autoincrement())
  content   String
  topicId   Int      @map("topic_id")
  authorId  Int      @map("author_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  topic     ForumTopic @relation(fields: [topicId], references: [id], onDelete: Cascade)
  author    User       @relation(fields: [authorId], references: [id])
  
  @@map("forum_posts")
}
