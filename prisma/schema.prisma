// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Role hierarchy: USER < ADMIN < SUPERADMIN
enum Role {
  USER
  ADMIN
  SUPERADMIN
}

model User {
  id           Int      @id @default(autoincrement())
  username     String   @unique
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         Role     @default(USER)
  createdAt    DateTime @default(now()) @map("created_at")
  
  news         News[]
  puzzleResults PuzzleRaceResult[]
  recordedGames GameRecorded[]
  
  @@map("users")
}

model Message {
  id        Int      @id @default(autoincrement())
  author    String
  content   String
  createdAt DateTime @default(now())
}

model News {
  id            Int       @id @default(autoincrement())
  title         String
  slug          String    @unique
  category      String
  excerpt       String
  content       String?
  thumbnailUrl  String?   @map("thumbnail_url")
  linkUrl       String?   @map("link_url")
  gamesJson     String?   @map("games_json")
  teamsJson     String?   @map("teams_json")
  galleryJson   String?   @map("gallery_json")
  introJson     String?   @map("intro_json")
  publishedDate DateTime  @map("published_date")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  isPublished   Boolean   @default(false) @map("is_published")
  authorId      Int?      @map("author_id")
  
  author        User?     @relation(fields: [authorId], references: [id])
  matchReport   MatchReport?
  games         Game[]
  
  images        Image[]
  
  @@map("news")
}

model MatchReport {
  id          Int      @id @default(autoincrement())
  newsId      Int      @unique @map("news_id")
  matchDate   DateTime @map("match_date")
  teamAName   String   @map("team_a_name")
  teamBName   String   @map("team_b_name")
  scoreA      Int?     @map("score_a")
  scoreB      Int?     @map("score_b")
  reportText  String?  @map("report_text")
  createdAt   DateTime @default(now()) @map("created_at")
  
  news        News     @relation(fields: [newsId], references: [id], onDelete: Cascade)
  games       Game[]
  
  @@map("match_reports")
}

model Game {
  id            Int      @id @default(autoincrement())
  gameTitle     String   @map("game_title")
  chessComId    String   @map("chess_com_id")
  whitePlayer   String?  @map("white_player")
  blackPlayer   String?  @map("black_player")
  team          String?
  positionOrder Int?     @map("position_order")
  isCommented   Boolean  @default(false) @map("is_commented")
  
  // Flexible relations - game can belong to report OR news
  reportId      Int?     @map("report_id")
  newsId        Int?     @map("news_id")
  
  report        MatchReport? @relation(fields: [reportId], references: [id], onDelete: Cascade)
  news          News?        @relation(fields: [newsId], references: [id], onDelete: Cascade)
  
  pgn           String?  @map("pgn")
  
  @@map("games")
  @@index([chessComId])
}

model Image {
  id           Int      @id @default(autoincrement())
  filename     String
  originalName String?  @map("original_name")
  url          String
  altText      String?  @map("alt_text")
  category     String?  @map("category") // e.g. "blicak"
  newsId       Int?     @map("news_id")
  sortOrder    Int      @default(0) @map("sort_order")
  isPublic     Boolean  @default(false) @map("is_public")
  uploadedAt   DateTime @default(now()) @map("uploaded_at")
  
  news         News?    @relation(fields: [newsId], references: [id], onDelete: SetNull)

  @@map("images")
}

model Member {
  id        Int     @id @default(autoincrement())
  firstName String  @map("first_name")
  lastName  String  @map("last_name")
  elo       Int?
  title     String?
  birthYear Int?    @map("birth_year")
  role      String?
  
  @@map("members")
}

model Competition {
  id        String   @id @default(uuid())
  name      String
  type      String   @default("chess-results")
  url       String
  category  String
  chessczUrl String?  @map("chesscz_url")
  sortOrder  Int      @default(0) @map("sort_order")
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  
  standings Standing[]
  
  @@map("competitions")
}

model Standing {
  id            Int      @id @default(autoincrement())
  competitionId String   @map("competition_id")
  team          String
  rank          Int
  points        Float?
  wins          Int?
  draws         Int?
  losses        Int?
  games         Int?
  score         Float?
  scheduleJson  String?  @map("schedule_json") @db.Text
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  
  @@unique([competitionId, team])
  @@map("standings")
}

model BlicakRegistration {
  id        Int      @id @default(autoincrement())
  name      String
  club      String?
  lok       String?
  birthYear Int?     @map("birth_year")
  eventDate DateTime @default(now()) @map("event_date")
  createdAt DateTime @default(now()) @map("created_at")
  
  @@map("blicak_registrations")
}


model SystemSetting {
  key   String @id
  value String

  @@map("system_settings")
}

model PuzzleRaceResult {
  id        Int      @id @default(autoincrement())
  score     Int
  playerName String   @map("player_name")
  userId    Int?     @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  mode      String   @default("vanilla") // 'vanilla', 'thematic'

  user      User?    @relation(fields: [userId], references: [id])

  @@map("puzzle_race_results")
}

model GameRecorded {
  id          Int      @id @default(autoincrement())
  white       String
  black       String
  result      String   // "1-0", "0-1", "1/2-1/2", "*"
  date        DateTime @default(now())
  event       String?
  pgn         String   @map("pgn_text")
  uploadedBy  Int?     @map("uploaded_by")
  createdAt   DateTime @default(now()) @map("created_at")
  
  user        User?    @relation(fields: [uploadedBy], references: [id])

  @@map("games_recorded")
}

model PuzzleRacerSettings {
  id                    Int      @id @default(1)
  puzzleTheme           String   @default("mix") @map("puzzle_theme")
  timeLimitSeconds      Int      @default(180) @map("time_limit_seconds")
  livesEnabled          Boolean  @default(true) @map("lives_enabled")
  maxLives              Int      @default(3) @map("max_lives")
  puzzlesPerDifficulty  Int      @default(6) @map("puzzles_per_difficulty")
  penaltyEnabled        Boolean  @default(false) @map("penalty_enabled")
  penaltySeconds        Int      @default(5) @map("penalty_seconds")
  skipOnMistake         Boolean  @default(false) @map("skip_on_mistake")
  randomizePuzzles      Boolean  @default(true) @map("randomize_puzzles")
  fixedPuzzleSet        Json?    @map("fixed_puzzle_set")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("puzzle_racer_settings")
}
