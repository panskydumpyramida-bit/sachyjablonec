<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Správa webu</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        :root {
            --editor-bg: #1e1e1e;
            --editor-border: rgba(255, 255, 255, 0.1);
        }

        .admin-container {
            max-width: 1800px;
            margin: 100px auto 2rem;
            padding: 0 2rem;
        }

        .login-container {
            max-width: 400px;
            margin: 150px auto;
            padding: 2rem;
            background: var(--surface-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--editor-border);
        }

        .admin-header {
            background: linear-gradient(135deg, var(--primary-color), #b8941f);
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            color: var(--secondary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface-color);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--editor-border);
        }

        .data-table th {
            background: rgba(255, 255, 255, 0.05);
            color: var(--primary-color);
            font-weight: 600;
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-published {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        .status-draft {
            background: rgba(234, 179, 8, 0.2);
            color: #fde047;
        }

        .action-btn {
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            margin-right: 0.25rem;
            transition: all 0.2s;
        }

        .btn-edit {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
        }

        .btn-delete {
            background: rgba(220, 38, 38, 0.2);
            color: #fca5a5;
        }

        .btn-publish {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        .editor-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            min-height: 80vh;
        }

        .editor-main,
        .editor-sidebar {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--editor-border);
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--editor-border);
            border-radius: 6px;
            color: var(--text-color);
            font-family: inherit;
        }

        .wysiwyg-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--editor-border);
            border-radius: 6px 6px 0 0;
            border-bottom: none;
        }

        .wysiwyg-toolbar button {
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-color);
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .wysiwyg-toolbar button:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: var(--primary-color);
        }

        .wysiwyg-toolbar .divider {
            width: 1px;
            background: var(--editor-border);
            margin: 0 0.5rem;
        }

        .wysiwyg-content {
            min-height: 400px;
            padding: 1rem;
            background: var(--editor-bg);
            border: 1px solid var(--editor-border);
            border-radius: 0 0 6px 6px;
            color: var(--text-color);
            line-height: 1.6;
            outline: none;
            overflow-y: auto;
        }

        .wysiwyg-content:focus {
            border-color: var(--primary-color);
        }

        .highlight-name {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(147, 51, 234, 0.3));
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .highlight-score {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(16, 185, 129, 0.3));
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            font-weight: 700;
        }

        .preview-card {
            margin-bottom: 1.5rem;
        }

        .preview-title {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        .news-preview {
            background: var(--editor-bg);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--editor-border);
        }

        .preview-image {
            height: 180px;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .preview-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-upload {
            border: 2px dashed var(--editor-border);
            border-radius: 6px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload:hover {
            border-color: var(--primary-color);
            background: rgba(212, 175, 55, 0.05);
        }

        .image-upload.has-image {
            padding: 0;
            border: none;
        }

        .uploaded-thumb {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 6px;
        }

        /* Styles for content blocks in editor */
        .wysiwyg-content .puzzle-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid var(--primary-color);
        }

        .wysiwyg-content .puzzle-section img {
            max-width: 320px;
            margin: 1rem auto;
            display: block;
        }

        .wysiwyg-content .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .wysiwyg-content .card-content {
            padding: 1.5rem;
        }

        #articlePreview .puzzle-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid var(--primary-color);
        }

        #articlePreview .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin: 1rem 0;
        }

        #articlePreview .card-content {
            padding: 1.5rem;
        }

        .panel-section {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            border: 1px solid var(--editor-border);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .game-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 4px;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            cursor: grab;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .game-item:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .game-item.dragging {
            opacity: 0.5;
            background: rgba(212, 175, 55, 0.2);
            border: 1px dashed var(--primary-color);
        }

        .game-item.drag-over {
            border-top: 2px solid var(--primary-color);
        }

        .game-item .drag-handle {
            cursor: grab;
            color: var(--text-muted);
            margin-right: 0.75rem;
        }

        .game-item .game-inputs {
            display: flex;
            gap: 0.5rem;
            flex: 1;
        }

        .game-item .game-title-input {
            flex: 2;
            padding: 0.3rem 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--editor-border);
            border-radius: 4px;
            color: var(--text-color);
            font-size: 0.85rem;
        }

        .game-item .game-id-input {
            flex: 1;
            padding: 0.3rem 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--editor-border);
            border-radius: 4px;
            color: var(--text-color);
            font-size: 0.85rem;
            max-width: 120px;
        }

        .game-item .game-actions {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-left: 0.5rem;
        }

        .game-item .team-badge {
            font-size: 0.75rem;
            padding: 0.15rem 0.5rem;
            border-radius: 3px;
            margin-left: 0.5rem;
        }

        .team-checkbox-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .team-checkbox {
            display: flex;
            align-items: center;
            padding: 0.4rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .team-checkbox:hover {
            background: rgba(212, 175, 55, 0.1);
        }

        .team-checkbox input {
            margin-right: 0.5rem;
        }

        .team-checkbox.checked {
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid var(--primary-color);
        }

        .add-team-input {
            display: flex;
            gap: 0.5rem;
        }

        .add-team-input input {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.85rem;
        }

        .add-team-input button {
            padding: 0.5rem 0.75rem;
        }

        .admin-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--editor-border);
            padding-bottom: 1rem;
        }

        .nav-tab {
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            border-radius: 6px;
            color: var(--text-muted);
            transition: all 0.2s;
            font-size: 0.95rem;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
        }

        .nav-tab.active {
            background: var(--primary-color);
            color: var(--secondary-color);
            font-weight: 600;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--secondary-color);
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-color);
            padding: 0.75rem 1.5rem;
            border: 1px solid var(--editor-border);
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        .hidden {
            display: none !important;
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .alert-error {
            background: rgba(220, 38, 38, 0.1);
            color: #fca5a5;
        }

        .alert-success {
            background: rgba(34, 197, 94, 0.1);
            color: #86efac;
        }

        @media (max-width: 1200px) {
            .editor-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- LOGIN -->
    <div id="loginPage" class="hidden">
        <div class="login-container">
            <h1 style="text-align: center; margin-bottom: 2rem;">
                <i class="fa-solid fa-chess-knight" style="color: var(--primary-color);"></i><br>Admin Panel
            </h1>
            <div id="loginError"></div>
            <form id="loginForm">
                <div class="form-group"><label>Uživatelské jméno</label><input type="text" id="username" required></div>
                <div class="form-group"><label>Heslo</label>
                    <div style="position: relative;">
                        <input type="password" id="password" required style="padding-right: 40px;">
                        <i class="fa-solid fa-eye" id="togglePassword"
                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--text-muted);"></i>
                    </div>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%">Přihlásit se</button>
            </form>
        </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="adminPanel" class="hidden">
        <header>
            <div class="container">
                <nav>
                    <a href="index.html" class="logo"><i class="fa-solid fa-chess-knight"></i> TJ Bižuterie - Admin</a>
                    <ul class="nav-links">
                        <li><a href="index.html" target="_blank">Web</a></li>
                        <li><a href="blicak.html" target="_blank">Blesk</a></li>
                        <li><a href="#" onclick="logout()" style="color: #fca5a5;">Odhlásit</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <div class="admin-container">
            <div class="admin-header">
                <div>
                    <h1 style="margin: 0; font-size: 1.75rem;"><i class="fa-solid fa-cogs"></i> Správa webu</h1>
                    <p style="margin: 0.25rem 0 0 0; opacity: 0.9; font-size: 0.9rem;" id="userInfo"></p>
                </div>
            </div>

            <div class="admin-nav">
                <div class="nav-tab active" onclick="switchTab('dashboard')"><i class="fa-solid fa-list"></i> Přehled
                </div>
                <div class="nav-tab" onclick="switchTab('editor')"><i class="fa-solid fa-plus"></i> Nová novinka</div>
                <div class="nav-tab" onclick="switchTab('members')" style="display: none;"><i
                        class="fa-solid fa-address-book"></i> Členové
                </div>
                <div class="nav-tab hidden" id="usersTab" onclick="switchTab('users')"><i class="fa-solid fa-users"></i>
                    Uživatelé</div>
                <div class="nav-tab" id="messagesTab" onclick="switchTab('messages')"><i
                        class="fa-solid fa-comments"></i>
                    Vzkazovník</div>
                <div class="nav-tab" id="blicakTab" onclick="switchTab('blicak')"><i class="fa-solid fa-bolt"></i>
                    Vánoční blesk</div>
                <div class="nav-tab" id="competitionsTab" onclick="switchTab('competitions')"><i
                        class="fa-solid fa-table"></i>
                    Tabulky družstva</div>
            </div>

            <div id="alertContainer"></div>

            <!-- DASHBOARD -->
            <div id="dashboardView">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="margin: 0;">Seznam novinek</h2>
                    <button class="btn-primary" onclick="switchTab('editor')"><i class="fa-solid fa-plus"></i> Nová
                        novinka</button>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Název</th>
                            <th>Kategorie</th>
                            <th>Autor</th>
                            <th>Stav</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody id="newsTableBody"></tbody>
                </table>
            </div>

            <!-- EDITOR -->
            <div id="editorView" class="hidden">
                <div class="editor-layout">
                    <!-- Main Editor (70%) -->
                    <div class="editor-main">
                        <h2 style="margin-top: 0;" id="editorTitle">Nová novinka</h2>
                        <input type="hidden" id="editNewsId">

                        <div class="form-group">
                            <label>Nadpis článku *</label>
                            <input type="text" id="newsTitle" placeholder="Zadejte nadpis..." oninput="updatePreview()">
                        </div>

                        <!-- WYSIWYG Editor -->
                        <div class="form-group">
                            <label>Obsah článku *</label>
                            <div class="wysiwyg-toolbar">
                                <button type="button" id="btnBold" onclick="formatText('bold')"
                                    title="Tučně (Ctrl+B)"><i class="fa-solid fa-bold"></i></button>
                                <button type="button" id="btnItalic" onclick="formatText('italic')"
                                    title="Kurzíva (Ctrl+I)"><i class="fa-solid fa-italic"></i></button>
                                <button type="button" id="btnUnderline" onclick="formatText('underline')"
                                    title="Podtržení (Ctrl+U)"><i class="fa-solid fa-underline"></i></button>
                                <div class="divider"></div>
                                <button type="button" id="btnHighlightName" onmousedown="event.preventDefault()"
                                    onclick="insertHighlight('name')" title="Zvýraznit jméno" style="color: #60a5fa;"><i
                                        class="fa-solid fa-user"></i>
                                    Jméno</button>
                                <button type="button" id="btnHighlightScore" onmousedown="event.preventDefault()"
                                    onclick="insertHighlight('score')" title="Zvýraznit skóre"
                                    style="color: #4ade80;"><i class="fa-solid fa-trophy"></i>
                                    Skóre</button>
                                <div class="divider"></div>
                                <select id="headingSelect" onchange="applyHeading(this.value)" title="Formát"
                                    style="background: var(--surface-color); color: var(--text-main); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; padding: 0.2rem; font-size: 0.75rem; width: 55px;">
                                    <option value="p">P</option>
                                    <option value="h1">H1</option>
                                    <option value="h2">H2</option>
                                    <option value="h3">H3</option>
                                </select>
                                <button type="button" onclick="insertLink()" title="Odkaz"><i
                                        class="fa-solid fa-link"></i></button>
                                <div class="divider"></div>
                                <button type="button" onclick="insertIntroBlock()" title="Puzzle blok"
                                    style="color: #fbbf24;"><i class="fa-solid fa-lightbulb"></i></button>
                                <button type="button" onclick="insertImage()" title="Obrázek" style="color: #f472b6;"><i
                                        class="fa-solid fa-image"></i></button>
                                <button type="button" onclick="insertCollapsibleBlock()" title="Rozbalovací sekce"
                                    style="color: #8b5cf6;"><i class="fa-solid fa-layer-group"></i></button>
                                <div class="divider"></div>
                                <button type="button" onclick="toggleSource()" title="HTML" id="btnSource"><i
                                        class="fa-solid fa-code"></i></button>
                            </div>
                            <div class="wysiwyg-content" id="articleContent" contenteditable="true"
                                oninput="updatePreview()"></div>
                            <textarea id="articleSource" class="wysiwyg-content hidden"
                                oninput="updateContentFromSource()"></textarea>
                        </div>

                        <!-- Games Panel -->
                        <div class="panel-section">
                            <div class="panel-header">
                                <label style="margin: 0;"><i class="fa-solid fa-chess-board"></i> Přehrávač
                                    partií</label>
                                <button type="button" class="btn-secondary btn-small" onclick="toggleGamesInput()"><i
                                        class="fa-solid fa-plus"></i> Přidat</button>
                            </div>

                            <div class="form-group" id="gamesInputPanel">
                                <div
                                    style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                    <h4 style="margin-top: 0; color: var(--primary-color);">Přidat partii</h4>
                                    <div
                                        style="display: grid; grid-template-columns: 1fr 100px; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="text" id="gameTitle"
                                            placeholder="Kdo s kým (např. Duda - Vltavský)">
                                        <input type="text" id="gameId" placeholder="Chess.com ID">
                                    </div>
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <label
                                            style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox" id="gameCommented" style="width: auto; margin: 0;">
                                            Komentovaná
                                        </label>
                                        <button type="button" class="btn-primary btn-small" onclick="addGame()">
                                            <i class="fa-solid fa-plus"></i> Přidat partii
                                        </button>
                                    </div>
                                </div>

                                <div
                                    style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                    <h4 style="margin-top: 0; color: var(--primary-color);">Přidat nadpis (oddělovač)
                                    </h4>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="text" id="headerTitle" placeholder="Např. A tým, B tým...">
                                        <button type="button" class="btn-secondary btn-small" onclick="addHeader()">
                                            <i class="fa-solid fa-heading"></i> Přidat
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div id="gamesList" style="margin-top: 1rem;"></div>
                        </div>

                        <!-- Gallery Panel -->
                        <div class="panel-section">
                            <div class="panel-header">
                                <label style="margin: 0;"><i class="fa-solid fa-images"></i> Galerie</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button type="button" class="btn-secondary btn-small"
                                        onclick="document.getElementById('galleryInput').click()"><i
                                            class="fa-solid fa-upload"></i> Nahrát</button>
                                    <button type="button" class="btn-secondary btn-small"
                                        onclick="toggleGalleryUrlInput()"><i class="fa-solid fa-link"></i> URL</button>
                                </div>
                                <input type="file" id="galleryInput" accept="image/*" multiple style="display: none;"
                                    onchange="addGalleryImages(event)">
                            </div>
                            <div id="galleryUrlInput" class="hidden" style="margin-bottom: 0.75rem;">
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="text" id="galleryImageUrl" placeholder="URL obrázku (https://...)"
                                        style="flex: 1; font-size: 0.85rem;">
                                    <button type="button" class="btn-primary btn-small"
                                        onclick="addGalleryFromUrl()">Přidat</button>
                                </div>
                            </div>
                            <div id="galleryPreview" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
                        </div>

                        <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                            <button class="btn-primary" onclick="saveNews()"><i class="fa-solid fa-save"></i>
                                Uložit</button>
                            <button class="btn-secondary" onclick="switchTab('dashboard')">Zrušit</button>
                        </div>
                    </div>

                    <!-- Sidebar (30%) -->
                    <div class="editor-sidebar">
                        <div class="preview-card">
                            <div class="preview-title">Náhled karty</div>
                            <div class="news-preview">
                                <div class="preview-image" id="previewImage"><i class="fa-solid fa-image"
                                        style="font-size: 2rem; color: var(--text-muted);"></i></div>
                                <div class="card-content" style="padding: 1rem;">
                                    <span class="card-category" id="previewCategory">Kategorie</span>
                                    <span class="card-date" id="previewDate">Datum</span>
                                    <h3 class="card-title" id="previewTitle" style="font-size: 1rem; margin: 0.5rem 0;">
                                        Nadpis</h3>
                                    <p class="card-excerpt" id="previewExcerpt"
                                        style="font-size: 0.85rem; color: var(--text-muted);">Krátký popis...</p>
                                </div>
                            </div>
                        </div>

                        <div class="preview-card" style="margin-top: 1rem;">
                            <div class="preview-title"
                                style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Náhled článku</span>
                                <button type="button" class="btn-secondary btn-small" onclick="toggleFullPreview()"><i
                                        class="fa-solid fa-expand"></i></button>
                            </div>
                            <div id="articlePreview"
                                style="padding: 1rem; max-height: 400px; overflow-y: auto; background: var(--card-bg); border-radius: var(--border-radius);">
                                <p style="color: var(--text-muted); text-align: center;">Začněte psát obsah...</p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Náhledový obrázek *</label>
                            <div class="image-upload" id="uploadArea"
                                onclick="document.getElementById('imageInput').click()">
                                <div id="uploadPlaceholder"><i class="fa-solid fa-cloud-upload-alt"
                                        style="font-size: 1.5rem; color: var(--primary-color);"></i>
                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">Klikněte pro nahrání</p>
                                </div>
                                <img id="uploadedImage" class="uploaded-thumb" style="display: none;">
                            </div>
                            <input type="file" id="imageInput" accept="image/*" style="display: none;"
                                onchange="handleImageUpload(event)">
                            <input type="text" id="imageUrl" placeholder="nebo URL obrázku"
                                style="margin-top: 0.5rem; font-size: 0.85rem;" oninput="handleImageUrl()">
                        </div>

                        <div class="form-group">
                            <label>Kategorie *</label>
                            <select id="newsCategory" onchange="updatePreview()">
                                <option value="Soutěže družstev">Soutěže družstev</option>
                                <option value="Oddílový přebor">Oddílový přebor</option>
                                <option value="Mládež">Mládež</option>
                                <option value="O nás">O nás</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Datum publikace *</label>
                            <input type="date" id="newsDate" oninput="updatePreview()">
                        </div>

                        <div class="form-group">
                            <label>Krátký popis *</label>
                            <textarea id="newsExcerpt" rows="3" placeholder="Zobrazí se na kartě novinky..."
                                oninput="updatePreview()"></textarea>
                        </div>

                        <div class="form-group">
                            <label><input type="checkbox" id="publishCheck" style="width: auto; margin-right: 0.5rem;">
                                Publikovat ihned</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- USERS -->
            <!-- MEMBERS -->
            <div id="membersView" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="margin: 0;">Seznam členů</h2>
                    <button class="btn-primary" onclick="openMemberModal()"><i class="fa-solid fa-user-plus"></i> Nový
                        člen</button>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Jméno</th>
                            <th>ELO</th>
                            <th>Titul</th>
                            <th>Narození</th>
                            <th>Role</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody id="membersTableBody"></tbody>
                </table>
            </div>

            <div id="usersView" class="hidden">
                <div class="editor-layout">
                    <div>
                        <h2>Seznam uživatelů</h2>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Akce</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                    <div class="editor-sidebar">
                        <h3>Přidat uživatele</h3>
                        <div class="form-group"><label>Username</label><input type="text" id="newUsername"></div>
                        <div class="form-group"><label>Email</label><input type="email" id="newEmail"></div>
                        <div class="form-group"><label>Heslo</label><input type="password" id="newPassword"></div>
                        <div class="form-group"><label>Role</label><select id="newRole">
                                <option value="admin">Admin</option>
                                <option value="superadmin">Superadmin</option>
                            </select></div>
                        <button class="btn-primary" onclick="createUser()">Vytvořit</button>
                    </div>
                </div>
            </div>

            <div id="messagesView" class="hidden">
                <h2><i class="fa-solid fa-comments"></i> Správa vzkazovníku</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Zde můžete mazat nevhodné příspěvky ze
                    vzkazovníku.</p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Autor</th>
                            <th>Obsah</th>
                            <th>Datum</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody id="messagesTableBody"></tbody>
                </table>
                <div id="noMessagesInfo"
                    style="text-align: center; padding: 2rem; color: var(--text-muted); display: none;">
                    Žádné vzkazy k zobrazení.
                </div>
            </div>

            <!-- Blicak Registrations View -->
            <div id="blicakView" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="margin: 0;"><i class="fa-solid fa-bolt"></i> Registrace - Vánoční blesk</h2>
                    <button class="btn-primary" onclick="loadBlicakRegistrations()"><i class="fa-solid fa-sync"></i>
                        Obnovit</button>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Jméno</th>
                            <th>Oddíl</th>
                            <th>LOK</th>
                            <th>Ročník</th>
                            <th>Čas registrace</th>
                        </tr>
                    </thead>
                    <tbody id="blicakTableBody"></tbody>
                </table>
                <div id="noBlicakInfo"
                    style="text-align: center; padding: 2rem; color: var(--text-muted); display: none;">
                    Žádné registrace.
                </div>
            </div>

            <!-- Competitions View -->
            <div id="competitionsView" class="hidden">
                <div class="card"
                    style="margin-bottom: 2rem; padding: 1.5rem; background: linear-gradient(135deg, var(--card-bg), rgba(59, 130, 246, 0.1)); border-left: 4px solid #3b82f6;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div style="width: 100%;">
                            <h3 style="margin: 0 0 0.5rem 0; color: #3b82f6;"><i class="fa-solid fa-table"></i> Tabulky
                                družstva</h3>
                            <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">Správa zdrojů dat pro
                                soutěže. Změny se projeví po kliknutí na "Aktualizovat tabulky".</p>

                            <div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
                                <button class="btn-secondary" onclick="updateStandings()" id="updateStandingsBtn">
                                    <i class="fa-solid fa-sync"></i> Aktualizovat tabulky
                                </button>
                            </div>

                            <div id="competitionsList" style="margin-top: 1rem;"></div>
                        </div>

                    </div>
                    <div id="standingsResult" style="margin-top: 1rem; display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Member Modal -->
    <div id="memberModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="width: 500px;">
            <h2 id="memberModalTitle" style="margin-top: 0;">Nový člen</h2>
            <input type="hidden" id="memberId">
            <div class="form-group">
                <label>Jméno *</label>
                <input type="text" id="memberFirstName" placeholder="Jan">
            </div>
            <div class="form-group">
                <label>Příjmení *</label>
                <input type="text" id="memberLastName" placeholder="Novák">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>ELO</label>
                    <input type="number" id="memberElo">
                </div>
                <div class="form-group">
                    <label>Titul</label>
                    <input type="text" id="memberTitle" placeholder="Např. FM">
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Rok narození</label>
                    <input type="number" id="memberBirthYear">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <input type="text" id="memberRole" placeholder="Např. Předseda">
                </div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                <button class="btn-secondary" onclick="closeMemberModal()">Zrušit</button>
                <button class="btn-primary" onclick="saveMember()">Uložit</button>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        // Admin Panel Logic - use API_URL from config.js
        let authToken = null;
        let currentUser = null;
        let uploadedImageData = null;
        let games = [];
        let teams = ['A tým', 'B tým']; // Default teams
        let galleryImages = [];

        // Init
        window.addEventListener('DOMContentLoaded', () => {
            authToken = localStorage.getItem('authToken');
            if (authToken) verifyToken();
            else showLogin();
        });

        function showLogin() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
        }

        function showAdmin() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            if (currentUser.role === 'superadmin') document.getElementById('usersTab').classList.remove('hidden');
            loadDashboard();
        }

        async function verifyToken() {
            try {
                const res = await fetch(`${API_URL}/auth/me`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                if (res.ok) {
                    currentUser = await res.json();
                    document.getElementById('userInfo').textContent = `${currentUser.username} (${currentUser.role})`;
                    showAdmin();
                } else { logout(); }
            } catch (e) { logout(); }
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            const activeTab = document.querySelector(`.nav-tab[onclick="switchTab('${tab}')"]`);
            if (activeTab) activeTab.classList.add('active');

            ['dashboard', 'editor', 'members', 'users', 'messages', 'blicak', 'competitions'].forEach(v => {
                document.getElementById(v + 'View').classList.add('hidden');
            });
            document.getElementById(tab + 'View').classList.remove('hidden');

            if (tab === 'dashboard') loadDashboard();
            if (tab === 'members') loadMembers();
            if (tab === 'users') loadUsers();
            if (tab === 'messages') loadAdminMessages();
            if (tab === 'blicak') loadBlicakRegistrations();
            if (tab === 'competitions') loadCompetitions();
        }

        // Dashboard
        async function loadDashboard() {
            try {
                const res = await fetch(`${API_URL}/news`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                const news = await res.json();
                document.getElementById('newsTableBody').innerHTML = news.map(item => `
                    <tr>
                        <td>${new Date(item.publishedDate).toLocaleDateString('cs-CZ')}</td>
                        <td>${item.title}</td>
                        <td>${item.category}</td>
                        <td><span class="highlight-name" style="font-size: 0.85rem;">${item.author?.username || '-'}</span></td>
                        <td><span class="status-badge ${item.isPublished ? 'status-published' : 'status-draft'}">${item.isPublished ? 'Publikováno' : 'Koncept'}</span></td>
                        <td>
                            <button class="action-btn btn-edit" onclick="editNews(${item.id})"><i class="fa-solid fa-pen"></i></button>
                            <button class="action-btn btn-publish" onclick="togglePublish(${item.id})" title="${item.isPublished ? 'Skrýt' : 'Publikovat'}"><i class="fa-solid fa-${item.isPublished ? 'eye-slash' : 'eye'}"></i></button>
                            <button class="action-btn btn-delete" onclick="deleteNews(${item.id})"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) { console.error(e); }
        }

        async function togglePublish(id) {
            try {
                await fetch(`${API_URL}/news/${id}/publish`, { method: 'PATCH', headers: { 'Authorization': `Bearer ${authToken}` } });
                loadDashboard();
            } catch (e) { console.error(e); }
        }

        async function loadBlicakRegistrations() {
            try {
                const res = await fetch(`${API_URL}/registration/blicak`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                if (res.ok) {
                    const regs = await res.json();
                    const tbody = document.getElementById('blicakTableBody');
                    const info = document.getElementById('noBlicakInfo');

                    if (regs.length === 0) {
                        tbody.innerHTML = '';
                        info.style.display = 'block';
                        return;
                    }

                    info.style.display = 'none';
                    tbody.innerHTML = regs.map(reg => `
                <tr>
                    <td><strong>${escapeHtml(reg.name)}</strong></td>
                    <td>${escapeHtml(reg.club || '-')}</td>
                    <td>${escapeHtml(reg.lok || '-')}</td>
                    <td>${escapeHtml(reg.year)}</td>
                    <td>${new Date(reg.createdAt).toLocaleString('cs-CZ')}</td>
                </tr>
            `).join('');
                }
            } catch (e) { console.error(e); }
        }

        // Editor
        function resetEditor() {
            document.getElementById('editorTitle').textContent = 'Nová novinka';
            document.getElementById('editNewsId').value = '';
            document.getElementById('newsTitle').value = '';
            document.getElementById('articleContent').innerHTML = '';
            document.getElementById('newsExcerpt').value = '';
            document.getElementById('newsDate').valueAsDate = new Date();
            document.getElementById('publishCheck').checked = false;
            document.getElementById('imageUrl').value = '';

            uploadedImageData = null;
            games = [];
            teams = ['A tým', 'B tým'];
            selectedTeams = ['A tým', 'B tým'];
            galleryImages = [];

            document.getElementById('uploadArea').classList.remove('has-image');
            document.getElementById('uploadPlaceholder').style.display = 'block';
            document.getElementById('uploadedImage').style.display = 'none';

            renderTeamCheckboxes();
            renderGames();
            document.getElementById('galleryPreview').innerHTML = '';
            updatePreview();
        }

        async function editNews(id) {
            try {
                const res = await fetch(`${API_URL}/news/${id}`);
                const item = await res.json();

                switchTab('editor');
                document.getElementById('editorTitle').textContent = 'Upravit novinku';
                document.getElementById('editNewsId').value = item.id;
                document.getElementById('newsTitle').value = item.title;
                document.getElementById('newsCategory').value = item.category;
                document.getElementById('newsDate').value = item.publishedDate.split('T')[0];
                document.getElementById('articleContent').innerHTML = item.content || '';
                document.getElementById('newsExcerpt').value = item.excerpt;
                document.getElementById('publishCheck').checked = item.isPublished;

                if (item.thumbnailUrl) {
                    uploadedImageData = item.thumbnailUrl;
                    displayImage(item.thumbnailUrl);
                    document.getElementById('imageUrl').value = item.thumbnailUrl;
                }

                // Load games from database
                if (item.gamesJson) {
                    try {
                        games = JSON.parse(item.gamesJson);
                        // Backwards compatibility: if simple list of games without type check, assume they are games
                        // If we see 'team' prop and no headers, we might want to respect it? 
                        // Actually, let's just render what we have. If users save, it will be new format.
                    } catch (e) { console.error(e); }
                }

                // Load gallery from database
                if (item.galleryJson) {
                    galleryImages = JSON.parse(item.galleryJson);
                } else {
                    galleryImages = [];
                }

                renderGames();
                renderGallery();
                updatePreview();
            } catch (e) {
                console.error(e);
                // Fallback rendering in case of partial failure
                renderGames();
                renderGallery();
            }
        }

        async function saveNews() {
            const id = document.getElementById('editNewsId').value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/news/${id}` : `${API_URL}/news`;

            const data = {
                title: document.getElementById('newsTitle').value,
                category: document.getElementById('newsCategory').value,
                publishedDate: document.getElementById('newsDate').value,
                content: document.getElementById('articleContent').innerHTML,
                excerpt: document.getElementById('newsExcerpt').value,
                thumbnailUrl: uploadedImageData,
                isPublished: document.getElementById('publishCheck').checked,
                gamesJson: JSON.stringify(games),
                // teamsJson: null, // Legacy field, no longer used
                galleryJson: JSON.stringify(galleryImages)
            };

            try {
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    showAlert('Uloženo!', 'success');
                    switchTab('dashboard');
                } else {
                    showAlert('Chyba při ukládání', 'error');
                }
            } catch (e) { showAlert('Chyba spojení', 'error'); }
        }

        async function deleteNews(id) {
            if (!confirm('Opravdu smazat?')) return;
            try {
                await fetch(`${API_URL}/news/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${authToken}` } });
                loadDashboard();
            } catch (e) { console.error(e); }
        }

        // WYSIWYG
        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('articleContent').focus();
            checkToolbarState();
        }

        function toggleSource() {
            const contentDiv = document.getElementById('articleContent');
            const sourceArea = document.getElementById('articleSource');
            const btn = document.getElementById('btnSource');

            if (sourceArea.classList.contains('hidden')) {
                // Switch to Source
                sourceArea.value = contentDiv.innerHTML;
                contentDiv.classList.add('hidden');
                sourceArea.classList.remove('hidden');
                btn.classList.add('active');
            } else {
                // Switch to WYSIWYG
                contentDiv.innerHTML = sourceArea.value;
                sourceArea.classList.add('hidden');
                contentDiv.classList.remove('hidden');
                btn.classList.remove('active');
                updatePreview();
            }
        }

        function updateContentFromSource() {
            const contentDiv = document.getElementById('articleContent');
            const sourceArea = document.getElementById('articleSource');
            contentDiv.innerHTML = sourceArea.value;
            updatePreview();
        }

        function insertHighlight(type) {
            const editor = document.getElementById('articleContent');
            const selection = window.getSelection();

            if (!selection.rangeCount) {
                console.log('No selection range');
                return;
            }

            const range = selection.getRangeAt(0);
            const className = type === 'name' ? 'highlight-name' : 'highlight-score';

            // Check if selection is within the editor
            if (!editor.contains(range.commonAncestorContainer)) {
                console.log('Selection not in editor');
                // If no selection in editor, insert placeholder at end
                editor.focus();
                const placeholder = type === 'name' ? '[Jméno]' : '[Skóre]';
                const span = document.createElement('span');
                span.className = className;
                span.textContent = placeholder;
                editor.appendChild(span);
                editor.appendChild(document.createTextNode(' '));
                updatePreview();
                return;
            }

            // Check if already inside a highlight span
            let parentSpan = range.commonAncestorContainer;
            while (parentSpan && parentSpan !== editor) {
                if (parentSpan.nodeType === 1 && (parentSpan.classList.contains('highlight-name') || parentSpan.classList.contains('highlight-score'))) {
                    // Toggle off or change type
                    if (parentSpan.classList.contains(className)) {
                        // Unwrap
                        const text = document.createTextNode(parentSpan.textContent);
                        parentSpan.parentNode.replaceChild(text, parentSpan);
                    } else {
                        // Change type
                        parentSpan.className = className;
                    }
                    updatePreview();
                    checkToolbarState();
                    return;
                }
                parentSpan = parentSpan.parentNode;
            }

            // Wrap selected text
            let insertedSpan = null;
            if (!selection.isCollapsed) {
                const span = document.createElement('span');
                span.className = className;
                try {
                    const contents = range.extractContents();
                    span.appendChild(contents);
                    range.insertNode(span);
                    insertedSpan = span;
                    // Clear selection
                    selection.removeAllRanges();
                } catch (e) {
                    console.error('Wrap error:', e);
                    alert('Nelze zvýraznit přes více bloků. Vyberte pouze text uvnitř odstavce.');
                }
            } else {
                // No text selected - insert placeholder
                // Use zero-width space (​) at start to keep span alive after deleting visible text
                const placeholder = type === 'name' ? '[Jméno]' : '[Skóre]';
                const span = document.createElement('span');
                span.className = className;
                span.innerHTML = '\u200B' + placeholder; // ZWS + placeholder
                range.insertNode(span);

                // Add space after span and move cursor there
                const space = document.createTextNode(' ');
                span.parentNode.insertBefore(space, span.nextSibling);

                const newRange = document.createRange();
                newRange.setStartAfter(space);
                newRange.collapse(true);
                selection.removeAllRanges();
                selection.addRange(newRange);

                editor.focus();
                updatePreview();
                checkToolbarState();
                return;
            }

            // Move cursor AFTER the span so next typing is normal (only for wrapped text)
            if (insertedSpan) {
                // Insert a space after the span and position cursor there
                const space = document.createTextNode(' ');
                insertedSpan.parentNode.insertBefore(space, insertedSpan.nextSibling);

                const newRange = document.createRange();
                newRange.setStartAfter(space);
                newRange.collapse(true);
                selection.removeAllRanges();
                selection.addRange(newRange);
            }

            editor.focus();
            updatePreview();
            checkToolbarState();
        }

        function checkToolbarState() {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;

            const anchorNode = selection.anchorNode;
            if (!anchorNode) return;

            // Check B/I/U states using queryCommandState
            const isBold = document.queryCommandState('bold');
            const isItalic = document.queryCommandState('italic');
            const isUnderline = document.queryCommandState('underline');

            // Update B/I/U button styles
            document.getElementById('btnBold').style.background = isBold ? 'rgba(255,255,255,0.2)' : 'transparent';
            document.getElementById('btnItalic').style.background = isItalic ? 'rgba(255,255,255,0.2)' : 'transparent';
            document.getElementById('btnUnderline').style.background = isUnderline ? 'rgba(255,255,255,0.2)' : 'transparent';

            // Reset highlight buttons
            document.getElementById('btnHighlightName').style.background = 'transparent';
            document.getElementById('btnHighlightScore').style.background = 'transparent';

            // Walk up DOM to find highlight span
            let el = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
            while (el && el.id !== 'articleContent') {
                if (el.classList?.contains('highlight-name')) {
                    document.getElementById('btnHighlightName').style.background = 'rgba(96, 165, 250, 0.2)';
                    break;
                } else if (el.classList?.contains('highlight-score')) {
                    document.getElementById('btnHighlightScore').style.background = 'rgba(74, 222, 128, 0.2)';
                    break;
                }
                el = el.parentElement;
            }

            // Detect heading level
            const headingSelect = document.getElementById('headingSelect');
            const blockValue = document.queryCommandValue('formatBlock');
            if (blockValue.toLowerCase() === 'h1') {
                headingSelect.value = 'h1';
            } else if (blockValue.toLowerCase() === 'h2') {
                headingSelect.value = 'h2';
            } else if (blockValue.toLowerCase() === 'h3') {
                headingSelect.value = 'h3';
            } else {
                headingSelect.value = 'p';
            }
        }

        // Add event listeners for toolbar state
        document.addEventListener('DOMContentLoaded', () => {
            const content = document.getElementById('articleContent');
            content.addEventListener('mouseup', checkToolbarState);
            content.addEventListener('keyup', checkToolbarState);
            content.addEventListener('click', checkToolbarState);
        });

        function applyHeading(tag) {
            const editor = document.getElementById('articleContent');
            const selection = window.getSelection();
            const select = document.getElementById('headingSelect');

            if (!selection.rangeCount || selection.isCollapsed) {
                // No selection - use default behavior
                document.execCommand('formatBlock', false, tag);
                editor.focus();
                select.value = 'p'; // Reset dropdown
                checkToolbarState();
                return;
            }

            const range = selection.getRangeAt(0);

            // Check if selection is within editor
            if (!editor.contains(range.commonAncestorContainer)) {
                select.value = 'p';
                return;
            }

            // Wrap selected text in the heading tag
            const element = document.createElement(tag);
            try {
                const contents = range.extractContents();
                element.appendChild(contents);
                range.insertNode(element);
                selection.removeAllRanges();
            } catch (e) {
                console.error('Heading error:', e);
                // Fallback to default behavior
                document.execCommand('formatBlock', false, tag);
            }

            select.value = 'p'; // Reset dropdown
            editor.focus();
            updatePreview();
            checkToolbarState();
        }

        function insertList(type) {
            const command = type === 'ul' ? 'insertUnorderedList' : 'insertOrderedList';
            document.execCommand(command, false, null);
            document.getElementById('articleContent').focus();
            updatePreview();
        }

        function insertLink() {
            const editor = document.getElementById('articleContent');
            const selection = window.getSelection();
            let selectedText = '';
            let savedRange = null;

            if (selection.rangeCount > 0 && !selection.isCollapsed) {
                savedRange = selection.getRangeAt(0).cloneRange();
                selectedText = selection.toString();
            }

            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.innerHTML = `
                <div style="background:var(--surface-color);border-radius:12px;padding:1.5rem;max-width:400px;width:90%;border:1px solid rgba(255,255,255,0.1);">
                    <h3 style="margin-bottom:1rem;color:var(--text-main);">Vložit odkaz</h3>
                    <div style="margin-bottom:1rem;">
                        <label style="display:block;margin-bottom:0.3rem;color:var(--text-muted);font-size:0.85rem;">URL *</label>
                        <input type="url" id="linkUrl" placeholder="https://..." 
                            style="width:100%;padding:0.5rem;border-radius:6px;border:1px solid rgba(255,255,255,0.2);background:var(--bg-color);color:var(--text-main);box-sizing:border-box;">
                    </div>
                    <div style="margin-bottom:1rem;">
                        <label style="display:block;margin-bottom:0.3rem;color:var(--text-muted);font-size:0.85rem;">Text odkazu</label>
                        <input type="text" id="linkText" value="${selectedText}" placeholder="Zobrazovaný text" 
                            style="width:100%;padding:0.5rem;border-radius:6px;border:1px solid rgba(255,255,255,0.2);background:var(--bg-color);color:var(--text-main);box-sizing:border-box;">
                    </div>
                    <div style="margin-bottom:1rem;">
                        <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;color:var(--text-muted);font-size:0.85rem;">
                            <input type="checkbox" id="linkNewTab" checked style="width:auto;">
                            Otevřít v novém okně
                        </label>
                    </div>
                    <div style="display:flex;gap:0.5rem;justify-content:flex-end;">
                        <button id="linkCancel" style="padding:0.5rem 1rem;border-radius:6px;border:1px solid rgba(255,255,255,0.2);background:transparent;color:var(--text-muted);cursor:pointer;">Zrušit</button>
                        <button id="linkInsert" style="padding:0.5rem 1rem;border-radius:6px;border:none;background:var(--primary-color);color:#000;font-weight:600;cursor:pointer;">Vložit</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            const urlInput = modal.querySelector('#linkUrl');
            const textInput = modal.querySelector('#linkText');
            const newTabCheck = modal.querySelector('#linkNewTab');

            urlInput.focus();

            modal.querySelector('#linkCancel').onclick = () => modal.remove();
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            modal.querySelector('#linkInsert').onclick = () => {
                const url = urlInput.value.trim();
                const text = textInput.value.trim() || url;
                const newTab = newTabCheck.checked;

                if (!url) {
                    urlInput.style.borderColor = '#f87171';
                    return;
                }

                // Restore selection if we had one
                if (savedRange) {
                    selection.removeAllRanges();
                    selection.addRange(savedRange);
                    savedRange.deleteContents();
                }

                // Create link element
                const a = document.createElement('a');
                a.href = url;
                a.textContent = text;
                if (newTab) {
                    a.target = '_blank';
                    a.rel = 'noopener noreferrer';
                }

                // Insert at cursor or selection
                const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : document.createRange();
                if (!editor.contains(range.commonAncestorContainer)) {
                    editor.appendChild(a);
                    editor.appendChild(document.createTextNode(' '));
                } else {
                    range.insertNode(a);
                    // Add space after and move cursor
                    const space = document.createTextNode(' ');
                    a.parentNode.insertBefore(space, a.nextSibling);
                    range.setStartAfter(space);
                    range.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }

                modal.remove();
                editor.focus();
                updatePreview();
            };

            // Enter to submit
            urlInput.onkeydown = textInput.onkeydown = (e) => {
                if (e.key === 'Enter') modal.querySelector('#linkInsert').click();
                if (e.key === 'Escape') modal.remove();
            };
        }

        function insertCollapsibleBlock() {
            const id = 'collapse_' + Date.now();
            const iconId = 'icon_' + Date.now();

            // Note: Wrapper is contenteditable=false to allow onclick events to fire
            // Children are contenteditable=true to allow editing text
            const html = `
                <div class="collapsible-wrapper" contenteditable="false" style="user-select: none;">
                    <div class="collapsible-header" onclick="toggleSection('${id}', '${iconId}')" style="cursor: pointer;">
                        <h3 contenteditable="true" style="cursor: text; user-select: text;">Nadpis sekce</h3>
                        <i id="${iconId}" class="fa-solid fa-chevron-down"></i>
                    </div>
                    <div id="${id}" class="collapsible-content hidden" contenteditable="true" style="cursor: text; user-select: text;">
                        <p>Zde napište obsah...</p>
                    </div>
                </div>
                <p><br></p>
            `;

            document.execCommand('insertHTML', false, html);
        }

        // Preview toggle logic (matches article.html)
        window.toggleSection = function (id, iconId) {
            const content = document.getElementById(id);
            const icon = document.getElementById(iconId);

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                if (icon) {
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                }
            } else {
                content.classList.add('hidden');
                if (icon) {
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                }
            }
        }

        function insertIntroBlock() {
            const content = document.getElementById('articleContent');
            const introHtml = `<div class="puzzle-section">
    <p style="font-size: 1.1rem; margin-bottom: 1rem;">
        🧩 <strong>Pozice z partie...</strong><br>
        Popis pozice nebo úkolu.<br>
        Najdete vítězný tah? ♟️
    </p>
</div>`;
            document.execCommand('insertHTML', false, introHtml);
            content.focus();
            updatePreview();
        }

        // Image insertion with modal
        let selectedImage = null;
        let savedRange = null;

        function insertImage() {
            // Save current selection/cursor position
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                savedRange = sel.getRangeAt(0).cloneRange();
            }
            showImageModal();
        }

        function showImageModal(existingImg = null) {
            selectedImage = existingImg;

            // Create modal
            let modal = document.getElementById('imageModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'imageModal';
                modal.innerHTML = `
                    <div class="modal-overlay" onclick="closeImageModal()"></div>
                    <div class="modal-content">
                        <h3 style="margin-bottom: 1rem;">${existingImg ? 'Upravit obrázek' : 'Vložit obrázek'}</h3>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <input type="text" id="imgUrlInput" placeholder="URL obrázku" style="flex: 1;">
                            <button type="button" class="btn-secondary" onclick="document.getElementById('imgFileInput').click()">
                                <i class="fa-solid fa-upload"></i> Nahrát
                            </button>
                            <input type="file" id="imgFileInput" accept="image/*" style="display: none;" onchange="handleImageFile(event)">
                        </div>
                        <div id="imgPreviewArea" style="text-align: center; margin-bottom: 1rem; min-height: 100px; border: 1px dashed rgba(255,255,255,0.2); border-radius: 8px; padding: 1rem;">
                            <p style="color: var(--text-muted);">Náhled obrázku</p>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem;">Zarovnání</label>
                                <select id="imgAlign" style="width: 100%; margin-top: 0.25rem;">
                                    <option value="center">Na střed</option>
                                    <option value="left">Vlevo</option>
                                    <option value="right">Vpravo</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem;">Velikost</label>
                                <select id="imgSize" style="width: 100%; margin-top: 0.25rem;">
                                    <option value="100%">Plná šířka</option>
                                    <option value="75%">75%</option>
                                    <option value="50%">50%</option>
                                    <option value="320px">Malá (320px)</option>
                                    <option value="200px">Mini (200px)</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            ${existingImg ? '<button type="button" class="btn-danger" onclick="deleteImage()"><i class="fa-solid fa-trash"></i> Smazat</button>' : ''}
                            <button type="button" class="btn-secondary" onclick="closeImageModal()">Zrušit</button>
                            <button type="button" class="btn-primary" onclick="applyImage()">Použít</button>
                        </div>
                    </div>
                `;
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 2000; display: flex; align-items: center; justify-content: center;';
                document.body.appendChild(modal);

                // Add modal styles if not present
                if (!document.getElementById('imageModalStyles')) {
                    const style = document.createElement('style');
                    style.id = 'imageModalStyles';
                    style.textContent = `
                        #imageModal .modal-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); }
                        #imageModal .modal-content { position: relative; background: var(--surface-color); padding: 1.5rem; border-radius: var(--border-radius); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
                        #imageModal select, #imageModal input[type="text"] { background: var(--background-color); color: var(--text-main); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; padding: 0.5rem; }
                        #imageModal .btn-danger { background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }
                        #imageModal #imgPreviewArea img { max-width: 100%; max-height: 200px; border-radius: 4px; }
                    `;
                    document.head.appendChild(style);
                }
            } else {
                modal.style.display = 'flex';
                modal.querySelector('h3').textContent = existingImg ? 'Upravit obrázek' : 'Vložit obrázek';
            }

            // If editing existing image
            if (existingImg) {
                document.getElementById('imgUrlInput').value = existingImg.src;
                document.getElementById('imgPreviewArea').innerHTML = `<img src="${existingImg.src}">`;

                // Parse current styles
                const style = existingImg.style;
                if (style.marginLeft === 'auto' && style.marginRight === 'auto') {
                    document.getElementById('imgAlign').value = 'center';
                } else if (style.float === 'left') {
                    document.getElementById('imgAlign').value = 'left';
                } else if (style.float === 'right') {
                    document.getElementById('imgAlign').value = 'right';
                }

                document.getElementById('imgSize').value = style.maxWidth || '100%';
            } else {
                document.getElementById('imgUrlInput').value = '';
                document.getElementById('imgPreviewArea').innerHTML = '<p style="color: var(--text-muted);">Náhled obrázku</p>';
            }
        }

        function handleImageFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('imgUrlInput').value = e.target.result;
                document.getElementById('imgPreviewArea').innerHTML = `<img src="${e.target.result}">`;
            };
            reader.readAsDataURL(file);
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) modal.style.display = 'none';
            selectedImage = null;
            savedRange = null;
        }

        function applyImage() {
            const url = document.getElementById('imgUrlInput').value;
            if (!url) return closeImageModal();

            const align = document.getElementById('imgAlign').value;
            const size = document.getElementById('imgSize').value;

            let style = `max-width: ${size}; border-radius: 8px; cursor: pointer;`;
            if (align === 'center') {
                style += ' display: block; margin: 1rem auto;';
            } else if (align === 'left') {
                style += ' float: left; margin: 0 1rem 1rem 0;';
            } else if (align === 'right') {
                style += ' float: right; margin: 0 0 1rem 1rem;';
            }

            if (selectedImage) {
                // Update existing image
                selectedImage.src = url;
                selectedImage.style.cssText = style;
            } else {
                // Create new image element
                const img = document.createElement('img');
                img.src = url;
                img.alt = 'Obrázek';
                img.style.cssText = style;

                const content = document.getElementById('articleContent');

                // Insert at saved position or at end
                if (savedRange) {
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(savedRange);
                    savedRange.insertNode(img);
                    savedRange.collapse(false);
                } else {
                    content.appendChild(img);
                }
            }

            updatePreview();
            closeImageModal();
        }

        function deleteImage() {
            if (selectedImage) {
                selectedImage.remove();
                updatePreview();
            }
            closeImageModal();
        }

        // Click handler for images in editor
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('articleContent').addEventListener('click', (e) => {
                if (e.target.tagName === 'IMG') {
                    e.preventDefault();
                    showImageModal(e.target);
                }
            });
        });

        // Games Management
        function toggleGamesInput() {
            document.getElementById('gamesInputPanel').classList.toggle('hidden');
        }

        function addGame() {
            const title = document.getElementById('gameTitle').value.trim();
            const gameId = document.getElementById('gameId').value.trim();
            const commented = document.getElementById('gameCommented').checked;

            if (!title || !gameId) return;

            games.push({
                type: 'game',
                title,
                gameId,
                commented,
                src: `https://www.chess.com/emboard?id=${gameId}`
            });

            renderGames();
            document.getElementById('gameTitle').value = '';
            document.getElementById('gameId').value = '';
            document.getElementById('gameCommented').checked = false;
        }

        function addHeader() {
            const title = document.getElementById('headerTitle').value.trim();
            if (!title) return;

            games.push({
                type: 'header',
                title
            });

            renderGames();
            document.getElementById('headerTitle').value = '';
        }

        function removeGame(index) {
            games.splice(index, 1);
            renderGames();
        }

        function renderGames() {
            const container = document.getElementById('gamesList');
            if (games.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 0.85rem;">Žádné položky</p>';
                return;
            }

            container.innerHTML = `
                <div class="games-list-draggable">
                    ${games.map((item, index) => {
                if (item.type === 'header' || item.isHeader) { // Support both new and potential legacy flags
                    return `
                                <div class="game-item header-item" draggable="true" data-index="${index}" style="background: rgba(212, 175, 55, 0.1); border-left: 3px solid var(--primary-color);">
                                    <span class="drag-handle"><i class="fa-solid fa-grip-vertical"></i></span>
                                    <div style="flex: 1; display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fa-solid fa-heading" style="color: var(--primary-color);"></i>
                                        <input type="text" class="game-title-input" value="${escapeHtml(item.title)}" 
                                               onchange="updateGameTitle(${index}, this.value)" style="font-weight: bold;">
                                    </div>
                                    <div class="game-actions">
                                        <button class="action-btn btn-delete" onclick="removeGame(${index})">
                                            <i class="fa-solid fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                } else {
                    // Regular Game
                    // Handle legacy 'team' property if present by ignoring it visually but keeping data if needed?
                    // Actually user wants to effectively flatten it.
                    return `
                                <div class="game-item" draggable="true" data-index="${index}">
                                    <span class="drag-handle"><i class="fa-solid fa-grip-vertical"></i></span>
                                    <div class="game-inputs">
                                        <input type="text" class="game-title-input" value="${escapeHtml(item.title)}" 
                                               onchange="updateGameTitle(${index}, this.value)" placeholder="Název partie">
                                        <input type="text" class="game-id-input" value="${item.gameId || ''}" 
                                               onchange="updateGameId(${index}, this.value)" placeholder="ID">
                                    </div>
                                    <div class="game-actions">
                                        <label style="display: flex; align-items: center; cursor: pointer;" title="Komentovaná">
                                            <input type="checkbox" ${item.commented ? 'checked' : ''} 
                                                   onchange="toggleGameCommented(${index}, this.checked)" 
                                                   style="width: auto; margin: 0;">
                                            <i class="fa-regular fa-comment-dots"></i>
                                        </label>
                                        <button class="action-btn btn-delete" onclick="removeGame(${index})">
                                            <i class="fa-solid fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                }
            }).join('')}
                </div>
            `;

            initDragAndDrop();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateGameTitle(index, newTitle) {
            games[index].title = newTitle;
            updatePreview();
        }

        function updateGameId(index, newId) {
            games[index].gameId = newId;
            games[index].src = `https://www.chess.com/emboard?id=${newId}`;
            // If dragging, we might lose focus if we re-render whole section, 
            // but updatePreview helps right sidebar.
            // renderGames(); <- Don't re-render entire list on keypress, it kills focus!
            updatePreview();
        }

        // Drag and Drop
        let draggedItem = null;
        let draggedIndex = null;

        function initDragAndDrop() {
            const items = document.querySelectorAll('.game-item[draggable="true"]');

            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragleave', handleDragLeave);
                item.addEventListener('drop', handleDrop);
            });
        }

        function handleDragStart(e) {
            draggedItem = this;
            draggedIndex = parseInt(this.dataset.index);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedIndex);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.game-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedItem = null;
            draggedIndex = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            if (this !== draggedItem) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            if (this === draggedItem) return;

            const fromIndex = draggedIndex;
            const toIndex = parseInt(this.dataset.index);
            const targetTeam = this.dataset.team;

            if (fromIndex === toIndex) return;

            // Reorder the games array
            const [movedGame] = games.splice(fromIndex, 1);

            // Update team if dropped in different team section
            movedGame.team = targetTeam;

            // Calculate new position
            let newIndex = toIndex;
            if (fromIndex < toIndex) {
                newIndex = toIndex;
            }

            games.splice(newIndex, 0, movedGame);

            renderGames();
        }

        function toggleGameCommented(index, checked) {
            games[index].commented = checked;
        }

        // Gallery
        function toggleGalleryUrlInput() {
            document.getElementById('galleryUrlInput').classList.toggle('hidden');
        }

        function addGalleryFromUrl() {
            const url = document.getElementById('galleryImageUrl').value.trim();
            if (url) {
                galleryImages.push(url);
                renderGallery();
                document.getElementById('galleryImageUrl').value = '';
            }
        }

        async function addGalleryImages(event) {
            for (const file of event.target.files) {
                const formData = new FormData();
                formData.append('image', file);
                try {
                    const res = await fetch(`${API_URL}/images/upload`, { method: 'POST', headers: { 'Authorization': `Bearer ${authToken}` }, body: formData });
                    if (res.ok) {
                        const data = await res.json();
                        galleryImages.push(`http://localhost:3001${data.url}`);
                        renderGallery();
                    }
                } catch (e) { console.error(e); }
            }
        }

        function removeGalleryImage(index) { galleryImages.splice(index, 1); renderGallery(); }

        function renderGallery() {
            document.getElementById('galleryPreview').innerHTML = galleryImages.length ? galleryImages.map((img, i) => `
                <div style="position: relative;">
                    <img src="${img}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;">
                    <button onclick="removeGalleryImage(${i})" style="position: absolute; top: -5px; right: -5px; background: #dc2626; border: none; color: white; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; font-size: 10px;">×</button>
                </div>
            `).join('') : '<p style="color: var(--text-muted); font-size: 0.85rem;">Žádné obrázky</p>';
        }

        // Users
        async function loadUsers() {
            try {
                const res = await fetch(`${API_URL}/users`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                const users = await res.json();
                document.getElementById('usersTableBody').innerHTML = users.map(u => `
                    <tr><td>${u.username}</td><td>${u.email}</td><td>${u.role}</td><td>${u.id !== currentUser.id ? `<button class="action-btn btn-delete" onclick="deleteUser(${u.id})"><i class="fa-solid fa-trash"></i></button>` : ''}</td></tr>
                `).join('');
            } catch (e) { console.error(e); }
        }

        async function createUser() {
            try {
                const res = await fetch(`${API_URL}/users`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` }, body: JSON.stringify({ username: document.getElementById('newUsername').value, email: document.getElementById('newEmail').value, password: document.getElementById('newPassword').value, role: document.getElementById('newRole').value }) });
                if (res.ok) { showAlert('Uživatel vytvořen', 'success'); loadUsers(); document.getElementById('newUsername').value = ''; document.getElementById('newEmail').value = ''; document.getElementById('newPassword').value = ''; }
            } catch (e) { console.error(e); }
        }

        async function deleteUser(id) {
            if (!confirm('Smazat uživatele?')) return;
            await fetch(`${API_URL}/users/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${authToken}` } });
            loadUsers();
        }

        // Messages (Vzkazovník)
        const CLUB_PASSWORD = 'gambitjbc';

        async function loadAdminMessages() {
            try {
                const res = await fetch(`${API_URL}/messages`, { headers: { 'X-Club-Password': CLUB_PASSWORD } });
                const messages = await res.json();
                const tbody = document.getElementById('messagesTableBody');
                const noInfo = document.getElementById('noMessagesInfo');

                if (messages.length === 0) {
                    tbody.innerHTML = '';
                    noInfo.style.display = 'block';
                } else {
                    noInfo.style.display = 'none';
                    tbody.innerHTML = messages.map(m => `
                        <tr>
                            <td><strong>${escapeHtml(m.author)}</strong></td>
                            <td style="max-width: 400px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(m.content)}</td>
                            <td>${new Date(m.createdAt).toLocaleString('cs-CZ')}</td>
                            <td><button class="action-btn btn-delete" onclick="deleteAdminMessage(${m.id})"><i class="fa-solid fa-trash"></i></button></td>
                        </tr>
                    `).join('');
                }
            } catch (e) { console.error(e); }
        }

        async function deleteAdminMessage(id) {
            if (!confirm('Opravdu smazat tento vzkaz?')) return;
            try {
                await fetch(`${API_URL}/messages/${id}`, { method: 'DELETE', headers: { 'X-Club-Password': CLUB_PASSWORD } });
                showAlert('Vzkaz smazán', 'success');
                loadAdminMessages();
            } catch (e) { console.error(e); showAlert('Chyba při mazání', 'error'); }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Delete News (for superadmin)
        async function deleteNews(id) {
            if (!confirm('Opravdu smazat tento článek? Tato akce je nevratná!')) return;
            try {
                const res = await fetch(`${API_URL}/news/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${authToken}` } });
                if (res.ok) {
                    showAlert('Článek smazán', 'success');
                    loadDashboard();
                } else {
                    showAlert('Chyba při mazání článku', 'error');
                }
            } catch (e) { console.error(e); showAlert('Chyba spojení', 'error'); }
        }

        // Auth
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const res = await fetch(`${API_URL}/auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: document.getElementById('username').value, password: document.getElementById('password').value }) });
                if (res.ok) { const data = await res.json(); authToken = data.token; currentUser = data.user; localStorage.setItem('authToken', authToken); showAdmin(); }
                else { document.getElementById('loginError').innerHTML = '<div class="alert alert-error">Chybné údaje</div>'; }
            } catch (e) { document.getElementById('loginError').innerHTML = '<div class="alert alert-error">Chyba spojení</div>'; }
        });

        // Password Toggle
        const togglePassword = document.querySelector('#togglePassword');
        const password = document.querySelector('#password');
        togglePassword.addEventListener('click', function () {
            const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
            password.setAttribute('type', type);
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });

        function logout() { localStorage.removeItem('authToken'); location.reload(); }
        function showAlert(msg, type) { const div = document.createElement('div'); div.className = `alert alert-${type}`; div.textContent = msg; document.getElementById('alertContainer').appendChild(div); setTimeout(() => div.remove(), 3000); }

        // Update standings from chess.cz
        async function updateStandings() {
            const btn = document.getElementById('updateStandingsBtn');
            const resultDiv = document.getElementById('standingsResult');

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Načítám...';
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p style="color: var(--text-muted);">Stahují se data ze soutěží...</p>';

            try {
                const res = await fetch(`${API_URL}/standings/update`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (res.ok) {
                    const data = await res.json();

                    const youthComps = data.standings.filter(c => c.category === 'youth');
                    const teamComps = data.standings.filter(c => c.category === 'teams');

                    const renderGroup = (title, comps, color) => {
                        if (comps.length === 0) return '';
                        let html = `<h3 style="grid-column: 1/-1; color: ${color}; margin-top: 1rem; border-bottom: 2px solid ${color}; padding-bottom: 0.5rem;">${title}</h3>`;

                        for (const comp of comps) {
                            html += `
                                <div style="background: var(--card-bg); padding: 1rem; border-radius: 8px;">
                                    <h4 style="margin: 0 0 0.5rem 0; color: var(--primary-color);">${comp.name}</h4>
                                    ${comp.error ? `<p style="color: #fca5a5;">Chyba: ${comp.error}</p>` :
                                    comp.standings.length > 0 ? `
                                            <table style="width: 100%; font-size: 0.85rem;">
                                                <tr style="color: var(--text-muted);">
                                                    <th style="text-align: left; padding: 0.25rem;">#</th>
                                                    <th style="text-align: left; padding: 0.25rem;">Družstvo</th>
                                                </tr>
                                                ${comp.standings.map(s => `
                                                    <tr style="${s.isBizuterie ? 'background: rgba(212, 175, 55, 0.2);' : ''}">
                                                        <td style="padding: 0.25rem;">${s.rank}</td>
                                                        <td style="padding: 0.25rem;">${s.isBizuterie ? '<strong>' + s.team + '</strong>' : s.team}</td>
                                                    </tr>
                                                `).join('')}
                                            </table>
                                        ` : '<p style="color: var(--text-muted);">Žádná data</p>'
                                }
                                </div>`;
                        }
                        return html;
                    };

                    let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">';

                    html += renderGroup('Mládež', youthComps, '#4ade80'); // Green
                    html += renderGroup('Soutěže družstev', teamComps, '#60a5fa'); // Blue

                    if (youthComps.length === 0 && teamComps.length === 0 && data.standings.length > 0) {
                        // Fallback if no categories matched (legacy)
                        html += renderGroup('Ostatní', data.standings, '#9ca3af');
                    }

                    html += '</div>';
                    html += '<p style="margin-top: 1rem; color: var(--text-muted); font-size: 0.85rem;"><i class="fa-solid fa-check" style="color: #86efac;"></i> Aktualizováno. Zkopírujte výsledky do youth.html ručně.</p>';

                    resultDiv.innerHTML = html;
                    showAlert('Aktualizováno', 'success');
                } else {
                    throw new Error('Server error');
                }
            } catch (e) {
                resultDiv.innerHTML = '<p style="color: #fca5a5;"><i class="fa-solid fa-exclamation-triangle"></i> Nepodařilo se načíst tabulky</p>';
                showAlert('Chyba při načítání tabulek', 'error');
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-sync"></i> Aktualizovat tabulky';
        }


        // Load competition sources
        async function loadCompetitions() {
            try {
                const res = await fetch(`${API_URL}/competitions`);
                const competitions = await res.json();
                const container = document.getElementById('competitionsList');

                container.innerHTML = competitions.map(c => `
            <div style="background: rgba(255, 255, 255, 0.05); padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
                <div style="flex: 1; overflow: hidden;">
                    <strong style="display: block; font-size: 0.9rem; color: var(--primary-color);">${c.name}</strong>
                    <div style="font-size: 0.8rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${c.url}">
                        ${c.url}
                    </div>
                </div>
                <button class="btn-secondary btn-small" onclick="changeSourceUrl('${c.id}', '${escapeHtml(c.url)}')" title="Změnit zdroj">
                    <i class="fa-solid fa-pen"></i> Změnit
                </button>
            </div>
        `).join('');
            } catch (e) {
                console.error('Error loading competitions:', e);
            }
        }

        async function changeSourceUrl(id, currentUrl) {
            const newUrl = prompt('Zadejte nové URL pro zdroj dat:', currentUrl);
            if (newUrl && newUrl !== currentUrl) {
                try {
                    const res = await fetch(`${API_URL}/competitions/${id}/url`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ url: newUrl })
                    });

                    if (res.ok) {
                        showAlert('Zdroj aktualizován', 'success');
                        loadCompetitions();
                    } else {
                        showAlert('Chyba při aktualizaci', 'error');
                    }
                } catch (e) {
                    console.error(e);
                    showAlert('Chyba spojení', 'error');
                }
            }
        }


        async function handleImageUpload(event) {
            const file = event.target.files[0]; if (!file) return;
            const formData = new FormData(); formData.append('image', file);
            try { const res = await fetch(`${API_URL}/images/upload`, { method: 'POST', headers: { 'Authorization': `Bearer ${authToken}` }, body: formData }); if (res.ok) { const data = await res.json(); uploadedImageData = `http://localhost:3001${data.url}`; displayImage(uploadedImageData); } } catch (e) { console.error(e); }
        }

        function handleImageUrl() { const url = document.getElementById('imageUrl').value; if (url) { uploadedImageData = url; displayImage(url); } }
        function displayImage(src) { document.getElementById('uploadArea').classList.add('has-image'); document.getElementById('uploadPlaceholder').style.display = 'none'; const img = document.getElementById('uploadedImage'); img.src = src; img.style.display = 'block'; document.getElementById('previewImage').innerHTML = `<img src="${src}">`; }
        function updatePreview() {
            document.getElementById('previewTitle').textContent = document.getElementById('newsTitle').value || 'Nadpis';
            document.getElementById('previewCategory').textContent = document.getElementById('newsCategory').value;
            document.getElementById('previewExcerpt').textContent = document.getElementById('newsExcerpt').value || 'Krátký popis...';
            const date = document.getElementById('newsDate').value;
            document.getElementById('previewDate').textContent = date ? new Date(date).toLocaleDateString('cs-CZ') : 'Datum';

            // Render full article preview - content is now directly from editor
            const articlePreview = document.getElementById('articlePreview');
            const title = document.getElementById('newsTitle').value || 'Nadpis článku';
            const content = document.getElementById('articleContent').innerHTML;

            let html = `<h1 style="font-size: 1.5rem; margin-bottom: 1rem; color: var(--primary-color);">${title}</h1>`;

            // Main content directly from editor
            if (content && content !== '<br>') {
                html += `<div style="font-size: 0.95rem; line-height: 1.6;">${content}</div>`;
            }

            // Games list preview
            if (games.length > 0) {
                html += `<div style="background: var(--card-bg); border-radius: var(--border-radius); padding: 1rem; margin-top: 1rem; border: 1px solid rgba(255,255,255,0.1);">
                    <h3 style="font-size: 1rem; margin-bottom: 0.75rem;"><i class="fa-solid fa-chess-board"></i> Přehrávač partií (${games.length})</h3>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        ${games.map(g => `<li style="padding: 0.25rem 0; font-size: 0.85rem; color: var(--text-muted);">${g.title} ${g.commented ? '💬' : ''}</li>`).join('')}
                    </ul>
                </div>`;
            }

            articlePreview.innerHTML = html || '<p style="color: var(--text-muted); text-align: center;">Začněte psát obsah...</p>';
        }

        let previewExpanded = false;
        function toggleFullPreview() {
            const preview = document.getElementById('articlePreview');
            previewExpanded = !previewExpanded;

            if (previewExpanded) {
                // Create overlay
                const overlay = document.createElement('div');
                overlay.id = 'previewOverlay';
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 999;';
                overlay.onclick = toggleFullPreview;
                document.body.appendChild(overlay);

                // Expand preview
                preview.style.cssText = `
                    position: fixed !important;
                    top: 50% !important;
                    left: 50% !important;
                    transform: translate(-50%, -50%) !important;
                    width: 90% !important;
                    max-width: 900px !important;
                    height: 80vh !important;
                    max-height: none !important;
                    z-index: 1000 !important;
                    overflow-y: auto !important;
                    background: var(--card-bg) !important;
                    border-radius: var(--border-radius) !important;
                    padding: 2rem !important;
                    box-shadow: 0 0 50px rgba(0,0,0,0.5) !important;
                `;
            } else {
                // Remove overlay
                const overlay = document.getElementById('previewOverlay');
                if (overlay) overlay.remove();

                // Reset preview
                preview.style.cssText = 'padding: 1rem; max-height: 400px; overflow-y: auto; background: var(--card-bg); border-radius: var(--border-radius);';
            }
        }

        // Members Management
        let allMembers = [];

        async function loadMembers() {
            try {
                const res = await fetch(`${API_URL}/members`);
                allMembers = await res.json();
                renderMembersTable();
            } catch (e) {
                console.error(e);
                showAlert('Chyba při načítání členů', 'error');
            }
        }

        function renderMembersTable() {
            const tbody = document.getElementById('membersTableBody');
            tbody.innerHTML = allMembers.map(m => `
                <tr>
                    <td><strong>${escapeHtml(m.firstName)} ${escapeHtml(m.lastName)}</strong></td>
                    <td>${escapeHtml(m.elo || '-')}</td>
                    <td>${escapeHtml(m.title || '-')}</td>
                    <td>${escapeHtml(m.birthYear || '-')}</td>
                    <td>${escapeHtml(m.role || '-')}</td>
                    <td>
                        <button class="action-btn btn-edit" onclick="editMember(${m.id})"><i class="fa-solid fa-edit"></i></button>
                        <button class="action-btn btn-delete" onclick="deleteMember(${m.id})"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function openMemberModal(member = null) {
            const modal = document.getElementById('memberModal');
            const title = document.getElementById('memberModalTitle');

            if (member) {
                title.textContent = 'Upravit člena';
                document.getElementById('memberId').value = member.id;
                document.getElementById('memberFirstName').value = member.firstName;
                document.getElementById('memberLastName').value = member.lastName;
                document.getElementById('memberElo').value = member.elo || '';
                document.getElementById('memberTitle').value = member.title || '';
                document.getElementById('memberBirthYear').value = member.birthYear || '';
                document.getElementById('memberRole').value = member.role || '';
            } else {
                title.textContent = 'Nový člen';
                document.getElementById('memberId').value = '';
                document.getElementById('memberFirstName').value = '';
                document.getElementById('memberLastName').value = '';
                document.getElementById('memberElo').value = '';
                document.getElementById('memberTitle').value = '';
                document.getElementById('memberBirthYear').value = '';
                document.getElementById('memberRole').value = '';
            }

            modal.style.display = 'flex';
        }

        function closeMemberModal() {
            document.getElementById('memberModal').style.display = 'none';
        }

        async function saveMember() {
            const id = document.getElementById('memberId').value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/members/${id}` : `${API_URL}/members`;

            const data = {
                firstName: document.getElementById('memberFirstName').value.trim(),
                lastName: document.getElementById('memberLastName').value.trim(),
                elo: document.getElementById('memberElo').value,
                title: document.getElementById('memberTitle').value,
                birthYear: document.getElementById('memberBirthYear').value,
                role: document.getElementById('memberRole').value
            };

            if (!data.firstName || !data.lastName) {
                alert('Jméno a příjmení jsou povinné.');
                return;
            }

            try {
                const res = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    showAlert('Uloženo!', 'success');
                    closeMemberModal();
                    loadMembers();
                } else {
                    showAlert('Chyba při ukládání', 'error');
                }
            } catch (e) {
                console.error(e);
                showAlert('Chyba spojení', 'error');
            }
        }

        function editMember(id) {
            const member = allMembers.find(m => m.id === id);
            if (member) openMemberModal(member);
        }

        async function deleteMember(id) {
            if (!confirm('Opravdu smazat tohoto člena?')) return;

            try {
                const res = await fetch(`${API_URL}/members/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (res.ok) {
                    showAlert('Smazáno!', 'success');
                    loadMembers();
                } else {
                    showAlert('Chyba při mazání', 'error');
                }
            } catch (e) {
                console.error(e);
                showAlert('Chyba spojení', 'error');
            }
        }
    </script>
</body>

</html>