<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Spr치va webu</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        :root {
            --editor-bg: #1e1e1e;
            --editor-border: rgba(255, 255, 255, 0.1);
        }

        .admin-container {
            max-width: 1800px;
            width: 100%;
            box-sizing: border-box;
            margin: 100px auto 2rem;
            padding: 0 2rem;
            overflow-x: hidden;
        }

        .login-container {
            max-width: 400px;
            margin: 150px auto;
            padding: 2rem;
            background: var(--surface-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--editor-border);
        }

        .admin-header {
            background: linear-gradient(135deg, #1f2937, #111827);
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            color: var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--primary-color);
        }

        /* Explicit Header Navigation Styles */
        #adminPanel header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #0f172a;
            /* Dark sleek background */
            z-index: 10000;
            padding: 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        #adminPanel nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1800px;
            margin: 0 auto;
            padding: 0.75rem 2rem;
        }

        #adminPanel .nav-links {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        #adminPanel .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #adminPanel .nav-links a {
            color: #e2e8f0;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
            font-size: 0.95rem;
        }

        #adminPanel .nav-links a:hover {
            color: var(--primary-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface-color);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--editor-border);
        }

        .data-table th {
            background: rgba(255, 255, 255, 0.05);
            color: var(--primary-color);
            font-weight: 600;
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-published {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        .status-draft {
            background: rgba(234, 179, 8, 0.2);
            color: #fde047;
        }

        .action-btn {
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            margin-right: 0.25rem;
            transition: all 0.2s;
        }

        .btn-edit {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
        }

        .btn-delete {
            background: rgba(220, 38, 38, 0.2);
            color: #fca5a5;
        }

        .btn-publish {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        .editor-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            min-height: 80vh;
        }

        .editor-main,
        .editor-sidebar {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--editor-border);
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--editor-border);
            border-radius: 6px;
            color: var(--text-color);
            font-family: inherit;
        }

        .wysiwyg-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--editor-border);
            border-radius: 6px 6px 0 0;
            border-bottom: none;
        }

        .wysiwyg-toolbar button {
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-color);
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .wysiwyg-toolbar button:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: var(--primary-color);
        }

        .wysiwyg-toolbar button.active {
            background: rgba(212, 175, 55, 0.4);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .wysiwyg-toolbar .divider {
            width: 1px;
            background: var(--editor-border);
            margin: 0 0.5rem;
        }

        .wysiwyg-content {
            min-height: 400px;
            padding: 1rem;
            background: var(--editor-bg);
            border: 1px solid var(--editor-border);
            border-radius: 0 0 6px 6px;
            color: var(--text-color);
            line-height: 1.6;
            outline: none;
            overflow-y: auto;
        }

        .wysiwyg-content:focus {
            border-color: var(--primary-color);
        }

        .highlight-name {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(147, 51, 234, 0.3));
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .highlight-score {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(16, 185, 129, 0.3));
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            font-weight: 700;
        }

        .wysiwyg-content a {
            color: #60a5fa;
            text-decoration: underline;
            text-underline-offset: 2px;
            cursor: pointer;
        }

        .wysiwyg-content a::after {
            content: ' 游댕';
            font-size: 0.7em;
        }

        .wysiwyg-content a:hover {
            color: #93c5fd;
        }

        .preview-card {
            margin-bottom: 1.5rem;
        }

        .preview-title {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        .news-preview {
            background: var(--editor-bg);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--editor-border);
        }

        .preview-image {
            height: 180px;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .preview-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-upload {
            border: 2px dashed var(--editor-border);
            border-radius: 6px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload:hover {
            border-color: var(--primary-color);
            background: rgba(212, 175, 55, 0.05);
        }

        .image-upload.has-image {
            padding: 0;
            border: none;
        }

        .uploaded-thumb {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 6px;
        }

        /* Styles for content blocks in editor */
        .wysiwyg-content .puzzle-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid var(--primary-color);
        }

        .wysiwyg-content .puzzle-section img {
            max-width: 320px;
            margin: 1rem auto;
            display: block;
        }

        .wysiwyg-content .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .wysiwyg-content .card-content {
            padding: 1.5rem;
        }

        #articlePreview .puzzle-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid var(--primary-color);
        }

        #articlePreview .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin: 1rem 0;
        }

        #articlePreview .card-content {
            padding: 1.5rem;
        }

        .panel-section {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            border: 1px solid var(--editor-border);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .game-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 4px;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            cursor: grab;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .game-item:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .game-item.dragging {
            opacity: 0.5;
            background: rgba(212, 175, 55, 0.2);
            border: 1px dashed var(--primary-color);
        }

        .game-item.drag-over {
            border-top: 2px solid var(--primary-color);
        }

        .game-item .drag-handle {
            cursor: grab;
            color: var(--text-muted);
            margin-right: 0.75rem;
        }

        .game-item .game-inputs {
            display: flex;
            gap: 0.5rem;
            flex: 1;
        }

        .game-item .game-title-input {
            flex: 2;
            padding: 0.3rem 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--editor-border);
            border-radius: 4px;
            color: var(--text-color);
            font-size: 0.85rem;
        }

        .game-item .game-id-input {
            flex: 1;
            padding: 0.3rem 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--editor-border);
            border-radius: 4px;
            color: var(--text-color);
            font-size: 0.85rem;
            max-width: 120px;
        }

        .game-item .game-actions {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-left: 0.5rem;
        }

        .game-item .team-badge {
            font-size: 0.75rem;
            padding: 0.15rem 0.5rem;
            border-radius: 3px;
            margin-left: 0.5rem;
        }

        .team-checkbox-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .team-checkbox {
            display: flex;
            align-items: center;
            padding: 0.4rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .team-checkbox:hover {
            background: rgba(212, 175, 55, 0.1);
        }

        .team-checkbox input {
            margin-right: 0.5rem;
        }

        .team-checkbox.checked {
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid var(--primary-color);
        }

        .add-team-input {
            display: flex;
            gap: 0.5rem;
        }

        .add-team-input input {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.85rem;
        }

        .add-team-input button {
            padding: 0.5rem 0.75rem;
        }

        .admin-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--editor-border);
            padding-bottom: 1rem;
        }

        .nav-tab {
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            border-radius: 6px;
            color: var(--text-muted);
            transition: all 0.2s;
            font-size: 0.95rem;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
        }

        .nav-tab.active {
            background: var(--primary-color);
            color: var(--secondary-color);
            font-weight: 600;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--secondary-color);
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-color);
            padding: 0.75rem 1.5rem;
            border: 1px solid var(--editor-border);
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        .hidden {
            display: none !important;
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .alert-error {
            background: rgba(220, 38, 38, 0.1);
            color: #fca5a5;
        }

        .alert-success {
            background: rgba(34, 197, 94, 0.1);
            color: #86efac;
        }

        /* Tablet and smaller desktop */
        @media (max-width: 1200px) {
            .editor-layout {
                grid-template-columns: 1fr;
            }

            .editor-sidebar {
                order: 1;
                /* Put sidebar AFTER content on mobile */
                margin-top: 1rem;
            }
        }

        /* Tablet */
        @media (max-width: 992px) {
            .admin-container {
                padding: 1rem;
            }

            .admin-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
                padding: 1rem;
            }

            .admin-header h1 {
                font-size: 1.25rem !important;
            }

            .admin-nav {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                gap: 0.25rem;
                padding-bottom: 0.5rem;
            }

            .admin-nav::-webkit-scrollbar {
                display: none;
            }

            .nav-tab {
                white-space: nowrap;
                flex-shrink: 0;
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
            }

            .nav-tab i {
                display: none;
            }
        }

        /* Mobile */
        @media (max-width: 768px) {
            header nav {
                flex-direction: column;
                gap: 0.5rem;
            }

            header .nav-links {
                gap: 1rem;
                flex-direction: row;
                justify-content: center;
                flex-wrap: wrap;
            }

            .admin-header {
                padding: 0.75rem;
                border-radius: 8px;
                margin-bottom: 1rem;
            }

            .admin-header h1 {
                font-size: 1rem !important;
            }

            .admin-header p {
                font-size: 0.75rem !important;
            }

            header .nav-links a {
                padding: 0.5rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 4px;
            }

            .nav-tab {
                padding: 0.4rem 0.6rem;
                font-size: 0.7rem;
            }

            .form-group label {
                font-size: 0.8rem;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 0.85rem;
                padding: 0.5rem;
            }

            .btn-primary,
            .btn-secondary {
                font-size: 0.85rem;
                padding: 0.6rem 1rem;
            }

            .data-table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .data-table th,
            .data-table td {
                padding: 0.4rem 0.3rem;
                font-size: 0.7rem;
            }

            /* Title column can wrap */
            .data-table td:nth-child(2) {
                white-space: normal;
                word-break: break-word;
                max-width: 150px;
            }

            /* Other columns stay compact */
            .data-table td:nth-child(1),
            .data-table td:nth-child(5),
            .data-table td:nth-child(6) {
                white-space: nowrap;
            }

            .wysiwyg-toolbar {
                gap: 0.25rem;
                padding: 0.5rem;
            }

            .wysiwyg-toolbar button {
                padding: 0.4rem 0.5rem;
                font-size: 0.7rem;
            }

            .wysiwyg-content {
                min-height: 200px;
                font-size: 0.9rem;
            }

            .preview-card {
                margin-bottom: 0.75rem;
            }

            .panel-section {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }

            .panel-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }

        /* Small mobile */
        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }

            .admin-container {
                padding: 0.5rem;
            }

            .admin-header h1 {
                font-size: 0.9rem !important;
            }

            .nav-tab {
                padding: 0.35rem 0.5rem;
                font-size: 0.65rem;
            }

            .editor-sidebar {
                padding: 0.75rem;
            }

            .status-text {
                display: none;
            }

            .hide-mobile {
                display: none !important;
            }
        }

        /* Toast Notifications */
        #alertContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            width: auto;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        #alertContainer .alert {
            pointer-events: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease-out;
            margin: 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary-color);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }
    </style>
</head>

<body>
    <!-- LOGIN -->
    <div id="loginPage" class="hidden">
        <div class="login-container">
            <h1 style="text-align: center; margin-bottom: 2rem;">
                <i class="fa-solid fa-chess-knight" style="color: var(--primary-color);"></i><br>Admin Panel
            </h1>
            <div id="loginError"></div>
            <form id="loginForm">
                <div class="form-group"><label>U쬴vatelsk칠 jm칠no</label><input type="text" id="username" required></div>
                <div class="form-group"><label>Heslo</label>
                    <div style="position: relative;">
                        <input type="password" id="password" required style="padding-right: 40px;">
                        <i class="fa-solid fa-eye" id="togglePassword"
                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--text-muted);"></i>
                    </div>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%">P콏ihl치sit se</button>
            </form>
        </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="adminPanel" class="hidden">
        <header>
            <div class="container">
                <nav>
                    <a href="index.html" class="logo"><i class="fa-solid fa-chess-knight"></i> TJ Bi쬿terie - Admin</a>
                    <ul class="nav-links">
                        <li style="display: flex; align-items: center; margin-right: 1rem;">
                            <label class="switch" style="margin-bottom: 0;">
                                <input type="checkbox" id="maintenanceToggle" onchange="toggleMaintenance()">
                                <span class="slider round"></span>
                            </label>
                            <span style="font-size: 0.8rem; margin-left: 0.5rem; color: #aaa;">칔dr쬭a</span>
                        </li>
                        <li><a href="index.html" target="_blank"><i class="fa-solid fa-home"></i> Web</a></li>
                        <li><a href="#" onclick="logout()" style="color: #fca5a5;"><i
                                    class="fa-solid fa-sign-out-alt"></i> Odhl치sit</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <div class="admin-container">
            <div class="admin-header">
                <div>
                    <h1><i class="fa-solid fa-cogs"></i> Spr치va webu</h1>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; opacity: 0.8; visibility: visible !important;"
                        id="userInfo"></p>
                </div>
            </div>

            <div class="admin-nav">
                <div class="nav-tab active" onclick="switchTab('dashboard')"><i class="fa-solid fa-list"></i> P콏ehled
                </div>
                <div class="nav-tab" onclick="switchTab('editor'); resetEditor();"><i class="fa-solid fa-plus"></i> Nov치
                    novinka</div>
                <div class="nav-tab" onclick="switchTab('members')" style="display: none;"><i
                        class="fa-solid fa-address-book"></i> 캛lenov칠
                </div>
                <div class="nav-tab hidden" id="usersTab" onclick="switchTab('users')"><i class="fa-solid fa-users"></i>
                    U쬴vatel칠</div>
                <div class="nav-tab" id="messagesTab" onclick="switchTab('messages')"><i
                        class="fa-solid fa-comments"></i>
                    Vzkazovn칤k</div>
                <div class="nav-tab" id="blicakTab" onclick="switchTab('blicak')"><i class="fa-solid fa-bolt"></i>
                    V치no캜n칤 blesk</div>
                <div class="nav-tab" id="competitionsTab" onclick="switchTab('competitions')"><i
                        class="fa-solid fa-table"></i>
                    Tabulky dru쬽tva</div>
            </div>

            <div id="alertContainer"></div>

            <!-- DASHBOARD -->
            <div id="dashboardView">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="margin: 0;">Seznam novinek</h2>
                    <button class="btn-primary" onclick="switchTab('editor'); resetEditor();"><i
                            class="fa-solid fa-plus"></i> Nov치
                        novinka</button>
                </div>
                <table class="data-table" id="newsTable">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>N치zev</th>
                            <th class="hide-mobile">Kategorie</th>
                            <th class="hide-mobile">Autor</th>
                            <th class="hide-mobile">Stav</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody id="newsTableBody"></tbody>
                </table>
            </div>

            <!-- EDITOR -->
            <div id="editorView" class="hidden">
                <div class="editor-layout">
                    <!-- Main Editor (70%) -->
                    <div class="editor-main">
                        <h2 style="margin-top: 0;" id="editorTitle">Nov치 novinka</h2>
                        <input type="hidden" id="editNewsId">

                        <div class="form-group">
                            <label>Nadpis 캜l치nku *</label>
                            <input type="text" id="newsTitle" placeholder="Zadejte nadpis..." oninput="updatePreview()">
                        </div>

                        <!-- WYSIWYG Editor -->
                        <div class="form-group">
                            <label>Obsah 캜l치nku *</label>
                            <div class="wysiwyg-toolbar" style="flex-wrap: wrap;">
                                <!-- Row 1: Formatting -->
                                <button type="button" id="btnBold" onclick="formatText('bold')"
                                    title="Tu캜n캩 (Ctrl+B)"><i class="fa-solid fa-bold"></i></button>
                                <button type="button" id="btnItalic" onclick="formatText('italic')"
                                    title="Kurz칤va (Ctrl+I)"><i class="fa-solid fa-italic"></i></button>
                                <button type="button" id="btnUnderline" onclick="formatText('underline')"
                                    title="Podtr쬰n칤 (Ctrl+U)"><i class="fa-solid fa-underline"></i></button>
                                <div class="divider"></div>
                                <!-- Gallery Management Section -->
                                <div id="gallery-section" class="content-section" style="display: none;">
                                    <div class="header-actions">
                                        <h2><i class="fa-regular fa-images"></i> Spr치va Galerie</h2>
                                        <button class="primary-btn"
                                            onclick="document.getElementById('imageUploadInput').click()">
                                            <i class="fa-solid fa-cloud-arrow-up"></i> Nahr치t fotky
                                        </button>
                                        <input type="file" id="imageUploadInput" multiple accept="image/*"
                                            style="display: none;" onchange="handleAdminGalleryUpload(this)">
                                    </div>

                                    <div class="card" style="padding: 0;">
                                        <div style="overflow-x: auto;">
                                            <table class="data-table">
                                                <thead>
                                                    <tr>
                                                        <th>N치hled</th>
                                                        <th>N치zev</th>
                                                        <th>Datum nahr치n칤</th>
                                                        <th>Akce</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="galleryTableBody">
                                                    <tr>
                                                        <td colspan="4" style="text-align: center;">Na캜칤t치m...</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- Settings Section -->>
                                    <!-- Heading buttons -->
                                    <div
                                        style="display: flex; gap: 2px; background: rgba(255,255,255,0.05); border-radius: 4px; padding: 2px;">
                                        <button type="button" id="headingP" onclick="applyHeading('p')"
                                            title="Norm치ln칤 text"
                                            style="padding: 0.25rem 0.5rem; font-size: 0.7rem; font-weight: 600; border-radius: 3px; min-width: 28px;">P</button>
                                        <button type="button" id="headingH1" onclick="applyHeading('h1')"
                                            title="Nadpis 1"
                                            style="padding: 0.25rem 0.5rem; font-size: 0.7rem; font-weight: 700; border-radius: 3px; min-width: 28px;">H1</button>
                                        <button type="button" id="headingH2" onclick="applyHeading('h2')"
                                            title="Nadpis 2"
                                            style="padding: 0.25rem 0.5rem; font-size: 0.7rem; font-weight: 600; border-radius: 3px; min-width: 28px;">H2</button>
                                        <button type="button" id="headingH3" onclick="applyHeading('h3')"
                                            title="Nadpis 3"
                                            style="padding: 0.25rem 0.5rem; font-size: 0.7rem; font-weight: 500; border-radius: 3px; min-width: 28px;">H3</button>
                                    </div>
                                    <div class="divider"></div>
                                    <button type="button" onclick="insertLink()" title="Odkaz"><i
                                            class="fa-solid fa-link"></i></button>
                                    <button type="button" onclick="toggleSource()" title="HTML" id="btnSource"><i
                                            class="fa-solid fa-code"></i></button>

                                    <!-- Row 2: Highlights and blocks (will wrap on smaller screens) -->
                                    <div class="divider" style="height: 0; width: 100%; margin: 0.25rem 0;"></div>
                                    <button type="button" id="btnHighlightName" onmousedown="event.preventDefault()"
                                        onclick="insertHighlight('name')" title="Zv칳raznit jm칠no"
                                        style="color: #60a5fa;"><i class="fa-solid fa-user"></i> Jm칠no</button>
                                    <button type="button" id="btnHighlightScore" onmousedown="event.preventDefault()"
                                        onclick="insertHighlight('score')" title="Zv칳raznit sk칩re"
                                        style="color: #4ade80;"><i class="fa-solid fa-trophy"></i> Sk칩re</button>
                                    <div class="divider"></div>
                                    <button type="button" onclick="insertIntroBlock()" title="Puzzle blok"
                                        style="color: #fbbf24;"><i class="fa-solid fa-lightbulb"></i></button>
                                    <button type="button" onclick="insertImage()" title="Obr치zek"
                                        style="color: #f472b6;"><i class="fa-solid fa-image"></i></button>
                                    <button type="button" onclick="insertCollapsibleBlock()" title="Rozbalovac칤 sekce"
                                        style="color: #8b5cf6;"><i class="fa-solid fa-layer-group"></i></button>
                                </div>
                                <div class="wysiwyg-content" id="articleContent" contenteditable="true"
                                    oninput="updatePreview()"></div>
                                <textarea id="articleSource" class="wysiwyg-content hidden"
                                    oninput="updateContentFromSource()"></textarea>
                            </div>

                            <!-- Games Panel -->
                            <div class="panel-section">
                                <div class="panel-header">
                                    <label style="margin: 0;"><i class="fa-solid fa-chess-board"></i> P콏ehr치va캜
                                        parti칤</label>
                                </div>

                                <div class="form-group" id="gamesInputPanel">
                                    <div
                                        style="background: rgba(255, 255, 255, 0.05); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;">
                                        <h4
                                            style="margin-top: 0; margin-bottom: 0.5rem; color: var(--primary-color); font-size: 0.85rem;">
                                            P콏idat partii</h4>
                                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                                            <input type="text" id="gameTitle" placeholder="Kdo s k칳m"
                                                style="flex: 1; min-width: 120px; max-width: 180px; font-size: 0.8rem; padding: 0.4rem;">
                                            <input type="text" id="gameId" placeholder="Chess.com ID"
                                                style="width: 120px; font-size: 0.8rem; padding: 0.4rem;">
                                            <label
                                                style="display: flex; align-items: center; gap: 0.3rem; cursor: pointer; font-size: 0.75rem; white-space: nowrap;">
                                                <input type="checkbox" id="gameCommented"
                                                    style="width: auto; margin: 0;">
                                                Koment.
                                            </label>
                                            <button type="button" class="btn-primary btn-small" onclick="addGame()"
                                                style="padding: 0.4rem 0.6rem; font-size: 0.75rem; white-space: nowrap;">
                                                <i class="fa-solid fa-plus"></i> P콏idat
                                            </button>
                                        </div>
                                    </div>

                                    <div
                                        style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                        <h4 style="margin-top: 0; color: var(--primary-color);">P콏idat nadpis
                                            (odd캩lova캜)
                                        </h4>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <input type="text" id="headerTitle" placeholder="Nap콏. A t칳m, B t칳m...">
                                            <button type="button" class="btn-secondary btn-small" onclick="addHeader()">
                                                <i class="fa-solid fa-heading"></i> P콏idat
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div id="gamesList" style="margin-top: 1rem;"></div>
                            </div>

                            <!-- Gallery Panel -->
                            <div class="panel-section">
                                <div class="panel-header">
                                    <label style="margin: 0;"><i class="fa-solid fa-images"></i> Galerie</label>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button type="button" class="btn-secondary btn-small"
                                            onclick="document.getElementById('galleryInput').click()"><i
                                                class="fa-solid fa-upload"></i> Nahr치t</button>
                                        <button type="button" class="btn-secondary btn-small"
                                            onclick="toggleGalleryUrlInput()"><i class="fa-solid fa-link"></i>
                                            URL</button>
                                    </div>
                                    <input type="file" id="galleryInput" accept="image/*" multiple
                                        style="display: none;" onchange="addGalleryImages(event)">
                                </div>
                                <div id="galleryUrlInput" class="hidden" style="margin-bottom: 0.75rem;">
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="text" id="galleryImageUrl" placeholder="URL obr치zku (https://...)"
                                            style="flex: 1; font-size: 0.85rem;">
                                        <button type="button" class="btn-primary btn-small"
                                            onclick="addGalleryFromUrl()">P콏idat</button>
                                    </div>
                                </div>
                                <div id="galleryPreview" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
                            </div>

                            <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                                <button class="btn-primary" onclick="saveNews()"><i class="fa-solid fa-save"></i>
                                    Ulo쬴t</button>
                                <button class="btn-secondary" onclick="switchTab('dashboard')">Zru코it</button>
                            </div>
                        </div>

                        <!-- Sidebar (30%) -->
                        <div class="editor-sidebar">
                            <!-- SECTION 1: Publikace (collapsible) -->
                            <div id="publikaceSection"
                                style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <div onclick="toggleSidebarSection('publikace')"
                                    style="display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; margin-bottom: 0.75rem; color: var(--primary-color); cursor: pointer;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fa-solid fa-paper-plane"></i>
                                        <span style="font-weight: 600;">Publikace</span>
                                    </div>
                                    <i class="fa-solid fa-chevron-down" id="publikaceIcon"
                                        style="font-size: 0.7rem; transition: transform 0.2s;"></i>
                                </div>
                                <div id="publikaceContent">

                                    <div class="form-group" style="margin-bottom: 0.75rem;">
                                        <label style="font-size: 0.8rem;">Kategorie</label>
                                        <select id="newsCategory" onchange="updatePreview()"
                                            style="font-size: 0.85rem;">
                                            <option value="Sout캩쬰 dru쬽tev">Sout캩쬰 dru쬽tev</option>
                                            <option value="Odd칤lov칳 p콏ebor">Odd칤lov칳 p콏ebor</option>
                                            <option value="Ml치de">Ml치de</option>
                                            <option value="O n치s">O n치s</option>
                                        </select>
                                    </div>

                                    <div class="form-group" style="margin-bottom: 0.75rem;">
                                        <label style="font-size: 0.8rem;">Datum</label>
                                        <input type="date" id="newsDate" oninput="updatePreview()"
                                            style="font-size: 0.85rem;">
                                    </div>

                                    <div class="form-group" style="margin-bottom: 0.75rem;">
                                        <label style="font-size: 0.8rem;">Kr치tk칳 popis</label>
                                        <textarea id="newsExcerpt" rows="2" placeholder="Zobraz칤 se na kart캩..."
                                            oninput="updatePreview()" style="font-size: 0.85rem;"></textarea>
                                    </div>

                                    <label
                                        style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.85rem;">
                                        <input type="checkbox" id="publishCheck" style="width: auto;">
                                        <span>Publikovat ihned</span>
                                    </label>

                                    <button type="button" class="btn-primary" onclick="saveNews()"
                                        style="width: 100%; margin-top: 1rem; justify-content: center;">
                                        <i class="fa-solid fa-save"></i> Ulo쬴t
                                    </button>
                                </div><!-- end publikaceContent -->
                            </div><!-- end publikaceSection -->

                            <!-- SECTION 2: Obr치zek -->
                            <div
                                style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <div
                                    style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; color: #f472b6;">
                                    <i class="fa-solid fa-image"></i>
                                    <span style="font-weight: 600;">N치hledov칳 obr치zek</span>
                                </div>

                                <div class="image-upload" id="uploadArea"
                                    onclick="document.getElementById('imageInput').click()"
                                    style="height: 120px; margin-bottom: 0.5rem; position: relative;">
                                    <div id="uploadPlaceholder">
                                        <i class="fa-solid fa-cloud-upload-alt"
                                            style="font-size: 1.2rem; color: var(--primary-color);"></i>
                                        <p style="margin: 0.3rem 0 0 0; font-size: 0.75rem;">Klikn캩te pro nahr치n칤
                                        </p>
                                    </div>
                                    <img id="uploadedImage" class="uploaded-thumb" style="display: none;">
                                    <button type="button" id="removeImageBtn"
                                        onclick="event.stopPropagation(); removeImage();"
                                        style="display: none; position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); border: none; color: #f87171; padding: 0.3rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.7rem;">
                                        <i class="fa-solid fa-times"></i>
                                    </button>
                                </div>
                                <input type="file" id="imageInput" accept="image/*" style="display: none;"
                                    onchange="handleImageUpload(event)">

                                <div id="imageUrlWrapper" style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="text" id="imageUrl" placeholder="nebo URL obr치zku"
                                        style="font-size: 0.8rem; flex: 1;">
                                    <button type="button" class="btn-secondary btn-small" onclick="handleImageUrl()"
                                        style="padding: 0.4rem 0.6rem; font-size: 0.75rem;">Pou쮂셦</button>
                                </div>

                                <!-- Crop position selector -->
                                <div id="cropPositionWrapper" style="display: none; margin-top: 0.8rem;">
                                    <label
                                        style="font-size: 0.75rem; color: var(--text-muted); display: flex; justify-content: space-between; margin-bottom: 0.4rem;">
                                        <span>Pozice o콏ezu (v칳코ka):</span>
                                        <span id="cropValueLabel" style="color: var(--primary-color);">50%</span>
                                    </label>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="font-size: 0.7rem; color: var(--text-muted);">Horn칤</span>
                                        <input type="range" id="cropSlider" min="0" max="100" value="50" step="1"
                                            oninput="updateCropFromSlider(this.value)"
                                            style="flex: 1; cursor: pointer;">
                                        <span style="font-size: 0.7rem; color: var(--text-muted);">Doln칤</span>
                                    </div>
                                </div> <button type="button" onclick="rotateImage()"
                                    style="width: 100%; margin-top: 0.5rem; padding: 0.3rem; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--editor-border); color: var(--text-color); border-radius: 4px; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                    <i class="fa-solid fa-rotate-right"></i> Oto캜it o 90춿
                                </button>
                            </div>
                        </div>

                        <!-- SECTION 3: N치hledy -->
                        <div>
                            <div
                                style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; color: #60a5fa;">
                                <i class="fa-solid fa-eye"></i>
                                <span style="font-weight: 600;">N치hledy</span>
                            </div>

                            <!-- Card preview -->
                            <div class="preview-card" style="margin-bottom: 0.75rem;">
                                <div class="preview-title" style="font-size: 0.75rem; padding: 0.5rem;">Karta</div>
                                <div class="news-preview"
                                    style="width: 100%; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; overflow: hidden; background: #1a1a1a;">
                                    <div class="preview-image" id="previewImage"
                                        style="height: 120px; text-align: center; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                        <i class="fa-solid fa-image"
                                            style="font-size: 1.5rem; color: var(--text-muted);"></i>
                                    </div>
                                    <div class="card-content" style="padding: 0.75rem;">
                                        <span class="card-category" id="previewCategory"
                                            style="font-size: 0.6rem;">Kategorie</span>
                                        <span class="card-date" id="previewDate"
                                            style="font-size: 0.55rem;">Datum</span>
                                        <h3 class="card-title" id="previewTitle"
                                            style="font-size: 0.8rem; margin: 0.3rem 0;">Nadpis</h3>
                                        <p class="card-excerpt" id="previewExcerpt"
                                            style="font-size: 0.7rem; color: var(--text-muted);">Popis...</p>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- USERS -->
    <!-- MEMBERS -->
    <div id="membersView" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="margin: 0;">Seznam 캜len콢</h2>
            <button class="btn-primary" onclick="openMemberModal()"><i class="fa-solid fa-user-plus"></i>
                Nov칳
                캜len</button>
        </div>

        <table class="data-table">
            <thead>
                <tr>
                    <th>Jm칠no</th>
                    <th>ELO</th>
                    <th>Titul</th>
                    <th>Narozen칤</th>
                    <th>Role</th>
                    <th>Akce</th>
                </tr>
            </thead>
            <tbody id="membersTableBody"></tbody>
        </table>
    </div>

    <div id="usersView" class="hidden">
        <div class="editor-layout">
            <div>
                <h2>Seznam u쬴vatel콢</h2>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
            <div class="editor-sidebar">
                <h3>P콏idat u쬴vatele</h3>
                <div class="form-group"><label>Username</label><input type="text" id="newUsername"></div>
                <div class="form-group"><label>Email</label><input type="email" id="newEmail"></div>
                <div class="form-group"><label>Heslo</label><input type="password" id="newPassword"></div>
                <div class="form-group"><label>Role</label><select id="newRole">
                        <option value="admin">Admin</option>
                        <option value="superadmin">Superadmin</option>
                    </select></div>
                <button class="btn-primary" onclick="createUser()">Vytvo콏it</button>
            </div>
        </div>
    </div>

    <div id="messagesView" class="hidden">
        <h2><i class="fa-solid fa-comments"></i> Spr치va vzkazovn칤ku</h2>
        <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Zde m콢쬰te mazat nevhodn칠 p콏칤sp캩vky ze
            vzkazovn칤ku.</p>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Autor</th>
                    <th>Obsah</th>
                    <th>Datum</th>
                    <th>Akce</th>
                </tr>
            </thead>
            <tbody id="messagesTableBody"></tbody>
        </table>
        <div id="noMessagesInfo" style="text-align: center; padding: 2rem; color: var(--text-muted); display: none;">
            콯치dn칠 vzkazy k zobrazen칤.
        </div>
    </div>

    <!-- Blicak Registrations View -->
    <div id="blicakView" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="margin: 0;"><i class="fa-solid fa-bolt"></i> Registrace - V치no캜n칤 blesk</h2>
            <button class="btn-primary" onclick="loadBlicakRegistrations()"><i class="fa-solid fa-sync"></i>
                Obnovit</button>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Jm칠no</th>
                    <th>Odd칤l</th>
                    <th>LOK</th>
                    <th>Ro캜n칤k</th>
                    <th>캛as registrace</th>
                </tr>
            </thead>
            <tbody id="blicakTableBody"></tbody>
        </table>
        <div id="noBlicakInfo" style="text-align: center; padding: 2rem; color: var(--text-muted); display: none;">
            콯치dn칠 registrace.
        </div>
    </div>

    <!-- Competitions View -->
    <div id="competitionsView" class="hidden">
        <div class="card"
            style="margin-bottom: 2rem; padding: 1.5rem; background: linear-gradient(135deg, var(--card-bg), rgba(59, 130, 246, 0.1)); border-left: 4px solid #3b82f6;">
            <div
                style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div style="width: 100%;">
                    <h3 style="margin: 0 0 0.5rem 0; color: #3b82f6;"><i class="fa-solid fa-table"></i>
                        Tabulky
                        dru쬽tva</h3>
                    <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">Spr치va zdroj콢 dat pro
                        sout캩쬰. Zm캩ny se projev칤 po kliknut칤 na "Aktualizovat tabulky".</p>

                    <div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
                        <button class="btn-secondary" onclick="updateStandings()" id="updateStandingsBtn">
                            <i class="fa-solid fa-sync"></i> Aktualizovat tabulky
                        </button>
                    </div>

                    <div id="competitionsList" style="margin-top: 1rem;"></div>
                </div>

            </div>
            <div id="standingsResult" style="margin-top: 1rem; display: none;"></div>
        </div>
    </div>
    </div>
    </div>

    <!-- Member Modal -->
    <div id="memberModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="width: 500px;">
            <h2 id="memberModalTitle" style="margin-top: 0;">Nov칳 캜len</h2>
            <input type="hidden" id="memberId">
            <div class="form-group">
                <label>Jm칠no *</label>
                <input type="text" id="memberFirstName" placeholder="Jan">
            </div>
            <div class="form-group">
                <label>P콏칤jmen칤 *</label>
                <input type="text" id="memberLastName" placeholder="Nov치k">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>ELO</label>
                    <input type="number" id="memberElo">
                </div>
                <div class="form-group">
                    <label>Titul</label>
                    <input type="text" id="memberTitle" placeholder="Nap콏. FM">
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Rok narozen칤</label>
                    <input type="number" id="memberBirthYear">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <input type="text" id="memberRole" placeholder="Nap콏. P콏edseda">
                </div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                <button class="btn-secondary" onclick="closeMemberModal()">Zru코it</button>
                <button class="btn-primary" onclick="saveMember()">Ulo쬴t</button>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        // Admin Panel Logic - use API_URL from config.js
        let authToken = null;
        let currentUser = null;
        let uploadedImageData = null;
        let games = [];
        let teams = ['A t칳m', 'B t칳m']; // Default teams
        let galleryImages = [];

        // Init
        window.addEventListener('DOMContentLoaded', () => {
            authToken = localStorage.getItem('authToken');
            if (authToken) {
                verifyToken();
                checkMaintenance();
            } else showLogin();

            // Editor Enter Key Handler - Clean formatting on new line
            const editor = document.getElementById('articleContent');
            if (editor) {
                // Ensure paragraphs are used for new lines
                document.execCommand('defaultParagraphSeparator', false, 'p');

                editor.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const sel = window.getSelection();
                        if (!sel.rangeCount) return;

                        // Check if we are inside a highlight
                        let node = sel.anchorNode;
                        if (node.nodeType === 3) node = node.parentNode;

                        if (node.classList && (node.classList.contains('highlight-name') || node.classList.contains('highlight-score'))) {
                            e.preventDefault(); // Stop default browser behavior (which might be just <br> in span)

                            // Force a paragraph break
                            // This splits the block: <p><span class="h">...</span></p> <p><span class="h">...</span></p>
                            document.execCommand('insertParagraph');

                            // Now clean the style on the NEW line
                            // The cursor should be in the new paragraph now

                            // We need to wait a tick for the DOM to settle? execCommand is usually synchronous but let's be safe cleaning up
                            // actually execCommand IS synchronous.

                            const newSel = window.getSelection();
                            let newNode = newSel.anchorNode;
                            if (newNode.nodeType === 3) newNode = newNode.parentNode;

                            // Find the highlight span in this new block and unwrap/clear it
                            // We might be inside the span in the new paragraph
                            if (newNode.classList && (newNode.classList.contains('highlight-name') || newNode.classList.contains('highlight-score'))) {
                                // We are inside the span in the new line.
                                // Remove class to make it plain text
                                newNode.className = '';
                                // Remove ZWS if present
                                if (newNode.innerHTML.includes('\u200B')) {
                                    newNode.innerHTML = newNode.innerHTML.replace(/\u200B/g, '');
                                }
                                // If the span is now empty/useless, we might want to unwrap it entirely, 
                                // but removing class is enough to visually "reset" it.

                                // However, often we want to remove the span tag nicely.
                                // document.execCommand('removeFormat') might be cleaner?
                                // Let's stick to removing class as it's targeted.
                            }

                            checkToolbarState();
                        } else {
                            // Normal Enter functionality - verify clean state on next tick if needed
                        }
                    }
                });
            }
        });

        async function checkMaintenance() {
            try {
                const res = await fetch(`${API_URL}/settings`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                const settings = await res.json();
                document.getElementById('maintenanceToggle').checked = settings.maintenance_mode === 'true';
            } catch (e) { console.error(e); }
        }

        async function toggleMaintenance() {
            const toggle = document.getElementById('maintenanceToggle');
            const value = toggle.checked;
            try {
                const res = await fetch(`${API_URL}/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify({ key: 'maintenance_mode', value: value })
                });
                if (res.ok) {
                    showAlert(value ? 'Re쬴m 칰dr쬭y ZAPNUT' : 'Re쬴m 칰dr쬭y VYPNUT', value ? 'success' : 'success');
                } else {
                    toggle.checked = !value; // Revert on error
                    showAlert('Chyba p콏i zm캩n캩 nastaven칤', 'error');
                }
            } catch (e) {
                toggle.checked = !value;
                showAlert('Chyba spojen칤', 'error');
            }
        }

        function showLogin() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
        }

        function showAdmin() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');

            // Show tabs based on role
            if (['admin', 'superadmin'].includes(currentUser.role)) {
                const galleryBtn = document.getElementById('nav-gallery');
                if (galleryBtn) galleryBtn.style.display = 'inline-block';

                const usersBtn = document.getElementById('nav-users');
                if (usersBtn) usersBtn.style.display = 'inline-block';

                const settingsBtn = document.getElementById('nav-settings');
                if (settingsBtn) settingsBtn.style.display = 'inline-block';
            }

            loadDashboard();
        }

        async function verifyToken() {
            try {
                const res = await fetch(`${API_URL}/auth/me`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                if (res.ok) {
                    currentUser = await res.json();
                    document.getElementById('userInfo').textContent = `${currentUser.username} (${currentUser.role})`;
                    showAdmin();
                } else { logout(); }
            } catch (e) { logout(); }
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            const activeTab = document.querySelector(`.nav-tab[onclick="switchTab('${tab}')"]`);
            if (activeTab) activeTab.classList.add('active');

            ['dashboard', 'editor', 'members', 'users', 'messages', 'blicak', 'competitions', 'gallery'].forEach(v => {
                const el = document.getElementById(v + 'View');
                if (el) el.classList.add('hidden');
            });

            const view = document.getElementById(tab + 'View');
            if (view) view.classList.remove('hidden');

            if (tab === 'dashboard') loadDashboard();
            else if (tab === 'members') loadMembers();
            else if (tab === 'users') loadUsers();
            else if (tab === 'messages') loadAdminMessages();
            else if (tab === 'blicak') loadBlicakRegistrations();
            else if (tab === 'competitions') loadCompetitions();
            else if (tab === 'gallery') loadAdminGallery();
        }

        // Dashboard
        async function loadDashboard() {
            try {
                const res = await fetch(`${API_URL}/news`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                const news = await res.json();
                document.getElementById('newsTableBody').innerHTML = news.map(item => `
                    <tr>
                        <td>${new Date(item.publishedDate).toLocaleDateString('cs-CZ')}</td>
                        <td>${item.title}</td>
                        <td class="hide-mobile">${item.category}</td>
                        <td class="hide-mobile"><span class="highlight-name" style="font-size: 0.85rem;">${item.author?.username || '-'}</span></td>
                        <td class="hide-mobile"><span class="status-badge ${item.isPublished ? 'status-published' : 'status-draft'}">${item.isPublished ? '九' : '餃'}<span class="status-text">${item.isPublished ? ' Pub' : ' Konc'}</span></span></td>
                        <td>
                            <button class="action-btn btn-edit" onclick="editNews(${item.id})"><i class="fa-solid fa-pen"></i></button>
                            <button class="action-btn btn-publish" onclick="togglePublish(${item.id})" title="${item.isPublished ? 'Skr칳t' : 'Publikovat'}"><i class="fa-solid fa-${item.isPublished ? 'eye-slash' : 'eye'}"></i></button>
                            ${['admin', 'superadmin'].includes(currentUser.role) ? `<button class="action-btn btn-delete" onclick="deleteNews(${item.id})"><i class="fa-solid fa-trash"></i></button>` : ''}
                        </td>
                    </tr>
                `).join('');
            } catch (e) { console.error(e); }
        }

        async function togglePublish(id) {
            try {
                await fetch(`${API_URL}/news/${id}/publish`, { method: 'PATCH', headers: { 'Authorization': `Bearer ${authToken}` } });
                loadDashboard();
            } catch (e) { console.error(e); }
        }

        async function loadBlicakRegistrations() {
            try {
                const res = await fetch(`${API_URL}/registration/blicak`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                if (res.ok) {
                    const regs = await res.json();
                    const tbody = document.getElementById('blicakTableBody');
                    const info = document.getElementById('noBlicakInfo');

                    if (regs.length === 0) {
                        tbody.innerHTML = '';
                        info.style.display = 'block';
                        return;
                    }

                    info.style.display = 'none';
                    tbody.innerHTML = regs.map(reg => `
                <tr>
                    <td><strong>${escapeHtml(reg.name)}</strong></td>
                    <td>${escapeHtml(reg.club || '-')}</td>
                    <td>${escapeHtml(reg.lok || '-')}</td>
                    <td>${escapeHtml(reg.birthYear)}</td>
                    <td>${new Date(reg.createdAt).toLocaleString('cs-CZ')}</td>
                </tr>
            `).join('');
                }
            } catch (e) { console.error(e); }
        }

        // Editor
        function resetEditor() {
            document.getElementById('editorTitle').textContent = 'Nov치 novinka';
            document.getElementById('editNewsId').value = '';
            document.getElementById('newsTitle').value = '';
            document.getElementById('articleContent').innerHTML = '';
            document.getElementById('newsExcerpt').value = '';

            // Set date to today (local time)
            const today = new Date();
            const localIso = new Date(today.getTime() - (today.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            document.getElementById('newsDate').value = localIso;

            document.getElementById('publishCheck').checked = false;
            document.getElementById('imageUrl').value = '';

            uploadedImageData = null;
            games = [];
            teams = ['A t칳m', 'B t칳m'];
            selectedTeams = ['A t칳m', 'B t칳m'];
            galleryImages = [];

            document.getElementById('uploadArea').classList.remove('has-image');
            document.getElementById('uploadPlaceholder').style.display = 'block';
            document.getElementById('uploadedImage').style.display = 'none';

            // renderTeamCheckboxes(); // Removed as function is missing/legacy
            renderGames();
            document.getElementById('galleryPreview').innerHTML = '';
            updatePreview();

            // Clear auto-saved draft
            localStorage.removeItem('newsDraft');
        }

        async function editNews(id) {
            try {
                const res = await fetch(`${API_URL}/news/${id}`);
                const item = await res.json();

                switchTab('editor');
                resetEditor(); // Clear previous state

                document.getElementById('editorTitle').textContent = 'Upravit novinku';
                document.getElementById('editNewsId').value = item.id;
                document.getElementById('newsTitle').value = item.title;
                document.getElementById('newsCategory').value = item.category;
                document.getElementById('newsDate').value = item.publishedDate.split('T')[0];
                document.getElementById('articleContent').innerHTML = item.content || '';
                document.getElementById('newsExcerpt').value = item.excerpt;
                document.getElementById('publishCheck').checked = item.isPublished;

                if (item.thumbnailUrl) {
                    // Extract crop if present
                    let url = item.thumbnailUrl;
                    let crop = '50%';
                    if (url.includes('#crop=')) {
                        const parts = url.split('#crop=');
                        url = parts[0];
                        crop = parts[1];
                    }

                    uploadedImageData = url;
                    imageCropPosition = crop;

                    // Set slider
                    const numericCrop = parseInt(crop) || 50;
                    document.getElementById('cropSlider').value = numericCrop;
                    document.getElementById('cropValueLabel').textContent = numericCrop + '%';

                    displayImage(url);
                    document.getElementById('imageUrl').value = url;
                } else {
                    // Reset defaults
                    imageCropPosition = '50%';
                    document.getElementById('cropSlider').value = 50;
                    document.getElementById('cropValueLabel').textContent = '50%';
                }

                // Load games from database
                if (item.gamesJson) {
                    try {
                        games = JSON.parse(item.gamesJson);
                        // Backwards compatibility: if simple list of games without type check, assume they are games
                        // If we see 'team' prop and no headers, we might want to respect it? 
                        // Actually, let's just render what we have. If users save, it will be new format.
                    } catch (e) { console.error(e); }
                }

                // Load gallery from database
                if (item.galleryJson) {
                    galleryImages = JSON.parse(item.galleryJson);
                } else {
                    galleryImages = [];
                }

                renderGames();
                renderGallery();
                updatePreview();
            } catch (e) {
                console.error(e);
                // Fallback rendering in case of partial failure
                renderGames();
                renderGallery();
            }
        }

        async function saveNews() {
            const id = document.getElementById('editNewsId').value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/news/${id}` : `${API_URL}/news`;

            const data = {
                title: document.getElementById('newsTitle').value,
                category: document.getElementById('newsCategory').value,
                publishedDate: document.getElementById('newsDate').value,
                content: document.getElementById('articleContent').innerHTML,
                excerpt: document.getElementById('newsExcerpt').value,
                excerpt: document.getElementById('newsExcerpt').value,
                thumbnailUrl: uploadedImageData ? (uploadedImageData + '#crop=' + imageCropPosition) : null,
                isPublished: document.getElementById('publishCheck').checked,
                gamesJson: JSON.stringify(games),
                // teamsJson: null, // Legacy field, no longer used
                galleryJson: JSON.stringify(galleryImages)
            };

            // Validate required fields
            if (!data.title) {
                showAlert('Vypl켿te nadpis', 'error');
                return;
            }
            if (!data.publishedDate) {
                showAlert('Vypl켿te datum publikace', 'error');
                return;
            }
            if (!data.excerpt) {
                showAlert('Vypl켿te kr치tk칳 popis', 'error');
                return;
            }

            try {
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    showAlert('Ulo쬰no!', 'success');
                    switchTab('dashboard');
                } else {
                    // Try to get error details from response
                    let errorMsg = 'Chyba p콏i ukl치d치n칤';
                    try {
                        const errorData = await res.json();
                        if (errorData.error) {
                            errorMsg = `Chyba: ${errorData.error}`;
                        } else if (errorData.message) {
                            errorMsg = `Chyba: ${errorData.message}`;
                        }
                    } catch (parseErr) {
                        const errorText = await res.text();
                        if (errorText) {
                            errorMsg = `Chyba ${res.status}: ${errorText.substring(0, 100)}`;
                        } else {
                            errorMsg = `Chyba ${res.status}: ${res.statusText}`;
                        }
                    }
                    console.error('Save error:', errorMsg);
                    showAlert(errorMsg, 'error');
                }
            } catch (e) {
                console.error('Connection error:', e);
                showAlert('Chyba spojen칤: ' + e.message, 'error');
            }
        }

        async function deleteNews(id) {
            if (!confirm('Opravdu smazat?')) return;
            try {
                await fetch(`${API_URL}/news/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${authToken}` } });
                loadDashboard();
            } catch (e) { console.error(e); }
        }

        // WYSIWYG
        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('articleContent').focus();
            checkToolbarState();
        }

        function toggleSource() {
            const contentDiv = document.getElementById('articleContent');
            const sourceArea = document.getElementById('articleSource');
            const btn = document.getElementById('btnSource');

            if (sourceArea.classList.contains('hidden')) {
                // Switch to Source
                sourceArea.value = contentDiv.innerHTML;
                contentDiv.classList.add('hidden');
                sourceArea.classList.remove('hidden');
                btn.classList.add('active');
            } else {
                // Switch to WYSIWYG
                contentDiv.innerHTML = sourceArea.value;
                sourceArea.classList.add('hidden');
                contentDiv.classList.remove('hidden');
                btn.classList.remove('active');
                updatePreview();
            }
        }

        function updateContentFromSource() {
            const contentDiv = document.getElementById('articleContent');
            const sourceArea = document.getElementById('articleSource');
            contentDiv.innerHTML = sourceArea.value;
            updatePreview();
        }

        function insertHighlight(type) {
            const editor = document.getElementById('articleContent');
            const selection = window.getSelection();

            if (!selection.rangeCount) return;

            const range = selection.getRangeAt(0);
            const className = type === 'name' ? 'highlight-name' : 'highlight-score';
            let parentSpan = null;

            // 1. Check if we are inside a highlight span
            let el = range.commonAncestorContainer;
            if (el.nodeType === 3) el = el.parentNode;

            while (el && el !== editor) {
                if (el.classList && (el.classList.contains('highlight-name') || el.classList.contains('highlight-score'))) {
                    parentSpan = el;
                    break;
                }
                el = el.parentNode;
            }

            if (parentSpan) {
                // We are inside a span.
                // If it is the SAME type -> Exit (Toggle Off)
                if (parentSpan.classList.contains(className)) {
                    // SAME TYPE: Move cursor OUT via a neutral buffer
                    // Check if there is already a neutral node after
                    let nextNode = parentSpan.nextSibling;
                    if (nextNode && nextNode.nodeType === 1 && nextNode.tagName === 'SPAN' && !nextNode.className) {
                        // Already have a buffer span, just move into it
                        const newRange = document.createRange();
                        newRange.selectNodeContents(nextNode);
                        newRange.collapse(false); // End of span
                        selection.removeAllRanges();
                        selection.addRange(newRange);
                    } else if (nextNode && nextNode.nodeType === 3) {
                        // Text node exists, move to start of it
                        const newRange = document.createRange();
                        newRange.setStart(nextNode, 0);
                        newRange.collapse(true);
                        selection.removeAllRanges();
                        selection.addRange(newRange);
                    } else {
                        // Create neutral span buffer
                        const neutralSpan = document.createElement('span');
                        neutralSpan.innerHTML = '&nbsp;'; // Visible space

                        if (parentSpan.nextSibling) {
                            parentSpan.parentNode.insertBefore(neutralSpan, parentSpan.nextSibling);
                        } else {
                            parentSpan.parentNode.appendChild(neutralSpan);
                        }

                        const newRange = document.createRange();
                        newRange.setStart(neutralSpan.firstChild, 1); // After the &nbsp;
                        newRange.collapse(true);
                        selection.removeAllRanges();
                        selection.addRange(newRange);
                    }
                    editor.focus();
                } else {
                    // If DIFFERENT type -> Switch type
                    parentSpan.className = className;
                }
            } else {
                // Not inside a span -> Create new highlight
                if (!selection.isCollapsed) {
                    // Text selected: wrap it
                    const span = document.createElement('span');
                    span.className = className;
                    try {
                        const contents = range.extractContents();
                        span.appendChild(contents);
                        range.insertNode(span);

                        // FIX: Place cursor at the end of the new span so user sees it and button lights up
                        const newRange = document.createRange();
                        newRange.selectNodeContents(span);
                        newRange.collapse(false); // End of span
                        selection.removeAllRanges();
                        selection.addRange(newRange);
                    } catch (e) {
                        console.error(e);
                    }
                } else {
                    // No text selected: insert placeholder
                    const placeholder = type === 'name' ? '[Jm칠no]' : '[Sk칩re]';
                    const span = document.createElement('span');
                    span.className = className;
                    span.innerHTML = '\u200B' + placeholder;
                    range.insertNode(span);

                    // Add space after
                    const space = document.createTextNode('\u00A0');
                    if (span.nextSibling) {
                        span.parentNode.insertBefore(space, span.nextSibling);
                    } else {
                        span.parentNode.appendChild(space);
                    }

                    // Move cursor to space
                    const newRange = document.createRange();
                    newRange.setStart(space, 1);
                    newRange.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(newRange);
                }
            }

            editor.focus();
            updatePreview();
            checkToolbarState();
        }

        function checkToolbarState() {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;

            const anchorNode = selection.anchorNode;
            if (!anchorNode) return;

            // B/I/U
            const isBold = document.queryCommandState('bold');
            const isItalic = document.queryCommandState('italic');
            const isUnderline = document.queryCommandState('underline');

            const btnBold = document.getElementById('btnBold');
            const btnItalic = document.getElementById('btnItalic');
            const btnUnderline = document.getElementById('btnUnderline');

            if (isBold) btnBold.classList.add('active'); else btnBold.classList.remove('active');
            if (isItalic) btnItalic.classList.add('active'); else btnItalic.classList.remove('active');
            if (isUnderline) btnUnderline.classList.add('active'); else btnUnderline.classList.remove('active');

            // Remove manual background set in previous code
            btnBold.style.background = '';
            btnItalic.style.background = '';
            btnUnderline.style.background = '';


            // Highlight buttons
            const btnName = document.getElementById('btnHighlightName');
            const btnScore = document.getElementById('btnHighlightScore');

            btnName.classList.remove('active');
            btnScore.classList.remove('active');
            btnName.style.background = ''; // clear legacy
            btnScore.style.background = ''; // clear legacy

            let el = anchorNode.nodeType === 3 ? anchorNode.parentElement : anchorNode;
            // Check current node and parents
            while (el && el.id !== 'articleContent') {
                if (el.classList && el.classList.contains('highlight-name')) {
                    btnName.classList.add('active');
                    break;
                } else if (el.classList && el.classList.contains('highlight-score')) {
                    btnScore.classList.add('active');
                    break;
                }
                el = el.parentElement;
            }

            // Heading
            const headingSelect = document.getElementById('headingSelect');
            const blockValue = document.queryCommandValue('formatBlock');
            if (blockValue && blockValue.toLowerCase().startsWith('h')) {
                headingSelect.value = blockValue.toLowerCase();
            } else {
                headingSelect.value = 'p';
            }
        }

        // Add event listeners for toolbar state
        document.addEventListener('DOMContentLoaded', () => {
            const content = document.getElementById('articleContent');
            if (!content) {
                console.warn('articleContent not found on DOMContentLoaded');
                return;
            }

            content.addEventListener('mouseup', checkToolbarState);
            content.addEventListener('keyup', checkToolbarState);
            content.addEventListener('click', checkToolbarState);

            // Auto-save setup
            let saveTimeout;
            const autoSave = () => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    const titleEl = document.getElementById('newsTitle');
                    const contentEl = document.getElementById('articleContent');
                    const excerptEl = document.getElementById('newsExcerpt');
                    const editIdEl = document.getElementById('editNewsId');

                    const draft = {
                        title: titleEl?.value || '',
                        content: contentEl?.innerHTML || '',
                        excerpt: excerptEl?.value || '',
                        editId: editIdEl?.value || '',
                        savedAt: new Date().toISOString()
                    };

                    // Only save if there's actual content
                    if (draft.title || (draft.content && draft.content !== '<br>' && draft.content.trim() !== '')) {
                        localStorage.setItem('newsDraft', JSON.stringify(draft));
                        console.log('游닇 Draft auto-saved at', new Date().toLocaleTimeString());
                    }
                }, 2000); // Save 2s after last change
            };

            content.addEventListener('input', autoSave);
            document.getElementById('newsTitle')?.addEventListener('input', autoSave);
            document.getElementById('newsExcerpt')?.addEventListener('input', autoSave);

            // Restore draft - delay to ensure page is fully loaded
            setTimeout(() => {
                const savedDraft = localStorage.getItem('newsDraft');
                if (savedDraft) {
                    try {
                        const draft = JSON.parse(savedDraft);
                        const savedTime = new Date(draft.savedAt).toLocaleString('cs-CZ');
                        console.log('游늶 Found draft from', savedTime);

                        // Only restore new articles (not edits)
                        if ((draft.title || (draft.content && draft.content !== '<br>')) && !draft.editId) {
                            if (confirm(`M치te rozepsanou novinku z ${savedTime}. Chcete ji obnovit?`)) {
                                document.getElementById('newsTitle').value = draft.title || '';
                                document.getElementById('articleContent').innerHTML = draft.content || '';
                                document.getElementById('newsExcerpt').value = draft.excerpt || '';
                                updatePreview();
                                switchTab('editor'); // Switch to editor tab
                                console.log('九 Draft restored');
                            } else {
                                localStorage.removeItem('newsDraft');
                                console.log('游딈勇 Draft discarded');
                            }
                        }
                    } catch (e) {
                        console.error('Draft restore error:', e);
                    }
                }
            }, 500);

            // Warn before leaving with unsaved changes
            window.addEventListener('beforeunload', (e) => {
                const title = document.getElementById('newsTitle')?.value;
                const content = document.getElementById('articleContent')?.innerHTML;
                if (title || (content && content !== '<br>' && content.trim() !== '')) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        });

        function applyHeading(tag) {
            const editor = document.getElementById('articleContent');
            const selection = window.getSelection();

            // Update button states
            updateHeadingButtons(tag);

            if (!selection.rangeCount || selection.isCollapsed) {
                // No selection - use default behavior
                document.execCommand('formatBlock', false, tag);
                editor.focus();
                checkToolbarState();
                return;
            }

            const range = selection.getRangeAt(0);

            // Check if selection is within editor
            if (!editor.contains(range.commonAncestorContainer)) {
                return;
            }

            // Wrap selected text in the heading tag
            const element = document.createElement(tag);
            try {
                const contents = range.extractContents();
                element.appendChild(contents);
                range.insertNode(element);
                selection.removeAllRanges();
            } catch (e) {
                console.error('Heading error:', e);
                // Fallback to default behavior
                document.execCommand('formatBlock', false, tag);
            }

            editor.focus();
            updatePreview();
            checkToolbarState();
        }

        function updateHeadingButtons(active) {
            ['P', 'H1', 'H2', 'H3'].forEach(tag => {
                const btn = document.getElementById('heading' + tag);
                if (btn) {
                    if (tag.toLowerCase() === active.toLowerCase()) {
                        btn.style.background = 'var(--primary-color)';
                        btn.style.color = '#000';
                    } else {
                        btn.style.background = 'transparent';
                        btn.style.color = 'var(--text-muted)';
                    }
                }
            });
        }

        function insertList(type) {
            const command = type === 'ul' ? 'insertUnorderedList' : 'insertOrderedList';
            document.execCommand(command, false, null);
            document.getElementById('articleContent').focus();
            updatePreview();
        }

        function insertLink() {
            const editor = document.getElementById('articleContent');
            const selection = window.getSelection();
            let selectedText = '';
            let savedRange = null;

            if (selection.rangeCount > 0 && !selection.isCollapsed) {
                savedRange = selection.getRangeAt(0).cloneRange();
                selectedText = selection.toString();
            }

            // Create modal
            const modal = document.createElement('div');
            modal.id = 'linkModal';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="document.getElementById('linkModal').remove()"></div>
                <div class="modal-content" style="max-width: 400px;">
                    <h3 style="margin-bottom:1rem;">Vlo쬴t odkaz</h3>
                    <div style="margin-bottom:1rem;">
                        <label style="display:block;margin-bottom:0.3rem;color:var(--text-muted);font-size:0.85rem;">URL *</label>
                        <input type="url" id="linkUrl" placeholder="https://..." style="width:100%;box-sizing:border-box;">
                    </div>
                    <div style="margin-bottom:1rem;">
                        <label style="display:block;margin-bottom:0.3rem;color:var(--text-muted);font-size:0.85rem;">Text odkazu</label>
                        <input type="text" id="linkText" value="${selectedText}" placeholder="Zobrazovan칳 text" style="width:100%;box-sizing:border-box;">
                    </div>
                    <div style="margin-bottom:1rem;">
                        <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;color:var(--text-muted);font-size:0.85rem;">
                            <input type="checkbox" id="linkNewTab" checked style="width:auto;">
                            Otev콏칤t v nov칠m okn캩
                        </label>
                    </div>
                    <div style="display:flex;gap:0.5rem;justify-content:flex-end;">
                        <button id="linkCancel" class="btn-secondary">Zru코it</button>
                        <button id="linkInsert" class="btn-primary">Vlo쬴t</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            const urlInput = modal.querySelector('#linkUrl');
            const textInput = modal.querySelector('#linkText');
            const newTabCheck = modal.querySelector('#linkNewTab');

            urlInput.focus();

            modal.querySelector('#linkCancel').onclick = () => modal.remove();
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            modal.querySelector('#linkInsert').onclick = () => {
                const url = urlInput.value.trim();
                const text = textInput.value.trim() || url;
                const newTab = newTabCheck.checked;

                if (!url) {
                    urlInput.style.borderColor = '#f87171';
                    return;
                }

                // Restore selection if we had one
                if (savedRange) {
                    selection.removeAllRanges();
                    selection.addRange(savedRange);
                    savedRange.deleteContents();
                }

                // Create link element
                const a = document.createElement('a');
                a.href = url;
                a.textContent = text;
                if (newTab) {
                    a.target = '_blank';
                    a.rel = 'noopener noreferrer';
                }

                // Insert at cursor or selection
                const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : document.createRange();
                if (!editor.contains(range.commonAncestorContainer)) {
                    editor.appendChild(a);
                    editor.appendChild(document.createTextNode(' '));
                } else {
                    range.insertNode(a);
                    // Add space after and move cursor
                    const space = document.createTextNode(' ');
                    a.parentNode.insertBefore(space, a.nextSibling);
                    range.setStartAfter(space);
                    range.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }

                modal.remove();
                editor.focus();
                updatePreview();
            };

            // Enter to submit
            urlInput.onkeydown = textInput.onkeydown = (e) => {
                if (e.key === 'Enter') modal.querySelector('#linkInsert').click();
                if (e.key === 'Escape') modal.remove();
            };
        }

        function insertCollapsibleBlock() {
            const id = 'collapse_' + Date.now();
            const iconId = 'icon_' + Date.now();

            // Note: Wrapper is contenteditable=false to allow onclick events to fire
            // Children are contenteditable=true to allow editing text
            const html = `
                <div class="collapsible-wrapper" contenteditable="false" style="user-select: none;">
                    <div class="collapsible-header" onclick="toggleSection('${id}', '${iconId}')" style="cursor: pointer;">
                        <h3 contenteditable="true" style="cursor: text; user-select: text;">Nadpis sekce</h3>
                        <i id="${iconId}" class="fa-solid fa-chevron-down"></i>
                    </div>
                    <div id="${id}" class="collapsible-content hidden" contenteditable="true" style="cursor: text; user-select: text;">
                        <p>Zde napi코te obsah...</p>
                    </div>
                </div>
                <p><br></p>
            `;

            document.execCommand('insertHTML', false, html);
        }

        // Preview toggle logic (matches article.html)
        window.toggleSection = function (id, iconId) {
            const content = document.getElementById(id);
            const icon = document.getElementById(iconId);

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                if (icon) {
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                }
            } else {
                content.classList.add('hidden');
                if (icon) {
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                }
            }
        }

        function insertIntroBlock() {
            const content = document.getElementById('articleContent');
            const selection = window.getSelection();

            // Check if already inside a puzzle-section - if so, escape from it
            if (selection.rangeCount > 0) {
                let node = selection.getRangeAt(0).commonAncestorContainer;
                while (node && node !== content) {
                    if (node.nodeType === 1 && node.classList?.contains('puzzle-section')) {
                        // Already inside - insert new paragraph after block and move cursor there
                        let afterBlock = node.nextElementSibling;
                        if (!afterBlock || afterBlock.tagName !== 'P') {
                            afterBlock = document.createElement('p');
                            afterBlock.innerHTML = '<br>'; // Empty paragraph needs br to be clickable
                            node.parentNode.insertBefore(afterBlock, node.nextSibling);
                        }
                        // Position cursor at start of the paragraph
                        const newRange = document.createRange();
                        newRange.setStart(afterBlock, 0);
                        newRange.collapse(true);
                        selection.removeAllRanges();
                        selection.addRange(newRange);
                        content.focus();
                        updatePreview();
                        return;
                    }
                    node = node.parentNode;
                }
            }

            const introHtml = `<div class="puzzle-section">
    <p style="font-size: 1.1rem; margin-bottom: 1rem;">
        游빌 <strong>Pozice z partie...</strong><br>
        Popis pozice nebo 칰kolu.<br>
        Najdete v칤t캩zn칳 tah? 鮫勇
    </p>
</div>`;
            document.execCommand('insertHTML', false, introHtml);
            content.focus();
            updatePreview();
        }

        // Image insertion with modal
        let selectedImage = null;
        let savedRange = null;

        function insertImage() {
            // Save current selection/cursor position
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                savedRange = sel.getRangeAt(0).cloneRange();
            }
            showImageModal();
        }

        function showImageModal(existingImg = null) {
            selectedImage = existingImg;

            // Create modal
            let modal = document.getElementById('imageModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'imageModal';
                modal.innerHTML = `
                    <div class="modal-overlay" onclick="closeImageModal()"></div>
                    <div class="modal-content">
                        <h3 style="margin-bottom: 1rem;">${existingImg ? 'Upravit obr치zek' : 'Vlo쬴t obr치zek'}</h3>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <input type="text" id="imgUrlInput" placeholder="URL obr치zku" style="flex: 1;">
                            <button type="button" class="btn-secondary" onclick="document.getElementById('imgFileInput').click()">
                                <i class="fa-solid fa-upload"></i> Nahr치t
                            </button>
                            <input type="file" id="imgFileInput" accept="image/*" style="display: none;" onchange="handleImageFile(event)">
                        </div>
                        <div id="imgPreviewArea" style="text-align: center; margin-bottom: 1rem; min-height: 100px; border: 1px dashed rgba(255,255,255,0.2); border-radius: 8px; padding: 1rem;">
                            <p style="color: var(--text-muted);">N치hled obr치zku</p>
                        </div>
                        <div style="margin-bottom: 1rem;">
                             <button type="button" onclick="rotateContentImage()" id="rotateContentBtn" style="width: 100%; padding: 0.4rem; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--editor-border); color: var(--text-color); border-radius: 4px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fa-solid fa-rotate-right"></i> Oto캜it o 90춿
                            </button>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem;">Zarovn치n칤</label>
                                <select id="imgAlign" style="width: 100%; margin-top: 0.25rem;">
                                    <option value="center">Na st콏ed</option>
                                    <option value="left">Vlevo</option>
                                    <option value="right">Vpravo</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem;">Velikost</label>
                                <select id="imgSize" style="width: 100%; margin-top: 0.25rem;">
                                    <option value="100%">Pln치 코칤콏ka</option>
                                    <option value="75%">75%</option>
                                    <option value="50%">50%</option>
                                    <option value="320px">Mal치 (320px)</option>
                                    <option value="200px">Mini (200px)</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            ${existingImg ? '<button type="button" class="btn-danger" onclick="deleteImage()"><i class="fa-solid fa-trash"></i> Smazat</button>' : ''}
                            <button type="button" class="btn-secondary" onclick="closeImageModal()">Zru코it</button>
                            <button type="button" class="btn-primary" onclick="applyImage()">Pou쮂셦</button>
                        </div>
                    </div>
                `;
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 2000; display: flex; align-items: center; justify-content: center;';
                document.body.appendChild(modal);

                // Add modal styles if not present
                if (!document.getElementById('imageModalStyles')) {
                    const style = document.createElement('style');
                    style.id = 'imageModalStyles';
                    style.textContent = `
                        #imageModal .modal-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); }
                        #imageModal .modal-content { position: relative; background: var(--surface-color); padding: 1.5rem; border-radius: var(--border-radius); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
                        #imageModal select, #imageModal input[type="text"] { background: var(--background-color); color: var(--text-main); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; padding: 0.5rem; }
                        #imageModal .btn-danger { background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }
                        #imageModal #imgPreviewArea img { max-width: 100%; max-height: 200px; border-radius: 4px; }
                    `;
                    document.head.appendChild(style);
                }
            } else {
                modal.style.display = 'flex';
                modal.querySelector('h3').textContent = existingImg ? 'Upravit obr치zek' : 'Vlo쬴t obr치zek';
            }

            // If editing existing image
            if (existingImg) {
                document.getElementById('imgUrlInput').value = existingImg.src;
                document.getElementById('imgPreviewArea').innerHTML = `<img src="${existingImg.src}">`;

                // Parse current styles
                const style = existingImg.style;
                if (style.marginLeft === 'auto' && style.marginRight === 'auto') {
                    document.getElementById('imgAlign').value = 'center';
                } else if (style.float === 'left') {
                    document.getElementById('imgAlign').value = 'left';
                } else if (style.float === 'right') {
                    document.getElementById('imgAlign').value = 'right';
                }

                document.getElementById('imgSize').value = style.maxWidth || '100%';
            } else {
                document.getElementById('imgUrlInput').value = '';
                document.getElementById('imgPreviewArea').innerHTML = '<p style="color: var(--text-muted);">N치hled obr치zku</p>';
            }
        }

        function handleImageFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('imgUrlInput').value = e.target.result;
                document.getElementById('imgPreviewArea').innerHTML = `<img src="${e.target.result}">`;
            };
            reader.readAsDataURL(file);
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) modal.style.display = 'none';
            selectedImage = null;
            savedRange = null;
        }

        function applyImage() {
            const url = document.getElementById('imgUrlInput').value;
            if (!url) return closeImageModal();

            const align = document.getElementById('imgAlign').value;
            const size = document.getElementById('imgSize').value;

            let style = `max-width: ${size}; border-radius: 8px; cursor: pointer;`;
            if (align === 'center') {
                style += ' display: block; margin: 1rem auto;';
            } else if (align === 'left') {
                style += ' float: left; margin: 0 1rem 1rem 0;';
            } else if (align === 'right') {
                style += ' float: right; margin: 0 0 1rem 1rem;';
            }

            if (selectedImage) {
                // Update existing image
                selectedImage.src = url;
                selectedImage.style.cssText = style;
            } else {
                // Create new image element
                const img = document.createElement('img');
                img.src = url;
                img.alt = 'Obr치zek';
                img.style.cssText = style;

                const content = document.getElementById('articleContent');

                // Insert at saved position or at end
                if (savedRange) {
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(savedRange);
                    savedRange.insertNode(img);
                    savedRange.collapse(false);
                } else {
                    content.appendChild(img);
                }
            }

            updatePreview();
            closeImageModal();
        }

        function deleteImage() {
            if (selectedImage) {
                selectedImage.remove();
                updatePreview();
            }
            closeImageModal();
        }

        async function rotateContentImage() {
            const urlInput = document.getElementById('imgUrlInput');
            const url = urlInput.value;
            if (!url) return;

            const btn = document.getElementById('rotateContentBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ot치캜칤m...';
            btn.disabled = true;

            try {
                const newUrl = await uploadRotatedImage(url);
                if (newUrl) {
                    urlInput.value = newUrl;
                    document.getElementById('imgPreviewArea').innerHTML = `<img src="${newUrl}">`;
                    // If we are editing an existing image, update it live in preview? 
                    // No, applyImage must be pressed to commit. But rotating basically commits a new file.
                }
            } catch (e) {
                console.error('Content rotation error:', e);
                alert('Nepoda콏ilo se oto캜it obr치zek: ' + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Click handler for images in editor
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('articleContent').addEventListener('click', (e) => {
                if (e.target.tagName === 'IMG') {
                    e.preventDefault();
                    showImageModal(e.target);
                }
            });
        });

        // Games Management
        function toggleGamesInput() {
            document.getElementById('gamesInputPanel').classList.toggle('hidden');
        }

        function addGame() {
            const title = document.getElementById('gameTitle').value.trim();
            const gameId = document.getElementById('gameId').value.trim();
            const commented = document.getElementById('gameCommented').checked;

            if (!title || !gameId) return;

            games.push({
                type: 'game',
                title,
                gameId,
                commented,
                src: `https://www.chess.com/emboard?id=${gameId}`
            });

            renderGames();
            document.getElementById('gameTitle').value = '';
            document.getElementById('gameId').value = '';
            document.getElementById('gameCommented').checked = false;
        }

        function addHeader() {
            const title = document.getElementById('headerTitle').value.trim();
            if (!title) return;

            games.push({
                type: 'header',
                title
            });

            renderGames();
            document.getElementById('headerTitle').value = '';
        }

        function removeGame(index) {
            games.splice(index, 1);
            renderGames();
        }

        function renderGames() {
            const container = document.getElementById('gamesList');
            if (games.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 0.85rem;">콯치dn칠 polo쬶y</p>';
                return;
            }

            container.innerHTML = `
                <div class="games-list-draggable">
                    ${games.map((item, index) => {
                if (item.type === 'header' || item.isHeader) { // Support both new and potential legacy flags
                    return `
                                <div class="game-item header-item" draggable="true" data-index="${index}" style="background: rgba(212, 175, 55, 0.1); border-left: 3px solid var(--primary-color);">
                                    <span class="drag-handle"><i class="fa-solid fa-grip-vertical"></i></span>
                                    <div style="flex: 1; display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fa-solid fa-heading" style="color: var(--primary-color);"></i>
                                        <input type="text" class="game-title-input" value="${escapeHtml(item.title)}" 
                                               onchange="updateGameTitle(${index}, this.value)" style="font-weight: bold;">
                                    </div>
                                    <div class="game-actions">
                                        <button class="action-btn btn-delete" onclick="removeGame(${index})">
                                            <i class="fa-solid fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                } else {
                    // Regular Game
                    // Handle legacy 'team' property if present by ignoring it visually but keeping data if needed?
                    // Actually user wants to effectively flatten it.
                    return `
                                <div class="game-item" draggable="true" data-index="${index}">
                                    <span class="drag-handle"><i class="fa-solid fa-grip-vertical"></i></span>
                                    <div class="game-inputs">
                                        <input type="text" class="game-title-input" value="${escapeHtml(item.title)}" 
                                               onchange="updateGameTitle(${index}, this.value)" placeholder="N치zev partie">
                                        <input type="text" class="game-id-input" value="${item.gameId || ''}" 
                                               onchange="updateGameId(${index}, this.value)" placeholder="ID">
                                    </div>
                                    <div class="game-actions">
                                        <label style="display: flex; align-items: center; cursor: pointer;" title="Komentovan치">
                                            <input type="checkbox" ${item.commented ? 'checked' : ''} 
                                                   onchange="toggleGameCommented(${index}, this.checked)" 
                                                   style="width: auto; margin: 0;">
                                            <i class="fa-regular fa-comment-dots"></i>
                                        </label>
                                        <button class="action-btn btn-delete" onclick="removeGame(${index})">
                                            <i class="fa-solid fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                }
            }).join('')}
                </div>
            `;

            initDragAndDrop();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateGameTitle(index, newTitle) {
            games[index].title = newTitle;
            updatePreview();
        }

        function updateGameId(index, newId) {
            games[index].gameId = newId;
            games[index].src = `https://www.chess.com/emboard?id=${newId}`;
            // If dragging, we might lose focus if we re-render whole section, 
            // but updatePreview helps right sidebar.
            // renderGames(); <- Don't re-render entire list on keypress, it kills focus!
            updatePreview();
        }

        // Drag and Drop
        let draggedItem = null;
        let draggedIndex = null;

        function initDragAndDrop() {
            const items = document.querySelectorAll('.game-item[draggable="true"]');

            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragleave', handleDragLeave);
                item.addEventListener('drop', handleDrop);
            });
        }

        function handleDragStart(e) {
            draggedItem = this;
            draggedIndex = parseInt(this.dataset.index);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedIndex);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.game-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedItem = null;
            draggedIndex = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            if (this !== draggedItem) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            if (this === draggedItem) return;

            const fromIndex = draggedIndex;
            const toIndex = parseInt(this.dataset.index);
            const targetTeam = this.dataset.team;

            if (fromIndex === toIndex) return;

            // Reorder the games array
            const [movedGame] = games.splice(fromIndex, 1);

            // Update team if dropped in different team section
            movedGame.team = targetTeam;

            // Calculate new position
            let newIndex = toIndex;
            if (fromIndex < toIndex) {
                newIndex = toIndex;
            }

            games.splice(newIndex, 0, movedGame);

            renderGames();
        }

        function toggleGameCommented(index, checked) {
            games[index].commented = checked;
        }

        // Gallery
        function toggleGalleryUrlInput() {
            document.getElementById('galleryUrlInput').classList.toggle('hidden');
        }

        function addGalleryFromUrl() {
            const url = document.getElementById('galleryImageUrl').value.trim();
            if (url) {
                galleryImages.push(url);
                renderGallery();
                document.getElementById('galleryImageUrl').value = '';
            }
        }

        async function addGalleryImages(event) {
            for (const file of event.target.files) {
                const formData = new FormData();
                formData.append('image', file);
                try {
                    const res = await fetch(`${API_URL}/images/upload`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}` },
                        body: formData
                    });
                    if (res.ok) {
                        const data = await res.json();
                        // Use dynamic origin URL
                        const baseUrl = window.location.origin;
                        const imageUrl = data.url.startsWith('http') ? data.url : `${baseUrl}${data.url}`;
                        galleryImages.push(imageUrl);
                        console.log('Gallery image added:', imageUrl);
                        renderGallery();
                    } else {
                        const err = await res.text();
                        console.error('Gallery upload failed:', err);
                        alert('Nahr치v치n칤 do galerie selhalo: ' + err);
                    }
                } catch (e) {
                    console.error('Gallery upload error:', e);
                    alert('Chyba p콏i nahr치v치n칤: ' + e.message);
                }
            }
            // Clear input so same file can be uploaded again
            event.target.value = '';
        }

        function removeGalleryImage(index) { galleryImages.splice(index, 1); renderGallery(); }

        async function rotateGalleryImage(index) {
            const btn = document.getElementById(`rotateGalleryBtn_${index}`);
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            }

            try {
                const newUrl = await uploadRotatedImage(galleryImages[index]);
                if (newUrl) {
                    galleryImages[index] = newUrl;
                    renderGallery();
                }
            } catch (e) {
                console.error('Gallery rotation error:', e);
                alert('Nepoda콏ilo se oto캜it obr치zek.');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-rotate-right"></i>';
                }
            }
        }

        function renderGallery() {
            document.getElementById('galleryPreview').innerHTML = galleryImages.length ? galleryImages.map((img, i) => `
                <div style="position: relative;">
                    <img src="${img}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;">
                    <button onclick="removeGalleryImage(${i})" style="position: absolute; top: -5px; right: -5px; background: #dc2626; border: none; color: white; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center;">칑</button>
                    <button id="rotateGalleryBtn_${i}" onclick="rotateGalleryImage(${i})" style="position: absolute; bottom: -5px; right: -5px; background: rgba(0,0,0,0.7); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center;" title="Oto캜it"><i class="fa-solid fa-rotate-right"></i></button>
                </div>
            `).join('') : '<p style="color: var(--text-muted); font-size: 0.85rem;">콯치dn칠 obr치zky</p>';
        }

        // Users
        async function loadUsers() {
            try {
                const res = await fetch(`${API_URL}/users`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                const users = await res.json();
                document.getElementById('usersTableBody').innerHTML = users.map(u => `
                    <tr>
                        <td>${u.username}</td>
                        <td>${u.email}</td>
                        <td>
                            <select onchange="updateUserRole(${u.id}, this.value)" style="padding: 0.25rem;">
                                <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
                                <option value="editor" ${u.role === 'editor' ? 'selected' : ''}>Editor</option>
                                <option value="superadmin" ${u.role === 'superadmin' ? 'selected' : ''}>Superadmin</option>
                            </select>
                        </td>
                        <td>
                            ${u.id !== currentUser.id ? `<button class="action-btn btn-delete" onclick="deleteUser(${u.id})"><i class="fa-solid fa-trash"></i></button>` : ''}
                        </td>
                    </tr>
                `).join('');
            } catch (e) { console.error(e); }
        }

        async function updateUserRole(id, newRole) {
            try {
                const res = await fetch(`${API_URL}/users/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify({ role: newRole })
                });
                if (res.ok) {
                    showAlert(`Role zm캩n캩na na ${newRole}`, 'success');
                } else {
                    showAlert('Chyba p콏i zm캩n캩 role', 'error');
                    loadUsers(); // Revert
                }
            } catch (e) {
                console.error(e);
                showAlert('Chyba spojen칤', 'error');
            }
        }

        async function createUser() {
            try {
                const res = await fetch(`${API_URL}/users`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` }, body: JSON.stringify({ username: document.getElementById('newUsername').value, email: document.getElementById('newEmail').value, password: document.getElementById('newPassword').value, role: document.getElementById('newRole').value }) });
                if (res.ok) { showAlert('U쬴vatel vytvo콏en', 'success'); loadUsers(); document.getElementById('newUsername').value = ''; document.getElementById('newEmail').value = ''; document.getElementById('newPassword').value = ''; }
            } catch (e) { console.error(e); }
        }

        async function deleteUser(id) {
            if (!confirm('Smazat u쬴vatele?')) return;
            await fetch(`${API_URL}/users/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${authToken}` } });
            loadUsers();
        }

        // Messages (Vzkazovn칤k)
        const CLUB_PASSWORD = 'gambitjbc';

        async function loadAdminMessages() {
            try {
                const res = await fetch(`${API_URL}/messages`, { headers: { 'X-Club-Password': CLUB_PASSWORD } });
                const messages = await res.json();
                const tbody = document.getElementById('messagesTableBody');
                const noInfo = document.getElementById('noMessagesInfo');

                if (messages.length === 0) {
                    tbody.innerHTML = '';
                    noInfo.style.display = 'block';
                } else {
                    noInfo.style.display = 'none';
                    tbody.innerHTML = messages.map(m => `
                        <tr>
                            <td><strong>${escapeHtml(m.author)}</strong></td>
                            <td style="max-width: 400px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(m.content)}</td>
                            <td>${new Date(m.createdAt).toLocaleString('cs-CZ')}</td>
                            <td><button class="action-btn btn-delete" onclick="deleteAdminMessage(${m.id})"><i class="fa-solid fa-trash"></i></button></td>
                        </tr>
                    `).join('');
                }
            } catch (e) { console.error(e); }
        }

        async function deleteAdminMessage(id) {
            if (!confirm('Opravdu smazat tento vzkaz?')) return;
            try {
                await fetch(`${API_URL}/messages/${id}`, { method: 'DELETE', headers: { 'X-Club-Password': CLUB_PASSWORD } });
                showAlert('Vzkaz smaz치n', 'success');
                loadAdminMessages();
            } catch (e) { console.error(e); showAlert('Chyba p콏i maz치n칤', 'error'); }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Delete News (for superadmin)
        async function deleteNews(id) {
            if (!confirm('Opravdu smazat tento 캜l치nek? Tato akce je nevratn치!')) return;
            try {
                const res = await fetch(`${API_URL}/news/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${authToken}` } });
                if (res.ok) {
                    showAlert('캛l치nek smaz치n', 'success');
                    loadDashboard();
                } else {
                    showAlert('Chyba p콏i maz치n칤 캜l치nku', 'error');
                }
            } catch (e) { console.error(e); showAlert('Chyba spojen칤', 'error'); }
        }

        // Auth
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const res = await fetch(`${API_URL}/auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: document.getElementById('username').value, password: document.getElementById('password').value }) });
                if (res.ok) { const data = await res.json(); authToken = data.token; currentUser = data.user; localStorage.setItem('authToken', authToken); showAdmin(); }
                else { document.getElementById('loginError').innerHTML = '<div class="alert alert-error">Chybn칠 칰daje</div>'; }
            } catch (e) { document.getElementById('loginError').innerHTML = '<div class="alert alert-error">Chyba spojen칤</div>'; }
        });

        // Password Toggle
        const togglePassword = document.querySelector('#togglePassword');
        const password = document.querySelector('#password');
        togglePassword.addEventListener('click', function () {
            const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
            password.setAttribute('type', type);
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });

        function logout() { localStorage.removeItem('authToken'); location.reload(); }
        function showAlert(msg, type) {
            const div = document.createElement('div');
            div.className = `alert alert-${type}`;

            // Add icon based on type
            const icon = type === 'success' ? '<i class="fa-solid fa-check-circle"></i>' : '<i class="fa-solid fa-exclamation-circle"></i>';
            div.innerHTML = `<div style="display:flex;align-items:center;gap:10px;">${icon} <span>${msg}</span></div>`;

            // Add close button
            const close = document.createElement('i');
            close.className = 'fa-solid fa-times';
            close.style.cssText = 'cursor:pointer; margin-left:10px; opacity:0.7;';
            close.onclick = () => div.remove();
            div.firstChild.appendChild(close);

            document.getElementById('alertContainer').appendChild(div);

            // Longer timeout for errors
            const timeout = type === 'error' ? 6000 : 3000;
            setTimeout(() => {
                if (div.parentNode) {
                    div.style.opacity = '0';
                    div.style.transform = 'translateX(100%)';
                    div.style.transition = 'all 0.3s';
                    setTimeout(() => div.remove(), 300);
                }
            }, timeout);
        }

        // Update standings from chess.cz
        async function updateStandings() {
            const btn = document.getElementById('updateStandingsBtn');
            const resultDiv = document.getElementById('standingsResult');

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Na캜칤t치m...';
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p style="color: var(--text-muted);">Stahuj칤 se data ze sout캩쮂...</p>';

            try {
                const res = await fetch(`${API_URL}/standings/update`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (res.ok) {
                    const data = await res.json();

                    let html = '<div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">';
                    html += '<h4 style="color: #10b981; margin: 0 0 0.5rem 0;"><i class="fa-solid fa-check-circle"></i> Aktualizace 칰sp캩코n치</h4>';
                    html += '<ul style="margin: 0; padding-left: 1.5rem; color: var(--text-color);">';

                    if (data.standings && Array.isArray(data.standings)) {
                        data.standings.forEach(comp => {
                            const count = comp.standings ? comp.standings.length : 0;
                            if (comp.error) {
                                html += `<li style="color: #fca5a5;">${escapeHtml(comp.name)}: Chyba - ${escapeHtml(comp.error)}</li>`;
                            } else {
                                html += `<li>${escapeHtml(comp.name)}: na캜teno ${count} t칳m콢</li>`;
                            }
                        });
                    }
                    html += '</ul></div>';

                    resultDiv.innerHTML = html;
                    showAlert('Tabulky aktualizov치ny', 'success');
                } else {
                    const errorData = await res.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Server error ' + res.status);
                }
            } catch (e) {
                console.error(e);
                resultDiv.innerHTML = `<p style="color: #fca5a5;"><i class="fa-solid fa-exclamation-triangle"></i> Nepoda콏ilo se na캜칤st tabulky: ${e.message}</p>`;
                showAlert('Chyba: ' + e.message, 'error');
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-sync"></i> Aktualizovat tabulky';
        }


        // Load competition sources
        // Load competition sources
        async function loadCompetitions() {
            try {
                const res = await fetch(`${API_URL}/competitions`);
                let competitions = await res.json();

                // Sort by ID to keep stable order when toggling active status
                competitions.sort((a, b) => a.id.localeCompare(b.id));

                const container = document.getElementById('competitionsList');

                container.innerHTML = competitions.map(c => `
            <div style="background: rgba(255, 255, 255, 0.05); padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="active_${c.id}" ${c.active !== false ? 'checked' : ''} onchange="toggleCompetitionActive('${c.id}', this.checked)" title="Aktivn칤/Neaktivn칤">
                    <div style="overflow: hidden;">
                        <strong style="display: block; font-size: 0.9rem; color: var(--primary-color); ${c.active === false ? 'opacity: 0.5;' : ''}">${c.name}</strong>
                        <div style="font-size: 0.8rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px;" title="${c.url || 'Nen칤 nastaveno'}">
                            ${c.url || '<span style="color: #fca5a5;">URL nenastaveno (vy쬬dov치no pro aktivaci)</span>'}
                        </div>
                    </div>
                </div>
                <button class="btn-secondary btn-small" onclick="changeSourceUrl('${c.id}', '${escapeHtml(c.url || '')}')" title="Zm캩nit URL">
                    <i class="fa-solid fa-pen"></i> URL
                </button>
            </div>
        `).join('');
            } catch (e) {
                console.error('Error loading competitions:', e);
            }
        }

        async function toggleCompetitionActive(id, active) {
            try {
                const res = await fetch(`${API_URL}/competitions/${id}/url`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify({ active })
                });
                if (res.ok) {
                    loadCompetitions(); // Refresh UI
                } else {
                    alert('Chyba p콏i zm캩n캩 stavu.');
                    loadCompetitions(); // Revert UI
                }
            } catch (e) { console.error(e); }
        }

        async function changeSourceUrl(id, currentUrl) {
            const newUrl = prompt('Zadejte nov칠 URL pro zdroj dat:', currentUrl);
            // Allow empty string to clear it, but checking for null (cancel)
            if (newUrl !== null && newUrl !== currentUrl) {
                try {
                    const res = await fetch(`${API_URL}/competitions/${id}/url`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ url: newUrl })
                    });

                    if (res.ok) {
                        showAlert('URL aktualizov치no', 'success');
                        loadCompetitions();
                    } else {
                        showAlert('Chyba aktualizace', 'error');
                    }
                } catch (e) {
                    console.error(e);
                    showAlert('Chyba spojen칤', 'error');
                }
            }
        }


        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('image', file);

            try {
                const res = await fetch(`${API_URL}/images/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });

                if (res.ok) {
                    const data = await res.json();
                    // Use origin-relative URL for production compatibility
                    const baseUrl = window.location.origin;
                    uploadedImageData = data.url.startsWith('http') ? data.url : `${baseUrl}${data.url}`;
                    displayImage(uploadedImageData);
                    console.log('Image uploaded:', uploadedImageData);
                } else {
                    const err = await res.text();
                    console.error('Upload failed:', err);
                    alert('Nahr치v치n칤 obr치zku selhalo: ' + (err || res.status));
                }
            } catch (e) {
                console.error('Upload error:', e);
                alert('Chyba p콏i nahr치v치n칤: ' + e.message);
            }
        }

        function handleImageUrl() {
            const url = document.getElementById('imageUrl').value;
            if (url) {
                uploadedImageData = url;
                displayImage(url);
            }
        }

        let imageCropPosition = '50%'; // Default center (50%)

        function updateCropFromSlider(val) {
            const pct = val + '%';
            imageCropPosition = pct;
            document.getElementById('cropValueLabel').textContent = pct;

            // Update previews
            const img = document.getElementById('uploadedImage');
            if (img) img.style.objectPosition = `center ${pct}`;

            const previewImg = document.getElementById('previewImage');
            const imgTag = previewImg.querySelector('img');
            if (imgTag) imgTag.style.objectPosition = `center ${pct}`;
        }

        function displayImage(src) {
            document.getElementById('uploadArea').classList.add('has-image');
            document.getElementById('uploadPlaceholder').style.display = 'none';
            document.getElementById('imageUrlWrapper').style.display = 'none';
            document.getElementById('removeImageBtn').style.display = 'block';
            document.getElementById('cropPositionWrapper').style.display = 'block';

            const img = document.getElementById('uploadedImage');
            img.src = src;
            img.style.display = 'block';
            // Apply current crop
            img.style.objectPosition = `center ${imageCropPosition}`;

            // Update preview with crop position
            const previewImg = document.getElementById('previewImage');
            previewImg.innerHTML = `<img src="${src}" style="object-position: center ${imageCropPosition};">`;
        }

        function removeImage() {
            uploadedImageData = null;
            imageCropPosition = '50%'; // Reset to default
            document.getElementById('cropSlider').value = 50;
            document.getElementById('cropValueLabel').textContent = '50%';

            document.getElementById('uploadArea').classList.remove('has-image');
            document.getElementById('uploadPlaceholder').style.display = 'block';
            document.getElementById('uploadedImage').style.display = 'none';
            document.getElementById('uploadedImage').src = '';
            document.getElementById('imageUrlWrapper').style.display = 'flex'; // Changed from block to flex
            document.getElementById('imageUrl').value = '';
            document.getElementById('removeImageBtn').style.display = 'none';
            document.getElementById('cropPositionWrapper').style.display = 'none';
            document.getElementById('previewImage').innerHTML = '<i class="fa-solid fa-image" style="font-size: 1.5rem; color: var(--text-muted);"></i>';
            document.getElementById('imageInput').value = '';
        }

        async function uploadRotatedImage(imageUrl) {
            try {
                // Create image element to load current image
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.src = imageUrl;

                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                });

                // Create canvas for rotation
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // Swap dimensions for 90 degree rotation
                canvas.width = img.height;
                canvas.height = img.width;

                // Rotate context
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate(90 * Math.PI / 180);
                ctx.drawImage(img, -img.width / 2, -img.height / 2);

                // Convert to blob
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));

                // Upload
                const formData = new FormData();
                formData.append('image', blob, 'rotated_image.jpg');

                const res = await fetch(`${API_URL}/images/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });

                if (res.ok) {
                    const data = await res.json();
                    const baseUrl = window.location.origin;
                    const newUrl = data.url.startsWith('http') ? data.url : `${baseUrl}${data.url}`;
                    // Force cache bust
                    return newUrl + (newUrl.includes('?') ? '&' : '?') + 't=' + new Date().getTime();
                } else {
                    throw new Error('Upload failed');
                }
            } catch (e) {
                console.error('Rotation helper error:', e);
                throw e;
            }
        }

        async function rotateImage() {
            if (!uploadedImageData) return;

            const btn = document.querySelector('button[onclick="rotateImage()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ot치캜칤m...';
            btn.disabled = true;

            try {
                const newUrl = await uploadRotatedImage(uploadedImageData);
                if (newUrl) {
                    uploadedImageData = newUrl;
                    displayImage(newUrl);
                    console.log('Image rotated:', newUrl);
                }
            } catch (e) {
                console.error('Rotation error:', e);
                alert('Nepoda콏ilo se oto캜it obr치zek: ' + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        function setCropPosition(position) {
            imageCropPosition = position;

            // Update button styles
            ['Top', 'Center', 'Bottom'].forEach(pos => {
                const btn = document.getElementById('crop' + pos);
                if (pos.toLowerCase() === position) {
                    btn.style.border = '1px solid var(--primary-color)';
                    btn.style.background = 'rgba(255,215,0,0.1)';
                    btn.style.color = 'var(--primary-color)';
                } else {
                    btn.style.border = '1px solid rgba(255,255,255,0.2)';
                    btn.style.background = 'transparent';
                    btn.style.color = 'var(--text-muted)';
                }
            });

            // Update uploaded image preview
            const img = document.getElementById('uploadedImage');
            img.style.objectPosition = position;

            // Update card preview
            const previewImg = document.getElementById('previewImage');
            if (uploadedImageData) {
                previewImg.innerHTML = `<img src="${uploadedImageData}" style="object-position: ${position};">`;
            }
        }
        function updatePreview() {
            document.getElementById('previewTitle').textContent = document.getElementById('newsTitle').value || 'Nadpis';
            document.getElementById('previewCategory').textContent = document.getElementById('newsCategory').value;
            document.getElementById('previewExcerpt').textContent = document.getElementById('newsExcerpt').value || 'Kr치tk칳 popis...';
            const date = document.getElementById('newsDate').value;
            document.getElementById('previewDate').textContent = date ? new Date(date).toLocaleDateString('cs-CZ') : 'Datum';

        }

        // Collapsible sidebar sections
        function toggleSidebarSection(section) {
            const content = document.getElementById(section + 'Content');
            const icon = document.getElementById(section + 'Icon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(-90deg)';
            }
        }

        // Members Management
        let allMembers = [];

        async function loadMembers() {
            try {
                const res = await fetch(`${API_URL}/members`);
                allMembers = await res.json();
                renderMembersTable();
            } catch (e) {
                console.error(e);
                showAlert('Chyba p콏i na캜칤t치n칤 캜len콢', 'error');
            }
        }

        function renderMembersTable() {
            const tbody = document.getElementById('membersTableBody');
            tbody.innerHTML = allMembers.map(m => `
                <tr>
                    <td><strong>${escapeHtml(m.firstName)} ${escapeHtml(m.lastName)}</strong></td>
                    <td>${escapeHtml(m.elo || '-')}</td>
                    <td>${escapeHtml(m.title || '-')}</td>
                    <td>${escapeHtml(m.birthYear || '-')}</td>
                    <td>${escapeHtml(m.role || '-')}</td>
                    <td>
                        <button class="action-btn btn-edit" onclick="editMember(${m.id})"><i class="fa-solid fa-edit"></i></button>
                        <button class="action-btn btn-delete" onclick="deleteMember(${m.id})"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function openMemberModal(member = null) {
            const modal = document.getElementById('memberModal');
            const title = document.getElementById('memberModalTitle');

            if (member) {
                title.textContent = 'Upravit 캜lena';
                document.getElementById('memberId').value = member.id;
                document.getElementById('memberFirstName').value = member.firstName;
                document.getElementById('memberLastName').value = member.lastName;
                document.getElementById('memberElo').value = member.elo || '';
                document.getElementById('memberTitle').value = member.title || '';
                document.getElementById('memberBirthYear').value = member.birthYear || '';
                document.getElementById('memberRole').value = member.role || '';
            } else {
                title.textContent = 'Nov칳 캜len';
                document.getElementById('memberId').value = '';
                document.getElementById('memberFirstName').value = '';
                document.getElementById('memberLastName').value = '';
                document.getElementById('memberElo').value = '';
                document.getElementById('memberTitle').value = '';
                document.getElementById('memberBirthYear').value = '';
                document.getElementById('memberRole').value = '';
            }

            modal.style.display = 'flex';
        }

        function closeMemberModal() {
            document.getElementById('memberModal').style.display = 'none';
        }

        async function saveMember() {
            const id = document.getElementById('memberId').value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/members/${id}` : `${API_URL}/members`;

            const data = {
                firstName: document.getElementById('memberFirstName').value.trim(),
                lastName: document.getElementById('memberLastName').value.trim(),
                elo: document.getElementById('memberElo').value,
                title: document.getElementById('memberTitle').value,
                birthYear: document.getElementById('memberBirthYear').value,
                role: document.getElementById('memberRole').value
            };

            if (!data.firstName || !data.lastName) {
                alert('Jm칠no a p콏칤jmen칤 jsou povinn칠.');
                return;
            }

            try {
                const res = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    showAlert('Ulo쬰no!', 'success');
                    closeMemberModal();
                    loadMembers();
                } else {
                    showAlert('Chyba p콏i ukl치d치n칤', 'error');
                }
            } catch (e) {
                console.error(e);
                showAlert('Chyba spojen칤', 'error');
            }
        }

        function editMember(id) {
            const member = allMembers.find(m => m.id === id);
            if (member) openMemberModal(member);
        }

        async function deleteMember(id) {
            if (!confirm('Opravdu smazat tohoto 캜lena?')) return;

            try {
                const res = await fetch(`${API_URL}/members/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (res.ok) {
                    showAlert('Smaz치no!', 'success');
                    loadMembers();
                } else {
                    showAlert('Chyba p콏i maz치n칤', 'error');
                }
            } catch (e) {
                console.error(e);
                showAlert('Chyba spojen칤', 'error');
            }
        }
        // --- Gallery Management ---
        async function loadAdminGallery() {
            const tbody = document.getElementById('galleryTableBody');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Na캜칤t치m...</td></tr>';

            try {
                const res = await fetchWithAuth(`${API_URL}/images`); // Gets all images (auth required)
                if (!res.ok) throw new Error('Failed to load images');

                const images = await res.json();

                if (images.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">콯치dn칠 obr치zky</td></tr>';
                    return;
                }

                tbody.innerHTML = images.map(img => `
                    <tr>
                        <td style="width: 80px;">
                            <img src="${img.url}" style="width: 60px; height: 40px; object-fit: cover; border-radius: 4px; cursor: pointer;" onclick="window.open('${img.url}', '_blank')">
                        </td>
                        <td>
                            <div style="font-weight: 500;">${img.originalName || 'Bez n치zvu'}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${img.altText || ''}</div>
                        </td>
                        <td style="font-size: 0.85rem; color: var(--text-muted);">
                            ${new Date(img.uploadedAt).toLocaleString('cs-CZ')}
                        </td>
                        <td>
                            <button class="action-btn btn-danger" onclick="deleteGalleryImage(${img.id})" title="Smazat">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

            } catch (e) {
                console.error('Gallery load error:', e);
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #fca5a5;">Chyba na캜칤t치n칤</td></tr>';
            }
        }

        async function deleteGalleryImage(id) {
            if (!confirm('Opravdu chcete smazat tento obr치zek? Tato akce je nevratn치.')) return;

            try {
                const res = await fetchWithAuth(`${API_URL}/images/${id}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    showToast('Obr치zek smaz치n');
                    loadAdminGallery();
                } else {
                    showToast('Nepoda콏ilo se smazat obr치zek', 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('Chyba p콏i maz치n칤', 'error');
            }
        }

        async function handleAdminGalleryUpload(input) {
            if (!input.files || input.files.length === 0) return;

            const files = Array.from(input.files);
            let successCount = 0;

            // Upload sequentially
            for (const file of files) {
                const formData = new FormData();
                formData.append('image', file);

                try {
                    const token = localStorage.getItem('token');
                    const res = await fetch(`${API_URL}/images/upload`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });

                    if (res.ok) successCount++;
                } catch (e) {
                    console.error('Upload failed for file:', file.name, e);
                }
            }

            if (successCount > 0) {
                showToast(`Nahr치no ${successCount} obr치zk콢`);
                loadAdminGallery();
            } else {
                showToast('Nahr치v치n칤 selhalo', 'error');
            }

            input.value = ''; // Reset input
        }

    </script>
</body>

</html>