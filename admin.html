<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Spr치va webu</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        :root {
            --editor-bg: #1e1e1e;
            --editor-border: rgba(255, 255, 255, 0.1);
        }

        .admin-container {
            max-width: 1800px;
            margin: 100px auto 2rem;
            padding: 0 2rem;
        }

        .login-container {
            max-width: 400px;
            margin: 150px auto;
            padding: 2rem;
            background: var(--surface-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--editor-border);
        }

        .admin-header {
            background: linear-gradient(135deg, var(--primary-color), #b8941f);
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            color: var(--secondary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface-color);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--editor-border);
        }

        .data-table th {
            background: rgba(255, 255, 255, 0.05);
            color: var(--primary-color);
            font-weight: 600;
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-published {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        .status-draft {
            background: rgba(234, 179, 8, 0.2);
            color: #fde047;
        }

        .action-btn {
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            margin-right: 0.25rem;
            transition: all 0.2s;
        }

        .btn-edit {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
        }

        .btn-delete {
            background: rgba(220, 38, 38, 0.2);
            color: #fca5a5;
        }

        .btn-publish {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        .editor-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            min-height: 80vh;
        }

        .editor-main,
        .editor-sidebar {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--editor-border);
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--editor-border);
            border-radius: 6px;
            color: var(--text-color);
            font-family: inherit;
        }

        .wysiwyg-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--editor-border);
            border-radius: 6px 6px 0 0;
            border-bottom: none;
        }

        .wysiwyg-toolbar button {
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-color);
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .wysiwyg-toolbar button:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: var(--primary-color);
        }

        .wysiwyg-toolbar .divider {
            width: 1px;
            background: var(--editor-border);
            margin: 0 0.5rem;
        }

        .wysiwyg-content {
            min-height: 400px;
            padding: 1rem;
            background: var(--editor-bg);
            border: 1px solid var(--editor-border);
            border-radius: 0 0 6px 6px;
            color: var(--text-color);
            line-height: 1.6;
            outline: none;
            overflow-y: auto;
        }

        .wysiwyg-content:focus {
            border-color: var(--primary-color);
        }

        .highlight-name {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(147, 51, 234, 0.3));
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .highlight-score {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(16, 185, 129, 0.3));
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            font-weight: 700;
        }

        .preview-card {
            margin-bottom: 1.5rem;
        }

        .preview-title {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        .news-preview {
            background: var(--editor-bg);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--editor-border);
        }

        .preview-image {
            height: 180px;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .preview-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-upload {
            border: 2px dashed var(--editor-border);
            border-radius: 6px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload:hover {
            border-color: var(--primary-color);
            background: rgba(212, 175, 55, 0.05);
        }

        .image-upload.has-image {
            padding: 0;
            border: none;
        }

        .uploaded-thumb {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 6px;
        }

        .panel-section {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            border: 1px solid var(--editor-border);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .game-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 4px;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            cursor: grab;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .game-item:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .game-item.dragging {
            opacity: 0.5;
            background: rgba(212, 175, 55, 0.2);
            border: 1px dashed var(--primary-color);
        }

        .game-item.drag-over {
            border-top: 2px solid var(--primary-color);
        }

        .game-item .drag-handle {
            cursor: grab;
            color: var(--text-muted);
            margin-right: 0.75rem;
        }

        .game-item .game-inputs {
            display: flex;
            gap: 0.5rem;
            flex: 1;
        }

        .game-item .game-title-input {
            flex: 2;
            padding: 0.3rem 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--editor-border);
            border-radius: 4px;
            color: var(--text-color);
            font-size: 0.85rem;
        }

        .game-item .game-id-input {
            flex: 1;
            padding: 0.3rem 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--editor-border);
            border-radius: 4px;
            color: var(--text-color);
            font-size: 0.85rem;
            max-width: 120px;
        }

        .game-item .game-actions {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-left: 0.5rem;
        }

        .game-item .team-badge {
            font-size: 0.75rem;
            padding: 0.15rem 0.5rem;
            border-radius: 3px;
            margin-left: 0.5rem;
        }

        .team-checkbox-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .team-checkbox {
            display: flex;
            align-items: center;
            padding: 0.4rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .team-checkbox:hover {
            background: rgba(212, 175, 55, 0.1);
        }

        .team-checkbox input {
            margin-right: 0.5rem;
        }

        .team-checkbox.checked {
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid var(--primary-color);
        }

        .add-team-input {
            display: flex;
            gap: 0.5rem;
        }

        .add-team-input input {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.85rem;
        }

        .add-team-input button {
            padding: 0.5rem 0.75rem;
        }

        .admin-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--editor-border);
            padding-bottom: 1rem;
        }

        .nav-tab {
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            border-radius: 6px;
            color: var(--text-muted);
            transition: all 0.2s;
            font-size: 0.95rem;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
        }

        .nav-tab.active {
            background: var(--primary-color);
            color: var(--secondary-color);
            font-weight: 600;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--secondary-color);
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-color);
            padding: 0.75rem 1.5rem;
            border: 1px solid var(--editor-border);
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        .hidden {
            display: none !important;
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .alert-error {
            background: rgba(220, 38, 38, 0.1);
            color: #fca5a5;
        }

        .alert-success {
            background: rgba(34, 197, 94, 0.1);
            color: #86efac;
        }

        @media (max-width: 1200px) {
            .editor-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- LOGIN -->
    <div id="loginPage" class="hidden">
        <div class="login-container">
            <h1 style="text-align: center; margin-bottom: 2rem;">
                <i class="fa-solid fa-chess-knight" style="color: var(--primary-color);"></i><br>Admin Panel
            </h1>
            <div id="loginError"></div>
            <form id="loginForm">
                <div class="form-group"><label>U쬴vatelsk칠 jm칠no</label><input type="text" id="username" required></div>
                <div class="form-group"><label>Heslo</label><input type="password" id="password" required></div>
                <button type="submit" class="btn-primary" style="width: 100%">P콏ihl치sit se</button>
            </form>
        </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="adminPanel" class="hidden">
        <header>
            <div class="container">
                <nav>
                    <a href="index.html" class="logo"><i class="fa-solid fa-chess-knight"></i> TJ Bi쬿terie - Admin</a>
                    <ul class="nav-links">
                        <li><a href="index.html" target="_blank">Web</a></li>
                        <li><a href="#" onclick="logout()" style="color: #fca5a5;">Odhl치sit</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <div class="admin-container">
            <div class="admin-header">
                <div>
                    <h1 style="margin: 0; font-size: 1.75rem;"><i class="fa-solid fa-cogs"></i> Spr치va webu</h1>
                    <p style="margin: 0.25rem 0 0 0; opacity: 0.9; font-size: 0.9rem;" id="userInfo"></p>
                </div>
            </div>

            <div class="admin-nav">
                <div class="nav-tab active" onclick="switchTab('dashboard')"><i class="fa-solid fa-list"></i> P콏ehled
                </div>
                <div class="nav-tab" onclick="switchTab('editor')"><i class="fa-solid fa-plus"></i> Nov치 novinka</div>
                <div class="nav-tab hidden" id="usersTab" onclick="switchTab('users')"><i class="fa-solid fa-users"></i>
                    U쬴vatel칠</div>
            </div>

            <div id="alertContainer"></div>

            <!-- DASHBOARD -->
            <div id="dashboardView">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="margin: 0;">Seznam novinek</h2>
                    <button class="btn-primary" onclick="switchTab('editor')"><i class="fa-solid fa-plus"></i> Nov치
                        novinka</button>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>N치zev</th>
                            <th>Kategorie</th>
                            <th>Stav</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody id="newsTableBody"></tbody>
                </table>
            </div>

            <!-- EDITOR -->
            <div id="editorView" class="hidden">
                <div class="editor-layout">
                    <!-- Main Editor (70%) -->
                    <div class="editor-main">
                        <h2 style="margin-top: 0;" id="editorTitle">Nov치 novinka</h2>
                        <input type="hidden" id="editNewsId">

                        <div class="form-group">
                            <label>Nadpis 캜l치nku *</label>
                            <input type="text" id="newsTitle" placeholder="Zadejte nadpis..." oninput="updatePreview()">
                        </div>

                        <!-- WYSIWYG Editor -->
                        <div class="form-group">
                            <label>Obsah 캜l치nku *</label>
                            <div class="wysiwyg-toolbar">
                                <button type="button" onclick="formatText('bold')" title="Tu캜n캩"><i
                                        class="fa-solid fa-bold"></i></button>
                                <button type="button" onclick="formatText('italic')" title="Kurz칤va"><i
                                        class="fa-solid fa-italic"></i></button>
                                <button type="button" onclick="formatText('underline')" title="Podtr쬰n칤"><i
                                        class="fa-solid fa-underline"></i></button>
                                <div class="divider"></div>
                                <button type="button" onclick="insertHighlight('name')" title="Zv칳raznit jm칠no"
                                    style="color: #60a5fa;"><i class="fa-solid fa-user"></i> Jm칠no</button>
                                <button type="button" onclick="insertHighlight('score')" title="Zv칳raznit sk칩re"
                                    style="color: #4ade80;"><i class="fa-solid fa-trophy"></i> Sk칩re</button>
                                <div class="divider"></div>
                                <button type="button" onclick="formatText('insertUnorderedList')"><i
                                        class="fa-solid fa-list-ul"></i></button>
                                <button type="button" onclick="formatText('insertOrderedList')"><i
                                        class="fa-solid fa-list-ol"></i></button>
                                <div class="divider"></div>
                                <button type="button" onclick="insertHeading()"><i
                                        class="fa-solid fa-heading"></i></button>
                                <button type="button" onclick="insertLink()"><i class="fa-solid fa-link"></i></button>
                            </div>
                            <div class="wysiwyg-content" id="articleContent" contenteditable="true"
                                oninput="updatePreview()"></div>
                        </div>

                        <!-- Games Panel -->
                        <div class="panel-section">
                            <div class="panel-header">
                                <label style="margin: 0;"><i class="fa-solid fa-chess-board"></i> P콏ehr치va캜
                                    parti칤</label>
                                <button type="button" class="btn-secondary btn-small" onclick="toggleGamesInput()"><i
                                        class="fa-solid fa-plus"></i> P콏idat</button>
                            </div>

                            <!-- Team Checkboxes -->
                            <div class="team-checkbox-list" id="teamCheckboxes"></div>
                            <div class="add-team-input">
                                <input type="text" id="newTeamName" placeholder="N치zev nov칠ho t칳mu (nap콏. C t칳m)">
                                <button type="button" class="btn-secondary btn-small" onclick="addTeam()"><i
                                        class="fa-solid fa-plus"></i></button>
                            </div>

                            <div id="gamesInputPanel" class="hidden" style="margin-top: 1rem;">
                                <div
                                    style="display: grid; grid-template-columns: 2fr 1fr auto auto; gap: 0.5rem; align-items: center;">
                                    <input type="text" id="gameTitle" placeholder="N치zev (nap콏. 1. Nov치k - Svoboda)">
                                    <input type="text" id="gameId" placeholder="Chess.com ID">
                                    <label
                                        style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.85rem; color: var(--text-muted); cursor: pointer;">
                                        <input type="checkbox" id="gameCommented" style="width: auto;"> 游눫
                                    </label>
                                    <button type="button" class="btn-primary btn-small"
                                        onclick="addGame()">P콏idat</button>
                                </div>
                            </div>
                            <div id="gamesList" style="margin-top: 1rem;"></div>
                        </div>

                        <!-- Gallery Panel -->
                        <div class="panel-section">
                            <div class="panel-header">
                                <label style="margin: 0;"><i class="fa-solid fa-images"></i> Galerie</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button type="button" class="btn-secondary btn-small"
                                        onclick="document.getElementById('galleryInput').click()"><i
                                            class="fa-solid fa-upload"></i> Nahr치t</button>
                                    <button type="button" class="btn-secondary btn-small"
                                        onclick="toggleGalleryUrlInput()"><i class="fa-solid fa-link"></i> URL</button>
                                </div>
                                <input type="file" id="galleryInput" accept="image/*" multiple style="display: none;"
                                    onchange="addGalleryImages(event)">
                            </div>
                            <div id="galleryUrlInput" class="hidden" style="margin-bottom: 0.75rem;">
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="text" id="galleryImageUrl" placeholder="URL obr치zku (https://...)"
                                        style="flex: 1; font-size: 0.85rem;">
                                    <button type="button" class="btn-primary btn-small"
                                        onclick="addGalleryFromUrl()">P콏idat</button>
                                </div>
                            </div>
                            <div id="galleryPreview" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
                        </div>

                        <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                            <button class="btn-primary" onclick="saveNews()"><i class="fa-solid fa-save"></i>
                                Ulo쬴t</button>
                            <button class="btn-secondary" onclick="switchTab('dashboard')">Zru코it</button>
                        </div>
                    </div>

                    <!-- Sidebar (30%) -->
                    <div class="editor-sidebar">
                        <div class="preview-card">
                            <div class="preview-title">N치hled karty</div>
                            <div class="news-preview">
                                <div class="preview-image" id="previewImage"><i class="fa-solid fa-image"
                                        style="font-size: 2rem; color: var(--text-muted);"></i></div>
                                <div class="card-content" style="padding: 1rem;">
                                    <span class="card-category" id="previewCategory">Kategorie</span>
                                    <span class="card-date" id="previewDate">Datum</span>
                                    <h3 class="card-title" id="previewTitle" style="font-size: 1rem; margin: 0.5rem 0;">
                                        Nadpis</h3>
                                    <p class="card-excerpt" id="previewExcerpt"
                                        style="font-size: 0.85rem; color: var(--text-muted);">Kr치tk칳 popis...</p>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>N치hledov칳 obr치zek *</label>
                            <div class="image-upload" id="uploadArea"
                                onclick="document.getElementById('imageInput').click()">
                                <div id="uploadPlaceholder"><i class="fa-solid fa-cloud-upload-alt"
                                        style="font-size: 1.5rem; color: var(--primary-color);"></i>
                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">Klikn캩te pro nahr치n칤</p>
                                </div>
                                <img id="uploadedImage" class="uploaded-thumb" style="display: none;">
                            </div>
                            <input type="file" id="imageInput" accept="image/*" style="display: none;"
                                onchange="handleImageUpload(event)">
                            <input type="text" id="imageUrl" placeholder="nebo URL obr치zku"
                                style="margin-top: 0.5rem; font-size: 0.85rem;" oninput="handleImageUrl()">
                        </div>

                        <div class="form-group">
                            <label>Kategorie *</label>
                            <select id="newsCategory" onchange="updatePreview()">
                                <option value="Sout캩쬰 dru쬽tev">Sout캩쬰 dru쬽tev</option>
                                <option value="Odd칤lov칳 p콏ebor">Odd칤lov칳 p콏ebor</option>
                                <option value="Ml치de">Ml치de</option>
                                <option value="O n치s">O n치s</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Datum publikace *</label>
                            <input type="date" id="newsDate" oninput="updatePreview()">
                        </div>

                        <div class="form-group">
                            <label>Kr치tk칳 popis *</label>
                            <textarea id="newsExcerpt" rows="3" placeholder="Zobraz칤 se na kart캩 novinky..."
                                oninput="updatePreview()"></textarea>
                        </div>

                        <div class="form-group">
                            <label><input type="checkbox" id="publishCheck" style="width: auto; margin-right: 0.5rem;">
                                Publikovat ihned</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- USERS -->
            <div id="usersView" class="hidden">
                <div class="editor-layout">
                    <div>
                        <h2>Seznam u쬴vatel콢</h2>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Akce</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                    <div class="editor-sidebar">
                        <h3>P콏idat u쬴vatele</h3>
                        <div class="form-group"><label>Username</label><input type="text" id="newUsername"></div>
                        <div class="form-group"><label>Email</label><input type="email" id="newEmail"></div>
                        <div class="form-group"><label>Heslo</label><input type="password" id="newPassword"></div>
                        <div class="form-group"><label>Role</label><select id="newRole">
                                <option value="admin">Admin</option>
                                <option value="superadmin">Superadmin</option>
                            </select></div>
                        <button class="btn-primary" onclick="createUser()">Vytvo콏it</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        // Admin Panel Logic - use API_URL from config.js
        let authToken = null;
        let currentUser = null;
        let uploadedImageData = null;
        let games = [];
        let teams = ['A t칳m', 'B t칳m']; // Default teams
        let selectedTeams = ['A t칳m', 'B t칳m'];
        let galleryImages = [];

        // Init
        window.addEventListener('DOMContentLoaded', () => {
            authToken = localStorage.getItem('authToken');
            if (authToken) verifyToken();
            else showLogin();
        });

        function showLogin() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
        }

        function showAdmin() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            if (currentUser.role === 'superadmin') document.getElementById('usersTab').classList.remove('hidden');
            loadDashboard();
        }

        async function verifyToken() {
            try {
                const res = await fetch(`${API_URL}/auth/me`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                if (res.ok) {
                    currentUser = await res.json();
                    document.getElementById('userInfo').textContent = `${currentUser.username} (${currentUser.role})`;
                    showAdmin();
                } else { logout(); }
            } catch (e) { logout(); }
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event?.target?.closest('.nav-tab')?.classList.add('active');
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('editorView').classList.add('hidden');
            document.getElementById('usersView').classList.add('hidden');
            document.getElementById(tab + 'View').classList.remove('hidden');
            if (tab === 'dashboard') loadDashboard();
            if (tab === 'users') loadUsers();
            if (tab === 'editor') resetEditor();
        }

        // Dashboard
        async function loadDashboard() {
            try {
                const res = await fetch(`${API_URL}/news`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                const news = await res.json();
                document.getElementById('newsTableBody').innerHTML = news.map(item => `
                    <tr>
                        <td>${new Date(item.publishedDate).toLocaleDateString('cs-CZ')}</td>
                        <td>${item.title}</td>
                        <td>${item.category}</td>
                        <td><span class="status-badge ${item.isPublished ? 'status-published' : 'status-draft'}">${item.isPublished ? 'Publikov치no' : 'Koncept'}</span></td>
                        <td>
                            <button class="action-btn btn-edit" onclick="editNews(${item.id})"><i class="fa-solid fa-pen"></i></button>
                            <button class="action-btn btn-publish" onclick="togglePublish(${item.id})" title="${item.isPublished ? 'Skr칳t' : 'Publikovat'}"><i class="fa-solid fa-${item.isPublished ? 'eye-slash' : 'eye'}"></i></button>
                            ${currentUser.role === 'superadmin' ? `<button class="action-btn btn-delete" onclick="deleteNews(${item.id})"><i class="fa-solid fa-trash"></i></button>` : ''}
                        </td>
                    </tr>
                `).join('');
            } catch (e) { console.error(e); }
        }

        async function togglePublish(id) {
            try {
                await fetch(`${API_URL}/news/${id}/publish`, { method: 'PATCH', headers: { 'Authorization': `Bearer ${authToken}` } });
                loadDashboard();
            } catch (e) { console.error(e); }
        }

        // Editor
        function resetEditor() {
            document.getElementById('editorTitle').textContent = 'Nov치 novinka';
            document.getElementById('editNewsId').value = '';
            document.getElementById('newsTitle').value = '';
            document.getElementById('articleContent').innerHTML = '';
            document.getElementById('newsExcerpt').value = '';
            document.getElementById('newsDate').valueAsDate = new Date();
            document.getElementById('publishCheck').checked = false;
            document.getElementById('imageUrl').value = '';

            uploadedImageData = null;
            games = [];
            teams = ['A t칳m', 'B t칳m'];
            selectedTeams = ['A t칳m', 'B t칳m'];
            galleryImages = [];

            document.getElementById('uploadArea').classList.remove('has-image');
            document.getElementById('uploadPlaceholder').style.display = 'block';
            document.getElementById('uploadedImage').style.display = 'none';

            renderTeamCheckboxes();
            renderGames();
            document.getElementById('galleryPreview').innerHTML = '';
            updatePreview();
        }

        async function editNews(id) {
            try {
                const res = await fetch(`${API_URL}/news/${id}`);
                const item = await res.json();

                switchTab('editor');
                document.getElementById('editorTitle').textContent = 'Upravit novinku';
                document.getElementById('editNewsId').value = item.id;
                document.getElementById('newsTitle').value = item.title;
                document.getElementById('newsCategory').value = item.category;
                document.getElementById('newsDate').value = item.publishedDate.split('T')[0];
                document.getElementById('articleContent').innerHTML = item.content || '';
                document.getElementById('newsExcerpt').value = item.excerpt;
                document.getElementById('publishCheck').checked = item.isPublished;

                if (item.thumbnailUrl) {
                    uploadedImageData = item.thumbnailUrl;
                    displayImage(item.thumbnailUrl);
                    document.getElementById('imageUrl').value = item.thumbnailUrl;
                }

                // Load games from database
                if (item.gamesJson) {
                    games = JSON.parse(item.gamesJson);
                } else {
                    games = [];
                }

                // Load teams from database
                if (item.teamsJson) {
                    const teamsData = JSON.parse(item.teamsJson);
                    teams = teamsData.all || ['A t칳m', 'B t칳m'];
                    selectedTeams = teamsData.selected || teams;
                } else {
                    teams = ['A t칳m', 'B t칳m'];
                    selectedTeams = ['A t칳m', 'B t칳m'];
                }

                // Load gallery from database
                if (item.galleryJson) {
                    galleryImages = JSON.parse(item.galleryJson);
                } else {
                    galleryImages = [];
                }

                renderTeamCheckboxes();
                renderGames();
                renderGallery();
                updatePreview();
            } catch (e) { console.error(e); }
        }

        async function saveNews() {
            const id = document.getElementById('editNewsId').value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/news/${id}` : `${API_URL}/news`;

            const data = {
                title: document.getElementById('newsTitle').value,
                category: document.getElementById('newsCategory').value,
                publishedDate: document.getElementById('newsDate').value,
                content: document.getElementById('articleContent').innerHTML,
                excerpt: document.getElementById('newsExcerpt').value,
                thumbnailUrl: uploadedImageData,
                isPublished: document.getElementById('publishCheck').checked,
                gamesJson: JSON.stringify(games),
                teamsJson: JSON.stringify({ all: teams, selected: selectedTeams }),
                galleryJson: JSON.stringify(galleryImages)
            };

            try {
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    showAlert('Ulo쬰no!', 'success');
                    switchTab('dashboard');
                } else {
                    showAlert('Chyba p콏i ukl치d치n칤', 'error');
                }
            } catch (e) { showAlert('Chyba spojen칤', 'error'); }
        }

        async function deleteNews(id) {
            if (!confirm('Opravdu smazat?')) return;
            try {
                await fetch(`${API_URL}/news/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${authToken}` } });
                loadDashboard();
            } catch (e) { console.error(e); }
        }

        // WYSIWYG
        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('articleContent').focus();
        }

        function insertHighlight(type) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0 && !selection.isCollapsed) {
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');
                span.className = type === 'name' ? 'highlight-name' : 'highlight-score';
                range.surroundContents(span);
            }
            document.getElementById('articleContent').focus();
        }

        function insertHeading() { document.execCommand('formatBlock', false, 'h3'); }
        function insertLink() { const url = prompt('Zadejte URL:'); if (url) document.execCommand('createLink', false, url); }

        // Team Checkboxes
        function renderTeamCheckboxes() {
            document.getElementById('teamCheckboxes').innerHTML = teams.map((team, i) => `
                <label class="team-checkbox ${selectedTeams.includes(team) ? 'checked' : ''}">
                    <input type="checkbox" ${selectedTeams.includes(team) ? 'checked' : ''} onchange="toggleTeam('${team}', this.checked)">
                    ${team}
                    <button type="button" onclick="removeTeam(${i}); event.stopPropagation();" style="margin-left: 0.5rem; background: none; border: none; color: #fca5a5; cursor: pointer; padding: 0;">칑</button>
                </label>
            `).join('');
        }

        function toggleTeam(team, checked) {
            if (checked) {
                if (!selectedTeams.includes(team)) selectedTeams.push(team);
            } else {
                selectedTeams = selectedTeams.filter(t => t !== team);
            }
            renderTeamCheckboxes();
        }

        function addTeam() {
            const name = document.getElementById('newTeamName').value.trim();
            if (name && !teams.includes(name)) {
                teams.push(name);
                selectedTeams.push(name);
                document.getElementById('newTeamName').value = '';
                renderTeamCheckboxes();
            }
        }

        function removeTeam(index) {
            const team = teams[index];
            teams.splice(index, 1);
            selectedTeams = selectedTeams.filter(t => t !== team);
            // Also remove games for this team
            games = games.filter(g => g.team !== team);
            renderTeamCheckboxes();
            renderGames();
        }

        // Games
        function toggleGamesInput() {
            document.getElementById('gamesInputPanel').classList.toggle('hidden');
        }

        function addGame() {
            const title = document.getElementById('gameTitle').value.trim();
            const gameId = document.getElementById('gameId').value.trim();
            const commented = document.getElementById('gameCommented').checked;

            if (!title || !gameId) return;
            if (selectedTeams.length === 0) {
                showAlert('Vyberte alespo켿 jeden t칳m', 'error');
                return;
            }

            // Add game to first selected team
            games.push({
                title,
                gameId,
                team: selectedTeams[0],
                commented,
                src: `https://www.chess.com/emboard?id=${gameId}`
            });

            renderGames();
            document.getElementById('gameTitle').value = '';
            document.getElementById('gameId').value = '';
            document.getElementById('gameCommented').checked = false;
        }

        function removeGame(index) {
            games.splice(index, 1);
            renderGames();
        }

        function changeGameTeam(index, newTeam) {
            games[index].team = newTeam;
            renderGames();
        }

        function renderGames() {
            const container = document.getElementById('gamesList');
            if (games.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 0.85rem;">콯치dn칠 partie</p>';
                return;
            }

            // Group games by team while keeping original indices
            const grouped = {};
            selectedTeams.forEach(t => grouped[t] = []);
            games.forEach((g, i) => {
                if (grouped[g.team]) grouped[g.team].push({ ...g, index: i });
            });

            container.innerHTML = selectedTeams.map(team => {
                if (grouped[team].length === 0) return '';
                return `
                    <div class="team-games-section" data-team="${team}" style="margin-bottom: 1rem;">
                        <div style="font-size: 0.85rem; color: var(--primary-color); margin-bottom: 0.5rem; font-weight: 600;">${team}</div>
                        <div class="games-list-draggable" data-team="${team}">
                            ${grouped[team].map(g => `
                                <div class="game-item" draggable="true" data-index="${g.index}" data-team="${g.team}">
                                    <span class="drag-handle"><i class="fa-solid fa-grip-vertical"></i></span>
                                    <div class="game-inputs">
                                        <input type="text" class="game-title-input" value="${escapeHtml(g.title)}" 
                                               onchange="updateGameTitle(${g.index}, this.value)" placeholder="N치zev partie">
                                        <input type="text" class="game-id-input" value="${g.gameId}" 
                                               onchange="updateGameId(${g.index}, this.value)" placeholder="ID">
                                    </div>
                                    <div class="game-actions">
                                        <label style="display: flex; align-items: center; cursor: pointer;" title="Komentovan치">
                                            <input type="checkbox" ${g.commented ? 'checked' : ''} 
                                                   onchange="toggleGameCommented(${g.index}, this.checked)" 
                                                   style="width: auto; margin: 0;">
                                            <span style="margin-left: 0.25rem; font-size: 0.8rem;">游눫</span>
                                        </label>
                                        <select onchange="changeGameTeam(${g.index}, this.value)" 
                                                style="padding: 0.2rem; font-size: 0.8rem; background: transparent; border: 1px solid var(--editor-border); color: var(--text-color); border-radius: 3px;">
                                            ${selectedTeams.map(t => `<option value="${t}" ${t === g.team ? 'selected' : ''}>${t}</option>`).join('')}
                                        </select>
                                        <button class="action-btn btn-delete" onclick="removeGame(${g.index})">
                                            <i class="fa-solid fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            // Initialize drag and drop
            initDragAndDrop();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateGameTitle(index, newTitle) {
            games[index].title = newTitle;
        }

        function updateGameId(index, newId) {
            games[index].gameId = newId;
            games[index].src = `https://www.chess.com/emboard?id=${newId}`;
        }

        // Drag and Drop
        let draggedItem = null;
        let draggedIndex = null;

        function initDragAndDrop() {
            const items = document.querySelectorAll('.game-item[draggable="true"]');

            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragleave', handleDragLeave);
                item.addEventListener('drop', handleDrop);
            });
        }

        function handleDragStart(e) {
            draggedItem = this;
            draggedIndex = parseInt(this.dataset.index);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedIndex);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.game-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedItem = null;
            draggedIndex = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            if (this !== draggedItem) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            if (this === draggedItem) return;

            const fromIndex = draggedIndex;
            const toIndex = parseInt(this.dataset.index);
            const targetTeam = this.dataset.team;

            if (fromIndex === toIndex) return;

            // Reorder the games array
            const [movedGame] = games.splice(fromIndex, 1);

            // Update team if dropped in different team section
            movedGame.team = targetTeam;

            // Calculate new position
            let newIndex = toIndex;
            if (fromIndex < toIndex) {
                newIndex = toIndex;
            }

            games.splice(newIndex, 0, movedGame);

            renderGames();
        }

        function toggleGameCommented(index, checked) {
            games[index].commented = checked;
        }

        // Gallery
        function toggleGalleryUrlInput() {
            document.getElementById('galleryUrlInput').classList.toggle('hidden');
        }

        function addGalleryFromUrl() {
            const url = document.getElementById('galleryImageUrl').value.trim();
            if (url) {
                galleryImages.push(url);
                renderGallery();
                document.getElementById('galleryImageUrl').value = '';
            }
        }

        async function addGalleryImages(event) {
            for (const file of event.target.files) {
                const formData = new FormData();
                formData.append('image', file);
                try {
                    const res = await fetch(`${API_URL}/images/upload`, { method: 'POST', headers: { 'Authorization': `Bearer ${authToken}` }, body: formData });
                    if (res.ok) {
                        const data = await res.json();
                        galleryImages.push(`http://localhost:3001${data.url}`);
                        renderGallery();
                    }
                } catch (e) { console.error(e); }
            }
        }

        function removeGalleryImage(index) { galleryImages.splice(index, 1); renderGallery(); }

        function renderGallery() {
            document.getElementById('galleryPreview').innerHTML = galleryImages.length ? galleryImages.map((img, i) => `
                <div style="position: relative;">
                    <img src="${img}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;">
                    <button onclick="removeGalleryImage(${i})" style="position: absolute; top: -5px; right: -5px; background: #dc2626; border: none; color: white; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; font-size: 10px;">칑</button>
                </div>
            `).join('') : '<p style="color: var(--text-muted); font-size: 0.85rem;">콯치dn칠 obr치zky</p>';
        }

        // Users
        async function loadUsers() {
            try {
                const res = await fetch(`${API_URL}/users`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                const users = await res.json();
                document.getElementById('usersTableBody').innerHTML = users.map(u => `
                    <tr><td>${u.username}</td><td>${u.email}</td><td>${u.role}</td><td>${u.id !== currentUser.id ? `<button class="action-btn btn-delete" onclick="deleteUser(${u.id})"><i class="fa-solid fa-trash"></i></button>` : ''}</td></tr>
                `).join('');
            } catch (e) { console.error(e); }
        }

        async function createUser() {
            try {
                const res = await fetch(`${API_URL}/users`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` }, body: JSON.stringify({ username: document.getElementById('newUsername').value, email: document.getElementById('newEmail').value, password: document.getElementById('newPassword').value, role: document.getElementById('newRole').value }) });
                if (res.ok) { showAlert('U쬴vatel vytvo콏en', 'success'); loadUsers(); document.getElementById('newUsername').value = ''; document.getElementById('newEmail').value = ''; document.getElementById('newPassword').value = ''; }
            } catch (e) { console.error(e); }
        }

        async function deleteUser(id) {
            if (!confirm('Smazat u쬴vatele?')) return;
            await fetch(`${API_URL}/users/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${authToken}` } });
            loadUsers();
        }

        // Auth
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const res = await fetch(`${API_URL}/auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: document.getElementById('username').value, password: document.getElementById('password').value }) });
                if (res.ok) { const data = await res.json(); authToken = data.token; currentUser = data.user; localStorage.setItem('authToken', authToken); showAdmin(); }
                else { document.getElementById('loginError').innerHTML = '<div class="alert alert-error">Chybn칠 칰daje</div>'; }
            } catch (e) { document.getElementById('loginError').innerHTML = '<div class="alert alert-error">Chyba spojen칤</div>'; }
        });

        function logout() { localStorage.removeItem('authToken'); location.reload(); }
        function showAlert(msg, type) { const div = document.createElement('div'); div.className = `alert alert-${type}`; div.textContent = msg; document.getElementById('alertContainer').appendChild(div); setTimeout(() => div.remove(), 3000); }

        async function handleImageUpload(event) {
            const file = event.target.files[0]; if (!file) return;
            const formData = new FormData(); formData.append('image', file);
            try { const res = await fetch(`${API_URL}/images/upload`, { method: 'POST', headers: { 'Authorization': `Bearer ${authToken}` }, body: formData }); if (res.ok) { const data = await res.json(); uploadedImageData = `http://localhost:3001${data.url}`; displayImage(uploadedImageData); } } catch (e) { console.error(e); }
        }

        function handleImageUrl() { const url = document.getElementById('imageUrl').value; if (url) { uploadedImageData = url; displayImage(url); } }
        function displayImage(src) { document.getElementById('uploadArea').classList.add('has-image'); document.getElementById('uploadPlaceholder').style.display = 'none'; const img = document.getElementById('uploadedImage'); img.src = src; img.style.display = 'block'; document.getElementById('previewImage').innerHTML = `<img src="${src}">`; }
        function updatePreview() { document.getElementById('previewTitle').textContent = document.getElementById('newsTitle').value || 'Nadpis'; document.getElementById('previewCategory').textContent = document.getElementById('newsCategory').value; document.getElementById('previewExcerpt').textContent = document.getElementById('newsExcerpt').value || 'Kr치tk칳 popis...'; const date = document.getElementById('newsDate').value; document.getElementById('previewDate').textContent = date ? new Date(date).toLocaleDateString('cs-CZ') : 'Datum'; }
    </script>
</body>

</html>