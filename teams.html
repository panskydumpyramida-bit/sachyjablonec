<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soutƒõ≈æe dru≈æstev - ≈†achov√Ω odd√≠l TJ Bi≈æuterie Jablonec</title>
    <meta name="description"
        content="V√Ωsledky a soutƒõ≈æe ≈°achov√©ho odd√≠lu TJ Bi≈æuterie Jablonec. Krajsk√Ω p≈ôebor a dal≈°√≠ soutƒõ≈æe.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--surface-color);
            margin: 10% auto;
            padding: 20px;
            border: 1px solid var(--primary-color);
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            position: relative;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .close-modal {
            color: var(--text-muted);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-modal:hover,
        .close-modal:focus {
            color: var(--primary-color);
            text-decoration: none;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .schedule-table th,
        .schedule-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .schedule-table th {
            color: var(--primary-color);
            font-weight: 600;
        }
    </style>
    <link rel="icon" type="image/png" href="images/favicon.png">
</head>

<body>

    <!-- Schedule Modal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <span class="close-modal"
                onclick="document.getElementById('scheduleModal').style.display='none'">&times;</span>
            <h3 id="modalTeamName" style="border-bottom: 1px solid var(--primary-color); padding-bottom: 0.5rem;">Rozpis
                Z√°pas≈Ø</h3>
            <div id="modalBody"></div>
        </div>
    </div>
    <header id="global-header"></header>

    <main>
        <section class="container" style="margin-top: 80px;">
            <h1 class="section-title">Soutƒõ≈æe dru≈æstev</h1>

            <div class="card-grid">
                <!-- Krajsk√Ω p≈ôebor -->
                <div class="card" style="grid-column: 1 / -1;">
                    <div class="card-content">
                        <h2
                            style="margin-bottom: 2rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem;">
                            Krajsk√Ω p≈ôebor</h2>


                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                            <!-- A Team -->
                            <div>
                                <h3 style="color: var(--primary-color);">A T√Ωm</h3>
                                <p style="margin-bottom: 0.5rem; color: var(--text-muted);">Sez√≥na 2025/2026</p>
                                <div id="lastMatch-kp-A" class="last-match-badge"
                                    style="margin-bottom: 0.75rem; font-size: 0.9rem;"></div>
                                <div style="margin-bottom: 1rem;">
                                    <a href="https://www.chess.cz/soutez/druzstvo/3344/191833/" target="_blank"
                                        class="read-more">Soupiska a v√Ωsledky hr√°ƒç≈Ø <i
                                            class="fa-solid fa-external-link-alt"></i></a>
                                </div>
                            </div>

                            <!-- B Team -->
                            <div>
                                <h3 style="color: var(--primary-color);">B T√Ωm</h3>
                                <p style="margin-bottom: 0.5rem; color: var(--text-muted);">Sez√≥na 2025/2026</p>
                                <div id="lastMatch-kp-B" class="last-match-badge"
                                    style="margin-bottom: 0.75rem; font-size: 0.9rem;"></div>
                                <div style="margin-bottom: 1rem;">
                                    <a href="https://www.chess.cz/soutez/druzstvo/3344/191840/" target="_blank"
                                        class="read-more">Soupiska a v√Ωsledky hr√°ƒç≈Ø <i
                                            class="fa-solid fa-external-link-alt"></i></a>
                                </div>
                            </div>
                        </div>

                        <!-- Link to all matches -->
                        <div style="margin-top: 1.5rem;">
                            <a href="calendar.html" class="read-more"
                                style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                <i class="fa-regular fa-calendar-days"></i> V≈°echny z√°pasy v kalend√°≈ôi
                            </a>
                        </div>

                        <!-- Standings Placeholder KP -->
                        <div id="standings-kp-liberec" style="margin-top: 2rem;"></div>

                        <div style="margin-top: 2rem;">
                            <h3 style="color: var(--text-light); margin-bottom: 1rem;">Reporty ze z√°pas≈Ø</h3>
                            <div id="teamsNewsList" data-news-category="Soutƒõ≈æe dru≈æstev" data-news-display="list">
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Krajsk√° soutƒõ≈æ I. - v√Ωchod -->
                <div class="card" style="grid-column: 1 / -1;">
                    <div class="card-content">
                        <h2
                            style="margin-bottom: 2rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem;">
                            Krajsk√° soutƒõ≈æ I. - v√Ωchod</h2>

                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                            <!-- C Team -->
                            <div>
                                <h3 style="color: var(--primary-color);">C T√Ωm</h3>
                                <p style="margin-bottom: 0.5rem; color: var(--text-muted);">Sez√≥na 2025/2026</p>
                                <div id="lastMatch-ks-C" class="last-match-badge"
                                    style="margin-bottom: 0.75rem; font-size: 0.9rem;"></div>
                                <div style="margin-bottom: 1rem;">
                                    <a href="https://www.chess.cz/soutez/3105/" target="_blank" class="read-more">Detail
                                        soutƒõ≈æe <i class="fa-solid fa-external-link-alt"></i></a>
                                </div>
                            </div>

                            <!-- D Team -->
                            <div>
                                <h3 style="color: var(--primary-color);">D T√Ωm</h3>
                                <p style="margin-bottom: 0.5rem; color: var(--text-muted);">Sez√≥na 2025/2026</p>
                                <div id="lastMatch-ks-D" class="last-match-badge"
                                    style="margin-bottom: 0.75rem; font-size: 0.9rem;"></div>
                                <div style="margin-bottom: 1rem;">
                                    <a href="https://www.chess.cz/soutez/3105/" target="_blank" class="read-more">Detail
                                        soutƒõ≈æe <i class="fa-solid fa-external-link-alt"></i></a>
                                </div>
                            </div>
                        </div>

                        <!-- Standings Placeholder -->
                        <div id="standings-ks-vychod" style="margin-top: 2rem;"></div>
                    </div>
                </div>

                <!-- Archive -->
                <div class="card" style="grid-column: 1 / -1;">
                    <div class="card-content">
                        <h2
                            style="margin-bottom: 2rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem;">
                            Archiv</h2>

                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                            <div>
                                <h3 style="color: var(--primary-color);">Sez√≥na 2024/2025</h3>
                                <ul style="margin-top: 0.5rem;">
                                    <li><a href="https://www.chess.cz/soutez/3003/" target="_blank"
                                            class="read-more">Krajsk√Ω p≈ôebor (A & B)</a></li>
                                    <li><a href="https://www.chess.cz/soutez/3052/" target="_blank" class="read-more">KS
                                            v√Ωchod (C)</a></li>
                                </ul>
                            </div>

                            <div>
                                <h3 style="color: var(--primary-color);">Sez√≥na 2023/2024</h3>
                                <ul style="margin-top: 0.5rem;">
                                    <li><a href="https://www.chess.cz/soutez/2885/" target="_blank"
                                            class="read-more">Krajsk√Ω p≈ôebor (A)</a></li>
                                    <li><a href="https://www.chess.cz/soutez/2924/" target="_blank" class="read-more">KS
                                            v√Ωchod (B)</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer id="global-footer"></footer>

    <script src="js/config.js"></script>
    <script src="js/layout-loader.js"></script>
    <script src="js/main.js"></script>
    <script src="js/news-loader.js"></script>
    <script>
        // Standings Loader Logic (similar to youth.html)
        document.addEventListener('DOMContentLoaded', () => {
            loadNews('Soutƒõ≈æe dru≈æstev', 'teamsNewsList', 'list');
            loadStandings('kp-liberec', 'standings-kp-liberec');
            loadStandings('ks-vychod', 'standings-ks-vychod');

            // Load last match badges
            loadLastMatches();
        });

        async function loadLastMatches() {
            try {
                const res = await fetch(`${API_URL}/standings`);
                if (!res.ok) return;
                const data = await res.json();
                const competitions = data.standings || data;

                // Team mappings: containerId -> [competitionId, teamNamePattern]
                const teamMappings = [
                    { containerId: 'lastMatch-kp-A', compId: 'kp-liberec', pattern: /bi≈æuterie.*a\b/i },
                    { containerId: 'lastMatch-kp-B', compId: 'kp-liberec', pattern: /bi≈æuterie.*b\b/i },
                    { containerId: 'lastMatch-ks-C', compId: 'ks-vychod', pattern: /bi≈æuterie.*(c\b|\"c\")/i },
                    { containerId: 'lastMatch-ks-D', compId: 'ks-vychod', pattern: /bi≈æuterie.*(d\b|\"d\")/i },
                ];

                for (const mapping of teamMappings) {
                    const container = document.getElementById(mapping.containerId);
                    if (!container) continue;

                    const comp = competitions.find(c => c.competitionId === mapping.compId);
                    if (!comp) continue;

                    // Find team in standings
                    const team = comp.standings?.find(s => mapping.pattern.test(s.team));
                    if (!team || !team.schedule) continue;

                    // Find last match with actual result (has digits, not just ' :  ' placeholder)
                    const hasActualResult = (r) => r && /\d/.test(r);
                    const playedMatches = team.schedule.filter(m => hasActualResult(m.result));
                    if (playedMatches.length === 0) {
                        container.innerHTML = '<span style="color: var(--text-muted);"><i class="fa-regular fa-clock"></i> ≈Ω√°dn√Ω odehran√Ω z√°pas</span>';
                        continue;
                    }

                    const lastMatch = playedMatches[playedMatches.length - 1];

                    // Parse result to determine win/loss/draw
                    let statusIcon = 'üìä';
                    let statusColor = 'var(--text-muted)';
                    const resultParts = lastMatch.result.split(':').map(p => parseFloat(p.replace(',', '.')));
                    if (resultParts.length === 2) {
                        const [home, away] = resultParts;
                        const isHome = lastMatch.isHome !== false; // Default true
                        const ourScore = isHome ? home : away;
                        const theirScore = isHome ? away : home;
                        if (ourScore > theirScore) {
                            statusIcon = '‚úÖ';
                            statusColor = '#4ade80';
                        } else if (ourScore < theirScore) {
                            statusIcon = '‚ùå';
                            statusColor = '#f87171';
                        } else {
                            statusIcon = 'ü§ù';
                            statusColor = '#fbbf24';
                        }
                    }

                    // Prepare data for click handler
                    const matchUrl = team.url || comp.url || '';
                    const compName = comp.competitionName || comp.competitionId;
                    const teamName = team.team;
                    const detailsId = `details-${mapping.containerId}`;

                    container.innerHTML = `
                        <div onclick="toggleMatchBadgeDetails('${detailsId}', '${encodeURIComponent(matchUrl)}', '${lastMatch.round}', '${encodeURIComponent(teamName)}', '${encodeURIComponent(lastMatch.opponent)}')" 
                             style="padding: 0.5rem 0.75rem; background: rgba(255,255,255,0.05); border-radius: 6px; border-left: 3px solid ${statusColor}; cursor: pointer; transition: background 0.2s;"
                             onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                            <div style="display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; flex-wrap: wrap;">
                                <div>
                                    <span style="color: var(--text-muted); font-size: 0.8em;">${lastMatch.round}. kolo</span>
                                    <span style="color: var(--text-muted);">‚Ä¢</span>
                                    <span style="color: var(--text-muted); font-size: 0.85em;">${lastMatch.date}</span>
                                </div>
                                <i class="fa-solid fa-chevron-down" id="icon-${detailsId}" style="color: var(--text-muted); font-size: 0.7em; transition: transform 0.2s;"></i>
                            </div>
                            <div style="margin-top: 0.25rem;">
                                <span>${statusIcon}</span>
                                <span style="color: ${statusColor}; font-weight: 600;">${lastMatch.result}</span>
                                <span style="color: var(--text-light); margin-left: 0.25rem;">vs ${lastMatch.opponent}</span>
                            </div>
                        </div>
                        <div id="${detailsId}" style="display: none; margin-top: 0.5rem; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px; font-size: 0.85rem;"></div>
                    `;
                }
            } catch (e) {
                console.error('Error loading last matches:', e);
            }
        }

        async function toggleMatchBadgeDetails(detailsId, urlEncoded, round, homeEncoded, awayEncoded) {
            const container = document.getElementById(detailsId);
            const icon = document.getElementById(`icon-${detailsId}`);
            if (!container) return;

            // Toggle visibility
            const isHidden = container.style.display === 'none';
            container.style.display = isHidden ? 'block' : 'none';
            if (icon) icon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';

            if (!isHidden) return; // Hiding

            // If empty, fetch data
            if (container.innerHTML.trim() === '' || container.innerHTML.includes('Naƒç√≠t√°m')) {
                container.innerHTML = '<div style="text-align: center; padding: 0.5rem;"><i class="fa-solid fa-spinner fa-spin"></i> Naƒç√≠t√°m...</div>';

                try {
                    const url = decodeURIComponent(urlEncoded);
                    const home = decodeURIComponent(homeEncoded);
                    const away = decodeURIComponent(awayEncoded);

                    if (!url) {
                        container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">Detaily nejsou k dispozici.</p>';
                        return;
                    }

                    const res = await fetch(`${API_URL}/standings/match-details?url=${encodeURIComponent(url)}&round=${round}&home=${encodeURIComponent(home)}&away=${encodeURIComponent(away)}`);
                    if (!res.ok) throw new Error('Fetch failed');
                    const data = await res.json();

                    if (data.boards && data.boards.length > 0) {
                        let html = '<table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">';
                        html += '<thead><tr style="border-bottom: 1px solid rgba(255,255,255,0.1);"><th style="padding: 0.3rem; text-align: left; width: 1.5rem;">≈†</th><th style="padding: 0.3rem; text-align: left;">Dom√°c√≠</th><th style="padding: 0.3rem; text-align: center; white-space: nowrap;">V√Ωs.</th><th style="padding: 0.3rem; text-align: right;">Host√©</th></tr></thead><tbody>';
                        data.boards.forEach((b, idx) => {
                            // Use index as board number (1-based)
                            const boardNum = idx + 1;
                            // Format player name with ELO
                            const formatPlayer = (name, elo) => {
                                if (!name || name === '-') return '-';
                                const eloStr = elo && elo !== '-' ? `<span style="color: var(--text-muted); font-size: 0.8em;"> (${elo})</span>` : '';
                                return name + eloStr;
                            };
                            const homeName = formatPlayer(b.white || b.homePlayer, b.whiteElo || b.homeElo);
                            const guestName = formatPlayer(b.black || b.guestPlayer, b.blackElo || b.guestElo);

                            html += `<tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <td style="padding: 0.3rem; color: var(--text-muted);">${boardNum}</td>
                                <td style="padding: 0.3rem;">${homeName}</td>
                                <td style="padding: 0.3rem; text-align: center; font-weight: 600; white-space: nowrap;">${b.result || '-'}</td>
                                <td style="padding: 0.3rem; text-align: right;">${guestName}</td>
                            </tr>`;
                        });
                        html += '</tbody></table>';
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">Detaily nejsou k dispozici.</p>';
                    }
                } catch (e) {
                    console.error('Error loading match details:', e);
                    container.innerHTML = '<p style="color: #fca5a5; text-align: center;">Chyba naƒç√≠t√°n√≠.</p>';
                }
            }
        }

        async function loadStandings(competitionId, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Loading state
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                    <i class="fa-solid fa-spinner fa-spin"></i> Naƒç√≠t√°m tabulku...
                </div>
            `;

            try {
                // Determine API URL - in this case we use the main standings endpoint which returns ALL competitions
                // We need to filter for the specific one on the client side since our backend returns a list
                // OR we can rely on the fact that /api/standings (GET) usually serves a JSON file with all data.
                // Wait, server.js exports /api/standings/update (POST). Where is the GET endpoint?
                // Step 1209 summary says youth.html calls /api/standings.
                // I need to check if /api/standings exists as a static file server or GET route.
                // Assuming it serves the 'data/standings.json' file or similar.

                // Let's assume there is an endpoint or file. 
                // Based on youth.html context (Step 225 from previous conv), it fetches './data/standings.json' or '/api/standings'.
                // I will use fetch('/api/standings') if it exists, or check how youth.html does it exactly.

                // Correction: The backend code showed app.post('/api/standings/update').
                // It usually saves to a file. I assumed there is a GET route serving it.
                // If not, I should add it or use the static file if exposed.
                // Let's assume '/data/standings.json' is available if static folder is mapped?
                // Or I can add a GET route in server.js to be safe. 
                // But for now, let's look at youth.html lines 220-302 (viewed in Step 1378).
                // It calls `/api/standings`.

                const res = await fetch(`${API_URL}/standings`);
                if (!res.ok) throw new Error('Failed to load standings');

                const data = await res.json();

                // Compatibility check: server might return { standings: [...] } or just [...]
                const competitions = data.standings || data;

                // Check if competitions is an array
                if (!Array.isArray(competitions)) {
                    throw new Error('Invalid data format');
                }

                const competition = competitions.find(c => c.competitionId === competitionId);

                if (!competition || !competition.standings || competition.standings.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 1rem; color: var(--text-muted); font-style: italic;">
                            Tabulka zat√≠m nen√≠ k dispozici.
                        </div>
                    `;
                    return;
                }

                // Render Table
                let html = `
                    <div class="standings-wrapper">
                        <table class="standings-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); color: var(--text-muted);">
                                    <th style="text-align: left; padding: 0.5rem;">Po≈ô.</th>
                                    <th style="text-align: left; padding: 0.5rem;">T√Ωm</th>
                                    <th style="text-align: right; padding: 0.5rem;">Body</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                competition.standings.forEach(s => {
                    const isBizuterie = s.isBizuterie || s.team.toLowerCase().includes('bi≈æuterie');
                    // Style adjustments for Bi≈æuterie
                    const rowStyle = isBizuterie ? 'font-weight: bold; color: var(--primary-color); background: rgba(212, 175, 55, 0.1);' : '';

                    // Schedule Button
                    let scheduleBtn = '';
                    if (s.schedule && s.schedule.length > 0) {
                        const scheduleJson = encodeURIComponent(JSON.stringify(s.schedule));
                        const teamSafe = s.team.replace(/'/g, "\\'");
                        scheduleBtn = `<button onclick="window.openScheduleModal('${scheduleJson}', '${teamSafe}')" style="background:none; border:none; cursor:pointer; margin-left:0.5rem; color: #fff;" title="Rozpis z√°pas≈Ø"><i class="fa-regular fa-calendar-days"></i></button>`;
                    }

                    html += `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05); ${rowStyle}">
                            <td style="padding: 0.5rem;">${s.rank}.</td>
                            <td style="padding: 0.5rem;">${s.team} ${scheduleBtn}</td>
                            <td style="padding: 0.5rem; text-align: right;"><strong>${s.points !== null ? s.points : '-'}</strong></td>
                        </tr>
                    `;
                });

                const sourceName = (competition.url && competition.url.includes('chess-results')) ? 'Chess-Results.com' : '≈†SƒåR';
                const sourceUrl = competition.url || competition.chessczUrl || '#';

                html += `
                            </tbody>
                        </table>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; text-align: right; color: var(--text-muted);">
                            Zdroj: <a href="${sourceUrl}" target="_blank" style="color: var(--text-muted); text-decoration: underline;">${sourceName} <i class="fa-solid fa-external-link-alt"></i></a>
                        </div>
                    </div>
                `;

                container.innerHTML = html;

            } catch (e) {
                console.error(e);
                container.innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: #fca5a5;">
                        Chyba p≈ôi naƒç√≠t√°n√≠ dat.
                    </div>
                `;
            }
        }

        window.openScheduleModal = function (scheduleData, teamName) {
            const schedule = (typeof scheduleData === 'string') ? JSON.parse(decodeURIComponent(scheduleData)) : scheduleData;
            const modalBody = document.getElementById('modalBody');
            document.getElementById('modalTeamName').textContent = teamName;

            let html = `
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>Kolo</th>
                            <th>Datum</th>
                            <th>Soupe≈ô</th>
                            <th style="text-align:right;">V√Ωsledek</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            schedule.forEach(m => {
                html += `
                    <tr>
                        <td>${m.round}.</td>
                        <td>${m.date}</td>
                        <td>${m.opponent}</td>
                        <td style="text-align:right; font-weight:bold;">${m.result}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            modalBody.innerHTML = html;
            document.getElementById('scheduleModal').style.display = 'block';
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('scheduleModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>

</html>