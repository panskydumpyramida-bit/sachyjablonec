<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Článek - Šachový oddíl TJ Bižuterie Jablonec</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/auth.css?v=7">
    <link rel="stylesheet" href="css/comments.css">
    <link rel="stylesheet" href="css/game-viewer2.css?v=10">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"
        integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">
    <style>
        .article-header {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .article-meta {
            display: flex;
            gap: 1rem;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .article-content img {
            max-width: 100%;
            height: auto;
            border-radius: var(--border-radius);
            margin: 1rem 0;
        }

        /* Fix: Reset margins on chess piece images to prevent vertical stretching */
        .article-content .diagram-book img,
        .article-content .book-board-container img,
        .article-content .mini-board-wrapper img,
        .article-content .diagram-viewer-container img,
        .article-content .board-b72b1 img,
        .article-content td img {
            margin: 0 !important;
            padding: 0 !important;
            border-radius: 0 !important;
            display: block !important;
        }

        /* Split-view responsive for game viewer */
        /* Article-specific game list styling */
        #article-games-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
            min-height: 0;
        }
    </style>
    <link rel="icon" type="image/png" href="images/favicon.png">
</head>

<body>
    <header id="global-header"></header>

    <main>
        <section class="container" style="margin-top: 80px;">
            <div id="loading" style="text-align: center; padding: 4rem;">
                <div
                    style="display: inline-block; width: 40px; height: 40px; border: 4px solid rgba(212, 175, 55, 0.2); border-radius: 50%; border-top-color: var(--primary-color); animation: spin 1s linear infinite;">
                </div>
                <p style="margin-top: 1rem; color: var(--text-muted);">Načítání článku...</p>
            </div>

            <article id="article" class="hidden">
                <!-- Compact Header Row: Nav + Meta -->
                <div
                    style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); font-size: 0.9rem;">
                    <!-- Navigation -->
                    <div style="display: flex; gap: 1.5rem;">
                        <a id="prevArticleLink" href=""
                            style="display: none; align-items: center; gap: 0.5rem; color: var(--text-muted);">
                            <i class="fa-solid fa-arrow-left"></i> <span id="prevArticleTitle">Předchozí</span>
                        </a>
                        <a id="nextArticleLink" href=""
                            style="display: none; align-items: center; gap: 0.5rem; color: var(--text-muted);">
                            <span id="nextArticleTitle">Další</span> <i class="fa-solid fa-arrow-right"></i>
                        </a>
                    </div>
                    <!-- Meta -->
                    <div style="display: flex; gap: 1.5rem; color: var(--text-muted);">
                        <span id="articleDate"><i class="fa-regular fa-calendar"></i> </span>
                        <span id="articleCategory"><i class="fa-solid fa-tag"></i> </span>
                    </div>
                </div>

                <h1 id="articleTitle" style="font-size: 2.25rem; margin-bottom: 1.5rem;"></h1>

                <div class="article-content" id="articleBody"></div>



                <!-- Game Viewer Section - Created by GameViewer2.create() -->
                <div id="game-viewer-section" class="hidden"
                    style="margin-top: 3rem; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;">
                    <!-- GameViewer2.create() will inject the entire structure here -->
                </div>



                <!-- Gallery Section -->
                <div id="gallerySection" class="hidden" style="margin-top: 3rem;">
                    <h2 style="color: var(--primary-color); margin-bottom: 1.5rem;"><i class="fa-solid fa-images"></i>
                        Fotogalerie</h2>
                    <div id="galleryGrid" class="article-gallery"></div>
                </div>

                <!-- Comments Section -->
                <div id="comments-section" data-news-id=""></div>
            </article>

            <div id="error" class="hidden" style="text-align: center; padding: 4rem;">
                <i class="fa-solid fa-exclamation-triangle" style="font-size: 3rem; color: #fca5a5;"></i>
                <p style="margin-top: 1rem; color: var(--text-muted);">Článek nebyl nalezen.</p>
                <a href="/" class="btn-primary" style="margin-top: 1rem; display: inline-block;">Zpět na
                    úvod</a>
            </div>
        </section>
    </main>

    <footer id="global-footer"></footer>

    <script src="js/config.js?v=4"></script>
    <script src="js/layout-loader.js?v=5"></script>
    <script src="js/main.js?v=2" defer></script>
    <script src="js/lightbox.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="js/game-viewer2.js?v=12"></script>
    <script src="js/diagram-viewer.js?v=5"></script>
    <script src="js/diagram-book.js?v=8"></script>
    <script>
        // Article Loader
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');

            if (!id) {
                showError();
                return;
            }

            try {
                const res = await fetch(`${API_URL}/news/${id}`);
                if (!res.ok) throw new Error('Not found');

                const article = await res.json();
                renderArticle(article);
            } catch (e) {
                console.error(e);
                showError();
            }
        });

        async function renderArticle(article) {
            document.title = `${article.title} - Šachový oddíl TJ Bižuterie Jablonec`;

            // Navigation Links
            const prevLink = document.getElementById('prevArticleLink');
            const nextLink = document.getElementById('nextArticleLink');

            // Truncate title for mobile nav
            const truncateTitle = (title, maxLen = 20) =>
                title.length > maxLen ? title.slice(0, maxLen) + '...' : title;

            if (article.prevArticle) {
                prevLink.href = `article.html?id=${article.prevArticle.id}`;
                document.getElementById('prevArticleTitle').textContent = truncateTitle(article.prevArticle.title);
                prevLink.style.display = 'flex';
                prevLink.title = article.prevArticle.title;
            } else {
                prevLink.style.display = 'none';
            }

            if (article.nextArticle) {
                nextLink.href = `article.html?id=${article.nextArticle.id}`;
                document.getElementById('nextArticleTitle').textContent = truncateTitle(article.nextArticle.title);
                nextLink.style.display = 'flex';
                nextLink.title = article.nextArticle.title;
            } else {
                nextLink.style.display = 'none';
            }

            // Article Content
            document.getElementById('articleTitle').textContent = article.title;
            document.getElementById('articleDate').innerHTML = `<i class="fa-regular fa-calendar"></i> ${new Date(article.publishedDate).toLocaleDateString('cs-CZ')}`;
            document.getElementById('articleCategory').innerHTML = `<i class="fa-solid fa-tag"></i> ${article.category}`;

            // Add Author and View Count
            const authorMeta = document.createElement('span');
            authorMeta.style.display = 'flex';
            authorMeta.style.alignItems = 'center';
            authorMeta.style.gap = '0.5rem';

            let authorName = article.authorName; // Custom name first
            if (!authorName && article.author) {
                authorName = (article.author.useRealName && article.author.realName) ? article.author.realName : (article.author.username || 'Admin');
            }

            if (article.coAuthorName || article.coAuthor) {
                let coAuthorName = article.coAuthorName;
                if (!coAuthorName && article.coAuthor) {
                    coAuthorName = (article.coAuthor.useRealName && article.coAuthor.realName) ? article.coAuthor.realName : (article.coAuthor.username);
                }
                if (coAuthorName) authorName += ` a ${coAuthorName}`;
            }

            if (authorName) {
                authorMeta.innerHTML = `<i class="fa-solid fa-user-pen"></i> ${authorName}`;
                // Insert after category
                document.getElementById('articleCategory').parentNode.appendChild(authorMeta);
            }

            // View Count
            if (article.viewCount !== undefined) {
                const viewMeta = document.createElement('span');
                viewMeta.style.display = 'flex';
                viewMeta.style.alignItems = 'center';
                viewMeta.style.gap = '0.5rem';
                viewMeta.title = 'Počet zobrazení';
                viewMeta.innerHTML = `<i class="fa-regular fa-eye"></i> ${article.viewCount}`;
                document.getElementById('articleCategory').parentNode.appendChild(viewMeta);
            }

            document.getElementById('articleBody').innerHTML = article.content || '';

            // Initialize diagram books after content is loaded (they load async after DOMContentLoaded)
            // Use requestAnimationFrame to ensure browser has completed reflow before chessboard.js calculates dimensions
            if (typeof window.initDiagramBooks === 'function') {
                requestAnimationFrame(() => {
                    window.initDiagramBooks();
                });
            }

            // Increment view count
            try {
                fetch(`${API_URL}/news/${article.id}/view`, { method: 'POST' }).catch(e => console.error('Failed to increment view', e));
            } catch (e) { }

            // Set newsId for comments section
            document.getElementById('comments-section').dataset.newsId = article.id;

            // Initialize comments (after newsId is set)
            if (typeof CommentsManager !== 'undefined') {
                commentsManager = new CommentsManager(article.id);
            }

            // Handle Games
            if (article.gamesJson && article.gamesJson !== '[]' && article.gamesJson !== 'null') {
                try {
                    console.log('Raw gamesJson:', article.gamesJson);
                    let games = JSON.parse(article.gamesJson);
                    console.log('Parsed games type:', typeof games);

                    // Handle double-encoded JSON if necessary
                    if (typeof games === 'string') {
                        console.warn('Double encoded JSON detected, parsing again...');
                        games = JSON.parse(games);
                    }

                    if (games && games.length > 0) {
                        // Format games for GameViewer2
                        const formattedGames = games.map((g, index) => {
                            const pgnHeaders = parsePgnHeaders(g.pgn);
                            const white = g.white || g.whitePlayer || pgnHeaders.White || 'Bílý';
                            const black = g.black || g.blackPlayer || pgnHeaders.Black || 'Černý';

                            return {
                                id: g.id || index,
                                white: white,
                                black: black,
                                result: g.result || pgnHeaders.Result || '*',
                                pgn: g.pgn,
                                date: g.date || pgnHeaders.Date || '',
                                event: g.event || g.tournament || pgnHeaders.Event || '',
                                round: g.round || pgnHeaders.Round || '',
                                title: g.title || `${white} - ${black}`,
                                chessComId: g.chessComId || g.gameId
                            };
                        });

                        // Use the self-contained plugin - creates everything!
                        GameViewer2.create('#game-viewer-section', formattedGames, {
                            title: 'Partie z článku',
                            maxHeight: 600
                        });
                    }
                } catch (e) {
                    console.error('Error initializing games:', e);
                    console.log('No games data');
                }
            }

            // Parse PGN headers for player names and other metadata
            function parsePgnHeaders(pgn) {
                if (!pgn) return {};
                const headers = {};
                const regex = /\[(\w+)\s+"([^"]+)"\]/g;
                let match;
                while ((match = regex.exec(pgn)) !== null) {
                    headers[match[1]] = match[2];
                }
                return headers;
            }

            function escapeHtml(s) {
                if (!s) return '?';
                const d = document.createElement('div');
                d.textContent = s;
                return d.innerHTML;
            }

            // Handle Gallery
            if (article.id == 54) {
                try {
                    const safarikRes = await fetch('images/blicak/2024-safarik/gallery.json');
                    if (safarikRes.ok) {
                        const safarikImages = await safarikRes.json();
                        const mapped = safarikImages.map(url => ({
                            url: url,
                            caption: 'Foto: David Šafařík'
                        }));

                        let existing = [];
                        if (article.galleryJson) {
                            try { existing = JSON.parse(article.galleryJson); } catch (e) { }
                        }

                        const combined = existing.concat(mapped);
                        renderGallery(combined);
                    } else if (article.galleryJson) {
                        const images = JSON.parse(article.galleryJson);
                        if (images.length > 0) renderGallery(images);
                    }
                } catch (e) {
                    console.warn('Extra gallery load failed', e);
                    if (article.galleryJson) {
                        const images = JSON.parse(article.galleryJson);
                        if (images.length > 0) renderGallery(images);
                    }
                }
            } else if (article.galleryJson) {
                const images = JSON.parse(article.galleryJson);
                if (images.length > 0) {
                    renderGallery(images);
                }
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('article').classList.remove('hidden');
            document.getElementById('error').classList.add('hidden');
        }


        // Generic Toggle for Reports (or any section)
        window.toggleSection = function (id, iconId) {
            const content = document.getElementById(id);
            const icon = document.getElementById(iconId);

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                if (icon) {
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                }
            } else {
                content.classList.add('hidden');
                if (icon) {
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                }
            }
        }

        let articleGalleryImages = [];
        let currentGalleryPage = 1;
        const galleryItemsPerPage = 12;

        function renderGallery(images) {
            const container = document.getElementById('gallerySection');
            if (!images || images.length === 0) {
                container.classList.add('hidden');
                return;
            }

            articleGalleryImages = images;
            container.classList.remove('hidden');

            // Initial Render
            renderGalleryPage(1);

            // Pagination
            const grid = document.getElementById('galleryGrid');
            // Remove old pagination if exists
            const oldPag = document.getElementById('articleGalleryPagination');
            if (oldPag) oldPag.remove();

            if (images.length > galleryItemsPerPage) {
                const pag = document.createElement('div');
                pag.id = 'articleGalleryPagination';
                pag.style.cssText = 'display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1.5rem;';
                grid.parentNode.appendChild(pag); // Append after grid
                updateGalleryPagination();
            }
        }

        function renderGalleryPage(page) {
            currentGalleryPage = page;
            const start = (page - 1) * galleryItemsPerPage;
            const end = start + galleryItemsPerPage;
            const pageItems = articleGalleryImages.slice(start, end);

            document.getElementById('galleryGrid').innerHTML = pageItems.map((img, indexInPage) => {
                const globalIndex = start + indexInPage;
                const url = typeof img === 'string' ? img : img.url;
                const caption = typeof img === 'string' ? '' : (img.caption || '');

                return `
                <div class="gallery-item" onclick="SJLightbox.open(articleGalleryImages, ${globalIndex})" title="${caption}">
                    <img src="${url}" alt="${caption}" loading="lazy">
                    ${caption ? `<div class="gallery-caption-overlay">${caption}</div>` : ''}
                </div>
            `}).join('');
        }

        function updateGalleryPagination() {
            const pag = document.getElementById('articleGalleryPagination');
            if (!pag) return;
            const totalPages = Math.ceil(articleGalleryImages.length / galleryItemsPerPage);

            pag.innerHTML = `
                <button onclick="changeGalleryPage(${currentGalleryPage - 1})" 
                    style="background: ${currentGalleryPage === 1 ? 'rgba(255,255,255,0.05)' : 'var(--primary-color)'}; color: ${currentGalleryPage === 1 ? '#555' : '#000'}; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: ${currentGalleryPage === 1 ? 'default' : 'pointer'};">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
                <span style="display:flex;align-items:center;color:var(--text-muted); font-variant-numeric: tabular-nums;">
                    ${currentGalleryPage} / ${totalPages}
                </span>
                <button onclick="changeGalleryPage(${currentGalleryPage + 1})" 
                    style="background: ${currentGalleryPage === totalPages ? 'rgba(255,255,255,0.05)' : 'var(--primary-color)'}; color: ${currentGalleryPage === totalPages ? '#555' : '#000'}; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: ${currentGalleryPage === totalPages ? 'default' : 'pointer'};">
                    <i class="fa-solid fa-chevron-right"></i>
                </button>
             `;
        }

        window.changeGalleryPage = function (newPage) {
            const totalPages = Math.ceil(articleGalleryImages.length / galleryItemsPerPage);
            if (newPage < 1 || newPage > totalPages) return;
            renderGalleryPage(newPage);
            updateGalleryPagination();
            document.getElementById('gallerySection').scrollIntoView({ behavior: 'smooth' });
        }

        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('article').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
        }

        // Add spinner animation style
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin { to { transform: rotate(360deg); } }
        `;
        document.head.appendChild(style);

        // Keyboard navigation for games (Arrow Up/Down only - Left/Right is for moves)
        document.addEventListener('keydown', function (e) {
            // Only if we have games loaded
            if (!window.articleGames || window.articleGames.length === 0) return;

            // Don't interfere with input fields
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            const currentIndex = window.articleSelectedGame || 0;
            const totalGames = window.articleGames.length;

            // Only Up/Down for game switching (Left/Right handled by GameViewer2 for moves)
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                const newIndex = currentIndex > 0 ? currentIndex - 1 : totalGames - 1;
                selectArticleGame(newIndex);
                scrollToActiveGame();
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                const newIndex = currentIndex < totalGames - 1 ? currentIndex + 1 : 0;
                selectArticleGame(newIndex);
                scrollToActiveGame();
            }
        });

        // Scroll to make active game visible in the list
        function scrollToActiveGame() {
            // Small delay to wait for DOM update
            setTimeout(() => {
                const listEl = document.getElementById('article-games-list');
                const currentIndex = window.articleSelectedGame || 0;
                const activeCard = listEl?.querySelector(`[data-game-index="${currentIndex}"]`);
                if (activeCard && listEl) {
                    activeCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }, 50);
        }
    </script>

    <script src="js/comments.js" defer></script>
</body>

</html>